<!DOCTYPE html>
<html lang="zh">
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">


  <title>一文搞懂容器运行时 Containerd-阳明的博客|Kubernetes|Istio|Prometheus|Python|Golang|云原生</title>
  <meta property="og:title" content="一文搞懂容器运行时 Containerd" />
  <meta name="twitter:title" content="一文搞懂容器运行时 Containerd" />

  <meta name="description" content="在学习 Containerd 之前我们有必要对 Docker 的发展历史做一个简单的回顾，因为这里面牵涉到的组件实战是有点多，有很多我们会经常听到，但是不清楚这些组件到底是干什么用的，比如 libcontainer、runc、containerd、CRI、OCI 等等。">
  <meta property="og:description" content="在学习 Containerd 之前我们有必要对 Docker 的发展历史做一个简单的回顾，因为这里面牵涉到的组件实战是有点多，有很多我们会经常听到，但是不清楚这些组件到底是干什么用的，比如 libcontainer、runc、containerd、CRI、OCI 等等。">
  <meta name="twitter:description" content="在学习 Containerd 之前我们有必要对 Docker 的发展历史做一个简单的回顾，因为这里面牵涉到的组件实战是有点多，有很多我们会经常听到，但是不清楚这些组件到底是干什么用的，比如 libcontainer、runc、containerd、CRI、OCI 等等。">
  <meta name="author" content=""/>
  <link href="https://picdn.youdianzhishi.com/images/blog-favicon.png" rel="icon" type="image/x-icon" />
  <link rel="apple-touch-icon" href="https://picdn.youdianzhishi.com/images/blog-favicon.png"/>
  <meta property="og:image" content="https://picdn.youdianzhishi.com/images/blog-favicon.png" />
  <meta name="twitter:image" content="https://picdn.youdianzhishi.com/images/blog-favicon.png" />
  <meta name="twitter:card" content="summary" />
  <meta property="og:url" content="https://www.qikqiak.com/post/containerd-usage/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="阳明的博客" />

  <link rel="canonical" href="https://www.qikqiak.com/post/containerd-usage/" />
  <link rel="alternate" href="https://www.qikqiak.com/index.xml" type="application/rss+xml" title="阳明的博客">

  
  
  <link href="https://fonts.googleapis.com/css?family=Lora:400,400i,700%7COpen+Sans:400,700" rel="stylesheet">
  

  <link rel="stylesheet" href='https://www.qikqiak.com/css/bundle.min.a6b62363fe57848ad01efa2a5d1bbb1047c2ffb71b53d8aeb42bc5ed5c77ea7c.css' integrity='sha256-prYjY/5XhIrQHvoqXRu7EEfC/7cbU9iutCvF7Vx36nw='>

  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css"/>
  
  
    
    <!--[if lt IE 9]>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js"></script>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <![endif]-->
<meta name="google-site-verification" content="oKxX4fOvB2yYmU02txZFChM93XQbESU4JaG3tNH9Hm8" />
<meta name="baidu-site-verification" content="F5ojAyqaKU" />
<meta name="keywords" content="kubernetes, docker, containerd, 容器运行时, OCI, CRI, runc">
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d611849735f187dd788dc054908f7d7a";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-69668147-3', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>

  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">切换导航</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://www.qikqiak.com/" title="阳明的博客">
        <img src="https://picdn.youdianzhishi.com/images/blog-logo-new.png" style="margin-top: -5px;height: 32px;" alt="阳明的博客">
      </a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="首页" href="https://www.qikqiak.com/">首页</a>
            </li>
          
        
          
            <li>
              <a title="课程" href="https://youdianzhishi.com/?utm_source=blog&amp;utm_campaign=referral&amp;utm_medium=topmenu">课程</a>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">文章分类</a>
              <div class="navlinks-children">
                
                  <a href="https://www.qikqiak.com/archives">Archive</a>
                
                  <a href="https://www.qikqiak.com/tags">tags</a>
                
                  <a href="https://www.qikqiak.com/tags/kubernetes">kubernetes</a>
                
                  <a href="https://www.qikqiak.com/tags/python">python</a>
                
                  <a href="https://www.qikqiak.com/tags/django">django</a>
                
                  <a href="https://www.qikqiak.com/tags/devops">devops</a>
                
              </div>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">书籍</a>
              <div class="navlinks-children">
                
                  <a href="https://www.qikqiak.com/k8s-book/">k8s进阶手册</a>
                
                  <a href="https://www.qikqiak.com/istio-book/">一起学istio</a>
                
                  <a href="https://www.qikqiak.com/tdd-book/">Python微服务</a>
                
                  <a href="https://md.qikqiak.com/">Markdown微信</a>
                
              </div>
            </li>
          
        
          
            <li>
              <a title="关于" href="https://www.qikqiak.com/page/about/">关于</a>
            </li>
          
        
          
            <li>
              <a title="RSS" href="https://www.qikqiak.com/index.xml">RSS</a>
            </li>
          
        

        

        

        
          <li>
            <a href="#modalSearch" data-toggle="modal" data-target="#modalSearch" style="outline: none;">
              <span id="searchGlyph" class="glyphicon glyphicon-search"></span>
            </a>
          </li>
          

      </ul>
    </div>

  </div>
</nav>


  <div id="modalSearch" class="modal fade" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">搜索</h4>
        </div>
        <div class="modal-body">
            
<div class="aa-input-container" id="aa-input-container">
    <input type="search" id="aa-search-input" class="aa-input-search" placeholder="Search for titles or URIs..." name="search" autocomplete="off" />
    <svg class="aa-input-icon" viewBox="654 -372 1664 1664">
        <path d="M1806,332c0-123.3-43.8-228.8-131.5-316.5C1586.8-72.2,1481.3-116,1358-116s-228.8,43.8-316.5,131.5  C953.8,103.2,910,208.7,910,332s43.8,228.8,131.5,316.5C1129.2,736.2,1234.7,780,1358,780s228.8-43.8,316.5-131.5  C1762.2,560.8,1806,455.3,1806,332z M2318,1164c0,34.7-12.7,64.7-38,90s-55.3,38-90,38c-36,0-66-12.7-90-38l-343-342  c-119.3,82.7-252.3,124-399,124c-95.3,0-186.5-18.5-273.5-55.5s-162-87-225-150s-113-138-150-225S654,427.3,654,332  s18.5-186.5,55.5-273.5s87-162,150-225s138-113,225-150S1262.7-372,1358-372s186.5,18.5,273.5,55.5s162,87,225,150s113,138,150,225  S2062,236.7,2062,332c0,146.7-41.3,279.7-124,399l343,343C2305.7,1098.7,2318,1128.7,2318,1164z" />
    </svg>
</div>
<script src="https://www.qikqiak.com/js/algoliasearch.min.js"></script>
<script src="https://www.qikqiak.com/js/autocomplete.min.js"></script>

<script>
var client = algoliasearch("1JDRAS0AZR", "8804ac109158bb3bb60d74ce98fa332f");
var index = client.initIndex('prod_blog');

autocomplete('#aa-search-input',
{ hint: false}, {
    source: autocomplete.sources.hits(index, {hitsPerPage: 5}),
    
    displayKey: 'name',
    
    templates: {
        
        suggestion: function(suggestion) {
            return '<span>' + '<a href="https://www.qikqiak.com/post/' + suggestion.slug + '">' +
            suggestion._highlightResult.title.value + '</a></span>';
        }
    }
});
</script>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">close</button>
        </div>
      </div>
    </div>
  </div>

    
  
  
  




  
    <div id="header-big-imgs" data-num-img=1 data-img-src-1="https://picdn.youdianzhishi.com/images/20210812213346.png" data-img-desc-1="https://unsplash.com/photos/ZXnhTNY94Zs"></div>
  

  <header class="header-section has-img">
    
      <div class="intro-header big-img">
        
        <div class="container">
          <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
              <div class="post-heading">
                <h1>一文搞懂容器运行时 Containerd</h1>
                  
                  
                    <span class="post-meta">
  发表于 August 12, 2021  
</span>

                  
              </div>
            </div>
          </div>
        </div>
        <span class="img-desc" style="display: inline;"></span>
      </div>
    
    
    
    <div class="intro-header no-img">
      
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              <h1>一文搞懂容器运行时 Containerd</h1>
                
                
                  <span class="post-meta">
  发表于 August 12, 2021  
</span>

                
            </div>
          </div>
        </div>
      </div>
    </div>
    
    
  </header>


    



<div class="container" role="main">
  <div class="row">

    
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div>
            
            
            <h5 id="tags" style="margin-top: 30px;">标签:
              
                  <a href="https://www.qikqiak.com/tags/kubernetes/">kubernetes</a> &nbsp;
              
                  <a href="https://www.qikqiak.com/tags/docker/">docker</a> &nbsp;
              
                  <a href="https://www.qikqiak.com/tags/containerd/">containerd</a> &nbsp;
              
            </h5>
            
        </div>
  
        <article role="main" class="blog-post" itemprop="articleBody" id="content">
          
            
<aside class="toc">
  <nav id="TableOfContents">
  <ul>
    <li><a href="#docker">Docker</a></li>
    <li><a href="#cri">CRI</a></li>
    <li><a href="#containerd">Containerd</a>
      <ul>
        <li><a href="#架构">架构</a></li>
        <li><a href="#安装">安装</a></li>
        <li><a href="#配置">配置</a></li>
        <li><a href="#使用">使用</a></li>
      </ul>
    </li>
  </ul>
</nav>
</aside>

          
  
          
          
          
  
          
          
          
  
          
          
          

          <p>在学习 Containerd 之前我们有必要对 Docker 的发展历史做一个简单的回顾，因为这里面牵涉到的组件实战是有点多，有很多我们会经常听到，但是不清楚这些组件到底是干什么用的，比如 <code>libcontainer</code>、<code>runc</code>、<code>containerd</code>、<code>CRI</code>、<code>OCI</code> 等等。</p>
<h2 id="docker">Docker</h2>
<p>从 Docker 1.11 版本开始，Docker 容器运行就不是简单通过 Docker Daemon 来启动了，而是通过集成 containerd、runc 等多个组件来完成的。虽然 Docker Daemon 守护进程模块在不停的重构，但是基本功能和定位没有太大的变化，一直都是 CS 架构，守护进程负责和 Docker Client 端交互，并管理 Docker 镜像和容器。现在的架构中组件 containerd 就会负责集群节点上容器的生命周期管理，并向上为 Docker Daemon 提供 gRPC 接口。</p>
<p><img src="https://picdn.youdianzhishi.com/images/20210809154608.png" alt="docker 架构"></p>
<p>当我们要创建一个容器的时候，现在 Docker Daemon 并不能直接帮我们创建了，而是请求 <code>containerd</code> 来创建一个容器，containerd 收到请求后，也并不会直接去操作容器，而是创建一个叫做 <code>containerd-shim</code> 的进程，让这个进程去操作容器，我们指定容器进程是需要一个父进程来做状态收集、维持 stdin 等 fd 打开等工作的，假如这个父进程就是 containerd，那如果 containerd 挂掉的话，整个宿主机上所有的容器都得退出了，而引入 <code>containerd-shim</code> 这个垫片就可以来规避这个问题了。</p>
<p>然后创建容器需要做一些 namespaces 和 cgroups 的配置，以及挂载 root 文件系统等操作，这些操作其实已经有了标准的规范，那就是 OCI（开放容器标准），<code>runc</code> 就是它的一个参考实现（Docker 被逼无耐将 <code>libcontainer</code> 捐献出来改名为 <code>runc</code> 的），这个标准其实就是一个文档，主要规定了容器镜像的结构、以及容器需要接收哪些操作指令，比如 create、start、stop、delete 等这些命令。<code>runc</code> 就可以按照这个 OCI 文档来创建一个符合规范的容器，既然是标准肯定就有其他 OCI 实现，比如 Kata、gVisor 这些容器运行时都是符合 OCI 标准的。</p>
<p>所以真正启动容器是通过 <code>containerd-shim</code> 去调用 <code>runc</code> 来启动容器的，<code>runc</code> 启动完容器后本身会直接退出，<code>containerd-shim</code> 则会成为容器进程的父进程, 负责收集容器进程的状态, 上报给 containerd, 并在容器中 pid 为 1 的进程退出后接管容器中的子进程进行清理, 确保不会出现僵尸进程。</p>
<p>而 Docker 将容器操作都迁移到 <code>containerd</code> 中去是因为当前做 Swarm，想要进军 PaaS 市场，做了这个架构切分，让 Docker Daemon 专门去负责上层的封装编排，当然后面的结果我们知道 Swarm 在 Kubernetes 面前是惨败，然后 Docker 公司就把 <code>containerd</code> 项目捐献给了 CNCF 基金会，这个也是现在的 Docker 架构。</p>
<h2 id="cri">CRI</h2>
<p>我们知道 Kubernetes 提供了一个 CRI 的容器运行时接口，那么这个 CRI 到底是什么呢？这个其实也和 Docker 的发展密切相关的。</p>
<p>在 Kubernetes 早期的时候，当时 Docker 实在是太火了，Kubernetes 当然会先选择支持 Docker，而且是通过硬编码的方式直接调用 Docker API，后面随着 Docker 的不断发展以及 Google 的主导，出现了更多容器运行时，Kubernetes 为了支持更多更精简的容器运行时，Google 就和红帽主导推出了 CRI 标准，用于将 Kubernetes 平台和特定的容器运行时（当然主要是为了干掉 Docker）解耦。</p>
<p><code>CRI</code>（Container Runtime Interface 容器运行时接口）本质上就是 Kubernetes 定义的一组与容器运行时进行交互的接口，所以只要实现了这套接口的容器运行时都可以对接到 Kubernetes 平台上来。不过 Kubernetes 推出 CRI 这套标准的时候还没有现在的统治地位，所以有一些容器运行时可能不会自身就去实现 CRI 接口，于是就有了 <code>shim（垫片）</code>， 一个 shim 的职责就是作为适配器将各种容器运行时本身的接口适配到 Kubernetes 的 CRI 接口上，其中 <code>dockershim</code> 就是 Kubernetes 对接 Docker 到 CRI 接口上的一个垫片实现。</p>
<p><img src="https://picdn.youdianzhishi.com/images/20210809172030.png" alt="cri shim"></p>
<p>Kubelet 通过 gRPC 框架与容器运行时或 shim 进行通信，其中 kubelet 作为客户端，CRI shim（也可能是容器运行时本身）作为服务器。</p>
<p>CRI 定义的 API(<a href="https://github.com/kubernetes/kubernetes/blob/release-1.5/pkg/kubelet/api/v1alpha1/runtime/api.proto">https://github.com/kubernetes/kubernetes/blob/release-1.5/pkg/kubelet/api/v1alpha1/runtime/api.proto</a>) 主要包括两个 gRPC 服务，<code>ImageService</code> 和 <code>RuntimeService</code>，<code>ImageService</code> 服务主要是拉取镜像、查看和删除镜像等操作，<code>RuntimeService</code> 则是用来管理 Pod 和容器的生命周期，以及与容器交互的调用（exec/attach/port-forward）等操作，可以通过 kubelet 中的标志 <code>--container-runtime-endpoint</code> 和 <code>--image-service-endpoint</code> 来配置这两个服务的套接字。</p>
<p><img src="https://picdn.youdianzhishi.com/images/20210809173134.png" alt="kubelet cri"></p>
<p>不过这里同样也有一个例外，那就是 Docker，由于 Docker 当时的江湖地位很高，Kubernetes 是直接内置了 <code>dockershim</code> 在 kubelet 中的，所以如果你使用的是 Docker 这种容器运行时的话是不需要单独去安装配置适配器之类的，当然这个举动似乎也麻痹了 Docker 公司。</p>
<p><img src="https://picdn.youdianzhishi.com/images/20210809173555.png" alt="dockershim"></p>
<p>现在如果我们使用的是 Docker 的话，当我们在 Kubernetes 中创建一个 Pod 的时候，首先就是 kubelet 通过 CRI 接口调用 <code>dockershim</code>，请求创建一个容器，kubelet 可以视作一个简单的 CRI Client, 而 dockershim 就是接收请求的 Server，不过他们都是在 kubelet 内置的。</p>
<p><code>dockershim</code> 收到请求后, 转化成 Docker Daemon 能识别的请求, 发到 Docker Daemon 上请求创建一个容器，请求到了 Docker Daemon 后续就是 Docker 创建容器的流程了，去调用 <code>containerd</code>，然后创建 <code>containerd-shim</code> 进程，通过该进程去调用 <code>runc</code> 去真正创建容器。</p>
<p>其实我们仔细观察也不难发现使用 Docker 的话其实是调用链比较长的，真正容器相关的操作其实 containerd 就完全足够了，Docker 太过于复杂笨重了，当然 Docker 深受欢迎的很大一个原因就是提供了很多对用户操作比较友好的功能，但是对于 Kubernetes 来说压根不需要这些功能，因为都是通过接口去操作容器的，所以自然也就可以将容器运行时切换到 containerd 来。</p>
<p><img src="https://picdn.youdianzhishi.com/images/20210810094948.png" alt="切换到containerd"></p>
<p>切换到 containerd 可以消除掉中间环节，操作体验也和以前一样，但是由于直接用容器运行时调度容器，所以它们对 Docker 来说是不可见的。 因此，你以前用来检查这些容器的 Docker 工具就不能使用了。</p>
<p>你不能再使用 <code>docker ps</code> 或 <code>docker inspect</code> 命令来获取容器信息。由于不能列出容器，因此也不能获取日志、停止容器，甚至不能通过 <code>docker exec</code> 在容器中执行命令。</p>
<p>当然我们仍然可以下载镜像，或者用 <code>docker build</code> 命令构建镜像，但用 Docker 构建、下载的镜像，对于容器运行时和 Kubernetes，均不可见。为了在 Kubernetes 中使用，需要把镜像推送到镜像仓库中去。</p>
<p>从上图可以看出在 containerd 1.0 中，对 CRI 的适配是通过一个单独的 <code>CRI-Containerd</code> 进程来完成的，这是因为最开始 containerd 还会去适配其他的系统（比如 swarm），所以没有直接实现 CRI，所以这个对接工作就交给 <code>CRI-Containerd</code> 这个 shim 了。</p>
<p>然后到了 containerd 1.1 版本后就去掉了 <code>CRI-Containerd</code> 这个 shim，直接把适配逻辑作为插件的方式集成到了 containerd 主进程中，现在这样的调用就更加简洁了。</p>
<p><img src="https://picdn.youdianzhishi.com/images/20210810095546.png" alt="containerd cri"></p>
<p>与此同时 Kubernetes 社区也做了一个专门用于 Kubernetes 的 CRI 运行时 <a href="https://cri-o.io/">CRI-O</a>，直接兼容 CRI 和 OCI 规范。</p>
<p><img src="https://picdn.youdianzhishi.com/images/20210810100752.png" alt="cri-o"></p>
<p>这个方案和 containerd 的方案显然比默认的 dockershim 简洁很多，不过由于大部分用户都比较习惯使用 Docker，所以大家还是更喜欢使用 <code>dockershim</code> 方案。</p>
<p>但是随着 CRI 方案的发展，以及其他容器运行时对 CRI 的支持越来越完善，Kubernetes 社区在 2020 年 7 月份就开始着手移除 dockershim 方案了：https://github.com/kubernetes/enhancements/tree/master/keps/sig-node/2221-remove-dockershim，现在的移除计划是在 1.20 版本中将 kubelet 中内置的 dockershim 代码分离，将内置的 dockershim 标记为<code>维护模式</code>，当然这个时候仍然还可以使用 dockershim，目标是在 1.23/1.24 版本发布没有 dockershim 的版本（代码还在，但是要默认支持开箱即用的 docker 需要自己构建 kubelet，会在某个宽限期过后从 kubelet 中删除内置的 dockershim 代码）。</p>
<!-- raw HTML omitted -->
<p>那么这是否就意味这 Kubernetes 不再支持 Docker 了呢？当然不是的，这只是废弃了内置的 <code>dockershim</code> 功能而已，Docker 和其他容器运行时将一视同仁，不会单独对待内置支持，如果我们还想直接使用 Docker 这种容器运行时应该怎么办呢？可以将 dockershim 的功能单独提取出来独立维护一个 <code>cri-dockerd</code> 即可，就类似于 containerd 1.0 版本中提供的 <code>CRI-Containerd</code>，当然还有一种办法就是 Docker 官方社区将 CRI 接口内置到 Dockerd 中去实现。</p>
<p>但是我们也清楚 Dockerd 也是去直接调用的 Containerd，而 containerd 1.1 版本后就内置实现了 CRI，所以 Docker 也没必要再去单独实现 CRI 了，当 Kubernetes 不再内置支持开箱即用的 Docker 的以后，最好的方式当然也就是直接使用 Containerd 这种容器运行时，而且该容器运行时也已经经过了生产环境实践的，接下来我们就来学习下 Containerd 的使用。</p>
<h2 id="containerd">Containerd</h2>
<p>我们知道很早之前的 Docker Engine 中就有了 containerd，只不过现在是将 containerd 从 Docker Engine 里分离出来，作为一个独立的开源项目，目标是提供一个更加开放、稳定的容器运行基础设施。分离出来的 containerd 将具有更多的功能，涵盖整个容器运行时管理的所有需求，提供更强大的支持。</p>
<p>containerd 是一个工业级标准的容器运行时，它强调<strong>简单性</strong>、<strong>健壮性</strong>和<strong>可移植性</strong>，containerd 可以负责干下面这些事情：</p>
<ul>
<li>管理容器的生命周期（从创建容器到销毁容器）</li>
<li>拉取/推送容器镜像</li>
<li>存储管理（管理镜像及容器数据的存储）</li>
<li>调用 runc 运行容器（与 runc 等容器运行时交互）</li>
<li>管理容器网络接口及网络</li>
</ul>
<h3 id="架构">架构</h3>
<p>containerd 可用作 Linux 和 Windows 的守护程序，它管理其主机系统完整的容器生命周期，从镜像传输和存储到容器执行和监测，再到底层存储到网络附件等等。</p>
<p><img src="https://picdn.youdianzhishi.com/images/20210810134700.png" alt="containerd 架构"></p>
<p>上图是 containerd 官方提供的架构图，可以看出 containerd 采用的也是 C/S 架构，服务端通过 unix domain socket 暴露低层的 gRPC API 接口出去，客户端通过这些 API 管理节点上的容器，每个 containerd 只负责一台机器，Pull 镜像，对容器的操作（启动、停止等），网络，存储都是由 containerd 完成。具体运行容器由 runc 负责，实际上只要是符合 OCI 规范的容器都可以支持。</p>
<p>为了解耦，containerd 将系统划分成了不同的组件，每个组件都由一个或多个模块协作完成（Core 部分），每一种类型的模块都以插件的形式集成到 Containerd 中，而且插件之间是相互依赖的，例如，上图中的每一个长虚线的方框都表示一种类型的插件，包括 Service Plugin、Metadata Plugin、GC Plugin、Runtime Plugin 等，其中 Service Plugin 又会依赖 Metadata Plugin、GC Plugin 和 Runtime Plugin。每一个小方框都表示一个细分的插件，例如 Metadata Plugin 依赖 Containers Plugin、Content Plugin 等。比如:</p>
<ul>
<li><code>Content Plugin</code>: 提供对镜像中可寻址内容的访问，所有不可变的内容都被存储在这里。</li>
<li><code>Snapshot Plugin</code>: 用来管理容器镜像的文件系统快照，镜像中的每一层都会被解压成文件系统快照，类似于 Docker 中的 graphdriver。</li>
</ul>
<p>总体来看 containerd 可以分为三个大块：Storage、Metadata 和 Runtime。</p>
<p><img src="https://picdn.youdianzhishi.com/images/20210810145929.png" alt="containerd 架构2"></p>
<h3 id="安装">安装</h3>
<p>这里我使用的系统是 <code>Linux Mint 20.2</code>，首先需要安装 <code>seccomp</code> 依赖：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ apt-get update
</span></span><span style="display:flex;"><span>➜  ~ apt-get install libseccomp2 -y
</span></span></code></pre></div><p>由于 containerd 需要调用 runc，所以我们也需要先安装 runc，不过 containerd 提供了一个包含相关依赖的压缩包 <code>cri-containerd-cni-${VERSION}.${OS}-${ARCH}.tar.gz</code>，可以直接使用这个包来进行安装。首先从 <a href="https://github.com/containerd/containerd/releases">release 页面</a>下载最新版本的压缩包，当前为 1.5.5 版本：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ wget https://github.com/containerd/containerd/releases/download/v1.5.5/cri-containerd-cni-1.5.5-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 如果有限制，也可以替换成下面的 URL 加速下载</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># wget https://download.fastgit.org/containerd/containerd/releases/download/v1.5.5/cri-containerd-cni-1.5.5-linux-amd64.tar.gz</span>
</span></span></code></pre></div><p>可以通过 tar 的 <code>-t</code> 选项直接看到压缩包中包含哪些文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ tar -tf cri-containerd-cni-1.4.3-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>etc/
</span></span><span style="display:flex;"><span>etc/cni/
</span></span><span style="display:flex;"><span>etc/cni/net.d/
</span></span><span style="display:flex;"><span>etc/cni/net.d/10-containerd-net.conflist
</span></span><span style="display:flex;"><span>etc/crictl.yaml
</span></span><span style="display:flex;"><span>etc/systemd/
</span></span><span style="display:flex;"><span>etc/systemd/system/
</span></span><span style="display:flex;"><span>etc/systemd/system/containerd.service
</span></span><span style="display:flex;"><span>usr/
</span></span><span style="display:flex;"><span>usr/local/
</span></span><span style="display:flex;"><span>usr/local/bin/
</span></span><span style="display:flex;"><span>usr/local/bin/containerd-shim-runc-v2
</span></span><span style="display:flex;"><span>usr/local/bin/ctr
</span></span><span style="display:flex;"><span>usr/local/bin/containerd-shim
</span></span><span style="display:flex;"><span>usr/local/bin/containerd-shim-runc-v1
</span></span><span style="display:flex;"><span>usr/local/bin/crictl
</span></span><span style="display:flex;"><span>usr/local/bin/critest
</span></span><span style="display:flex;"><span>usr/local/bin/containerd
</span></span><span style="display:flex;"><span>usr/local/sbin/
</span></span><span style="display:flex;"><span>usr/local/sbin/runc
</span></span><span style="display:flex;"><span>opt/
</span></span><span style="display:flex;"><span>opt/cni/
</span></span><span style="display:flex;"><span>opt/cni/bin/
</span></span><span style="display:flex;"><span>opt/cni/bin/vlan
</span></span><span style="display:flex;"><span>opt/cni/bin/host-local
</span></span><span style="display:flex;"><span>opt/cni/bin/flannel
</span></span><span style="display:flex;"><span>opt/cni/bin/bridge
</span></span><span style="display:flex;"><span>opt/cni/bin/host-device
</span></span><span style="display:flex;"><span>opt/cni/bin/tuning
</span></span><span style="display:flex;"><span>opt/cni/bin/firewall
</span></span><span style="display:flex;"><span>opt/cni/bin/bandwidth
</span></span><span style="display:flex;"><span>opt/cni/bin/ipvlan
</span></span><span style="display:flex;"><span>opt/cni/bin/sbr
</span></span><span style="display:flex;"><span>opt/cni/bin/dhcp
</span></span><span style="display:flex;"><span>opt/cni/bin/portmap
</span></span><span style="display:flex;"><span>opt/cni/bin/ptp
</span></span><span style="display:flex;"><span>opt/cni/bin/static
</span></span><span style="display:flex;"><span>opt/cni/bin/macvlan
</span></span><span style="display:flex;"><span>opt/cni/bin/loopback
</span></span><span style="display:flex;"><span>opt/containerd/
</span></span><span style="display:flex;"><span>opt/containerd/cluster/
</span></span><span style="display:flex;"><span>opt/containerd/cluster/version
</span></span><span style="display:flex;"><span>opt/containerd/cluster/gce/
</span></span><span style="display:flex;"><span>opt/containerd/cluster/gce/cni.template
</span></span><span style="display:flex;"><span>opt/containerd/cluster/gce/configure.sh
</span></span><span style="display:flex;"><span>opt/containerd/cluster/gce/cloud-init/
</span></span><span style="display:flex;"><span>opt/containerd/cluster/gce/cloud-init/master.yaml
</span></span><span style="display:flex;"><span>opt/containerd/cluster/gce/cloud-init/node.yaml
</span></span><span style="display:flex;"><span>opt/containerd/cluster/gce/env
</span></span></code></pre></div><p>直接将压缩包解压到系统的各个目录中：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ tar -C / -xzf cri-containerd-cni-1.5.5-linux-amd64.tar.gz
</span></span></code></pre></div><p>当然要记得将 <code>/usr/local/bin</code> 和 <code>/usr/local/sbin</code> 追加到 <code>~/.bashrc</code> 文件的 <code>PATH</code> 环境变量中：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">export</span> <span style="color:#8be9fd;font-style:italic">PATH</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$PATH</span>:/usr/local/bin:/usr/local/sbin
</span></span></code></pre></div><p>然后执行下面的命令使其立即生效：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ <span style="color:#8be9fd;font-style:italic">source</span> ~/.bashrc
</span></span></code></pre></div><p>containerd 的默认配置文件为 <code>/etc/containerd/config.toml</code>，我们可以通过如下所示的命令生成一个默认的配置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ mkdir /etc/containerd
</span></span><span style="display:flex;"><span>➜  ~ containerd config default &gt; /etc/containerd/config.toml
</span></span></code></pre></div><p>由于上面我们下在的 containerd 压缩包中包含一个 <code>etc/systemd/system/containerd.service</code> 的文件，这样我们就可以通过 systemd 来配置 containerd 作为守护进程运行了，内容如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ cat /etc/systemd/system/containerd.service
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>Unit<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">Description</span><span style="color:#ff79c6">=</span>containerd container runtime
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">Documentation</span><span style="color:#ff79c6">=</span>https://containerd.io
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">After</span><span style="color:#ff79c6">=</span>network.target local-fs.target
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>Service<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">ExecStartPre</span><span style="color:#ff79c6">=</span>-/sbin/modprobe overlay
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">ExecStart</span><span style="color:#ff79c6">=</span>/usr/local/bin/containerd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">Type</span><span style="color:#ff79c6">=</span>notify
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">Delegate</span><span style="color:#ff79c6">=</span>yes
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">KillMode</span><span style="color:#ff79c6">=</span>process
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">Restart</span><span style="color:#ff79c6">=</span>always
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">RestartSec</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">5</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Having non-zero Limit*s causes performance problems due to accounting overhead</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># in the kernel. We recommend using cgroups to do container-local accounting.</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">LimitNPROC</span><span style="color:#ff79c6">=</span>infinity
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">LimitCORE</span><span style="color:#ff79c6">=</span>infinity
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">LimitNOFILE</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">1048576</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Comment TasksMax if your systemd version does not supports it.</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Only systemd 226 and above support this version.</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">TasksMax</span><span style="color:#ff79c6">=</span>infinity
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">OOMScoreAdjust</span><span style="color:#ff79c6">=</span>-999
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>Install<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">WantedBy</span><span style="color:#ff79c6">=</span>multi-user.target
</span></span></code></pre></div><p>这里有两个重要的参数：</p>
<ul>
<li>
<p><code>Delegate</code>: 这个选项允许 containerd 以及运行时自己管理自己创建容器的 cgroups。如果不设置这个选项，systemd 就会将进程移到自己的 cgroups 中，从而导致 containerd 无法正确获取容器的资源使用情况。</p>
</li>
<li>
<p><code>KillMode</code>: 这个选项用来处理 containerd 进程被杀死的方式。默认情况下，systemd 会在进程的 cgroup 中查找并杀死 containerd 的所有子进程。KillMode 字段可以设置的值如下。</p>
<ul>
<li><code>control-group</code>（默认值）：当前控制组里面的所有子进程，都会被杀掉</li>
<li><code>process</code>：只杀主进程</li>
<li><code>mixed</code>：主进程将收到 SIGTERM 信号，子进程收到 SIGKILL 信号</li>
<li><code>none</code>：没有进程会被杀掉，只是执行服务的 stop 命令</li>
</ul>
</li>
</ul>
<p>我们需要将 KillMode 的值设置为 process，这样可以确保升级或重启 containerd 时不杀死现有的容器。</p>
<p>现在我们就可以启动 containerd 了，直接执行下面的命令即可：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ systemctl <span style="color:#8be9fd;font-style:italic">enable</span> containerd --now
</span></span></code></pre></div><p>启动完成后就可以使用 containerd 的本地 CLI 工具 <code>ctr</code> 了，比如查看版本：</p>
<p><img src="https://picdn.youdianzhishi.com/images/20210810164519.png" alt="ctr version"></p>
<h3 id="配置">配置</h3>
<p>我们首先来查看下上面默认生成的配置文件 <code>/etc/containerd/config.toml</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span>disabled_plugins = []
</span></span><span style="display:flex;"><span>imports = []
</span></span><span style="display:flex;"><span>oom_score = <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>plugin_dir = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>required_plugins = []
</span></span><span style="display:flex;"><span>root = <span style="color:#f1fa8c">&#34;/var/lib/containerd&#34;</span>
</span></span><span style="display:flex;"><span>state = <span style="color:#f1fa8c">&#34;/run/containerd&#34;</span>
</span></span><span style="display:flex;"><span>version = <span style="color:#bd93f9">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[cgroup]
</span></span><span style="display:flex;"><span>  path = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[debug]
</span></span><span style="display:flex;"><span>  address = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  format = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  gid = <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>  level = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  uid = <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[grpc]
</span></span><span style="display:flex;"><span>  address = <span style="color:#f1fa8c">&#34;/run/containerd/containerd.sock&#34;</span>
</span></span><span style="display:flex;"><span>  gid = <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>  max_recv_message_size = <span style="color:#bd93f9">16777216</span>
</span></span><span style="display:flex;"><span>  max_send_message_size = <span style="color:#bd93f9">16777216</span>
</span></span><span style="display:flex;"><span>  tcp_address = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  tcp_tls_cert = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  tcp_tls_key = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  uid = <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[metrics]
</span></span><span style="display:flex;"><span>  address = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  grpc_histogram = <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[plugins]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  [plugins.<span style="color:#f1fa8c">&#34;io.containerd.gc.v1.scheduler&#34;</span>]
</span></span><span style="display:flex;"><span>    deletion_threshold = <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>    mutation_threshold = <span style="color:#bd93f9">100</span>
</span></span><span style="display:flex;"><span>    pause_threshold = <span style="color:#bd93f9">0.02</span>
</span></span><span style="display:flex;"><span>    schedule_delay = <span style="color:#f1fa8c">&#34;0s&#34;</span>
</span></span><span style="display:flex;"><span>    startup_delay = <span style="color:#f1fa8c">&#34;100ms&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  [plugins.<span style="color:#f1fa8c">&#34;io.containerd.grpc.v1.cri&#34;</span>]
</span></span><span style="display:flex;"><span>    disable_apparmor = <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>    disable_cgroup = <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>    disable_hugetlb_controller = <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>    disable_proc_mount = <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>    disable_tcp_service = <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>    enable_selinux = <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>    enable_tls_streaming = <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>    ignore_image_defined_volumes = <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>    max_concurrent_downloads = <span style="color:#bd93f9">3</span>
</span></span><span style="display:flex;"><span>    max_container_log_line_size = <span style="color:#bd93f9">16384</span>
</span></span><span style="display:flex;"><span>    netns_mounts_under_state_dir = <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>    restrict_oom_score_adj = <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>    sandbox_image = <span style="color:#f1fa8c">&#34;k8s.gcr.io/pause:3.5&#34;</span>
</span></span><span style="display:flex;"><span>    selinux_category_range = <span style="color:#bd93f9">1024</span>
</span></span><span style="display:flex;"><span>    stats_collect_period = <span style="color:#bd93f9">10</span>
</span></span><span style="display:flex;"><span>    stream_idle_timeout = <span style="color:#f1fa8c">&#34;4h0m0s&#34;</span>
</span></span><span style="display:flex;"><span>    stream_server_address = <span style="color:#f1fa8c">&#34;127.0.0.1&#34;</span>
</span></span><span style="display:flex;"><span>    stream_server_port = <span style="color:#f1fa8c">&#34;0&#34;</span>
</span></span><span style="display:flex;"><span>    systemd_cgroup = <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>    tolerate_missing_hugetlb_controller = <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>    unset_seccomp_profile = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    [plugins.<span style="color:#f1fa8c">&#34;io.containerd.grpc.v1.cri&#34;</span>.cni]
</span></span><span style="display:flex;"><span>      bin_dir = <span style="color:#f1fa8c">&#34;/opt/cni/bin&#34;</span>
</span></span><span style="display:flex;"><span>      conf_dir = <span style="color:#f1fa8c">&#34;/etc/cni/net.d&#34;</span>
</span></span><span style="display:flex;"><span>      conf_template = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>      max_conf_num = <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    [plugins.<span style="color:#f1fa8c">&#34;io.containerd.grpc.v1.cri&#34;</span>.containerd]
</span></span><span style="display:flex;"><span>      default_runtime_name = <span style="color:#f1fa8c">&#34;runc&#34;</span>
</span></span><span style="display:flex;"><span>      disable_snapshot_annotations = <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>      discard_unpacked_layers = <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>      no_pivot = <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>      snapshotter = <span style="color:#f1fa8c">&#34;overlayfs&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      [plugins.<span style="color:#f1fa8c">&#34;io.containerd.grpc.v1.cri&#34;</span>.containerd.default_runtime]
</span></span><span style="display:flex;"><span>        base_runtime_spec = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        container_annotations = []
</span></span><span style="display:flex;"><span>        pod_annotations = []
</span></span><span style="display:flex;"><span>        privileged_without_host_devices = <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>        runtime_engine = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        runtime_root = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        runtime_type = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        [plugins.<span style="color:#f1fa8c">&#34;io.containerd.grpc.v1.cri&#34;</span>.containerd.default_runtime.options]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      [plugins.<span style="color:#f1fa8c">&#34;io.containerd.grpc.v1.cri&#34;</span>.containerd.runtimes]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        [plugins.<span style="color:#f1fa8c">&#34;io.containerd.grpc.v1.cri&#34;</span>.containerd.runtimes.runc]
</span></span><span style="display:flex;"><span>          base_runtime_spec = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>          container_annotations = []
</span></span><span style="display:flex;"><span>          pod_annotations = []
</span></span><span style="display:flex;"><span>          privileged_without_host_devices = <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>          runtime_engine = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>          runtime_root = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>          runtime_type = <span style="color:#f1fa8c">&#34;io.containerd.runc.v2&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          [plugins.<span style="color:#f1fa8c">&#34;io.containerd.grpc.v1.cri&#34;</span>.containerd.runtimes.runc.options]
</span></span><span style="display:flex;"><span>            BinaryName = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            CriuImagePath = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            CriuPath = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            CriuWorkPath = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            IoGid = <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>            IoUid = <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>            NoNewKeyring = <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>            NoPivotRoot = <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>            Root = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            ShimCgroup = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            SystemdCgroup = <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      [plugins.<span style="color:#f1fa8c">&#34;io.containerd.grpc.v1.cri&#34;</span>.containerd.untrusted_workload_runtime]
</span></span><span style="display:flex;"><span>        base_runtime_spec = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        container_annotations = []
</span></span><span style="display:flex;"><span>        pod_annotations = []
</span></span><span style="display:flex;"><span>        privileged_without_host_devices = <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>        runtime_engine = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        runtime_root = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        runtime_type = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        [plugins.<span style="color:#f1fa8c">&#34;io.containerd.grpc.v1.cri&#34;</span>.containerd.untrusted_workload_runtime.options]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    [plugins.<span style="color:#f1fa8c">&#34;io.containerd.grpc.v1.cri&#34;</span>.image_decryption]
</span></span><span style="display:flex;"><span>      key_model = <span style="color:#f1fa8c">&#34;node&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    [plugins.<span style="color:#f1fa8c">&#34;io.containerd.grpc.v1.cri&#34;</span>.registry]
</span></span><span style="display:flex;"><span>      config_path = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      [plugins.<span style="color:#f1fa8c">&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.auths]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      [plugins.<span style="color:#f1fa8c">&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.configs]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      [plugins.<span style="color:#f1fa8c">&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.headers]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      [plugins.<span style="color:#f1fa8c">&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.mirrors]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    [plugins.<span style="color:#f1fa8c">&#34;io.containerd.grpc.v1.cri&#34;</span>.x509_key_pair_streaming]
</span></span><span style="display:flex;"><span>      tls_cert_file = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>      tls_key_file = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  [plugins.<span style="color:#f1fa8c">&#34;io.containerd.internal.v1.opt&#34;</span>]
</span></span><span style="display:flex;"><span>    path = <span style="color:#f1fa8c">&#34;/opt/containerd&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  [plugins.<span style="color:#f1fa8c">&#34;io.containerd.internal.v1.restart&#34;</span>]
</span></span><span style="display:flex;"><span>    interval = <span style="color:#f1fa8c">&#34;10s&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  [plugins.<span style="color:#f1fa8c">&#34;io.containerd.metadata.v1.bolt&#34;</span>]
</span></span><span style="display:flex;"><span>    content_sharing_policy = <span style="color:#f1fa8c">&#34;shared&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  [plugins.<span style="color:#f1fa8c">&#34;io.containerd.monitor.v1.cgroups&#34;</span>]
</span></span><span style="display:flex;"><span>    no_prometheus = <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  [plugins.<span style="color:#f1fa8c">&#34;io.containerd.runtime.v1.linux&#34;</span>]
</span></span><span style="display:flex;"><span>    no_shim = <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>    runtime = <span style="color:#f1fa8c">&#34;runc&#34;</span>
</span></span><span style="display:flex;"><span>    runtime_root = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    shim = <span style="color:#f1fa8c">&#34;containerd-shim&#34;</span>
</span></span><span style="display:flex;"><span>    shim_debug = <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  [plugins.<span style="color:#f1fa8c">&#34;io.containerd.runtime.v2.task&#34;</span>]
</span></span><span style="display:flex;"><span>    platforms = [<span style="color:#f1fa8c">&#34;linux/amd64&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  [plugins.<span style="color:#f1fa8c">&#34;io.containerd.service.v1.diff-service&#34;</span>]
</span></span><span style="display:flex;"><span>    default = [<span style="color:#f1fa8c">&#34;walking&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  [plugins.<span style="color:#f1fa8c">&#34;io.containerd.snapshotter.v1.aufs&#34;</span>]
</span></span><span style="display:flex;"><span>    root_path = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  [plugins.<span style="color:#f1fa8c">&#34;io.containerd.snapshotter.v1.btrfs&#34;</span>]
</span></span><span style="display:flex;"><span>    root_path = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  [plugins.<span style="color:#f1fa8c">&#34;io.containerd.snapshotter.v1.devmapper&#34;</span>]
</span></span><span style="display:flex;"><span>    async_remove = <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>    base_image_size = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    pool_name = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    root_path = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  [plugins.<span style="color:#f1fa8c">&#34;io.containerd.snapshotter.v1.native&#34;</span>]
</span></span><span style="display:flex;"><span>    root_path = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  [plugins.<span style="color:#f1fa8c">&#34;io.containerd.snapshotter.v1.overlayfs&#34;</span>]
</span></span><span style="display:flex;"><span>    root_path = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  [plugins.<span style="color:#f1fa8c">&#34;io.containerd.snapshotter.v1.zfs&#34;</span>]
</span></span><span style="display:flex;"><span>    root_path = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[proxy_plugins]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[stream_processors]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  [stream_processors.<span style="color:#f1fa8c">&#34;io.containerd.ocicrypt.decoder.v1.tar&#34;</span>]
</span></span><span style="display:flex;"><span>    accepts = [<span style="color:#f1fa8c">&#34;application/vnd.oci.image.layer.v1.tar+encrypted&#34;</span>]
</span></span><span style="display:flex;"><span>    args = [<span style="color:#f1fa8c">&#34;--decryption-keys-path&#34;</span>, <span style="color:#f1fa8c">&#34;/etc/containerd/ocicrypt/keys&#34;</span>]
</span></span><span style="display:flex;"><span>    env = [<span style="color:#f1fa8c">&#34;OCICRYPT_KEYPROVIDER_CONFIG=/etc/containerd/ocicrypt/ocicrypt_keyprovider.conf&#34;</span>]
</span></span><span style="display:flex;"><span>    path = <span style="color:#f1fa8c">&#34;ctd-decoder&#34;</span>
</span></span><span style="display:flex;"><span>    returns = <span style="color:#f1fa8c">&#34;application/vnd.oci.image.layer.v1.tar&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  [stream_processors.<span style="color:#f1fa8c">&#34;io.containerd.ocicrypt.decoder.v1.tar.gzip&#34;</span>]
</span></span><span style="display:flex;"><span>    accepts = [<span style="color:#f1fa8c">&#34;application/vnd.oci.image.layer.v1.tar+gzip+encrypted&#34;</span>]
</span></span><span style="display:flex;"><span>    args = [<span style="color:#f1fa8c">&#34;--decryption-keys-path&#34;</span>, <span style="color:#f1fa8c">&#34;/etc/containerd/ocicrypt/keys&#34;</span>]
</span></span><span style="display:flex;"><span>    env = [<span style="color:#f1fa8c">&#34;OCICRYPT_KEYPROVIDER_CONFIG=/etc/containerd/ocicrypt/ocicrypt_keyprovider.conf&#34;</span>]
</span></span><span style="display:flex;"><span>    path = <span style="color:#f1fa8c">&#34;ctd-decoder&#34;</span>
</span></span><span style="display:flex;"><span>    returns = <span style="color:#f1fa8c">&#34;application/vnd.oci.image.layer.v1.tar+gzip&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[timeouts]
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">&#34;io.containerd.timeout.shim.cleanup&#34;</span> = <span style="color:#f1fa8c">&#34;5s&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">&#34;io.containerd.timeout.shim.load&#34;</span> = <span style="color:#f1fa8c">&#34;5s&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">&#34;io.containerd.timeout.shim.shutdown&#34;</span> = <span style="color:#f1fa8c">&#34;3s&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">&#34;io.containerd.timeout.task.state&#34;</span> = <span style="color:#f1fa8c">&#34;2s&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[ttrpc]
</span></span><span style="display:flex;"><span>  address = <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  gid = <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>  uid = <span style="color:#bd93f9">0</span>
</span></span></code></pre></div><p>这个配置文件比较复杂，我们可以将重点放在其中的 <code>plugins</code> 配置上面，仔细观察我们可以发现每一个顶级配置块的命名都是 <code>plugins.&quot;io.containerd.xxx.vx.xxx&quot;</code> 这种形式，每一个顶级配置块都表示一个插件，其中 <code>io.containerd.xxx.vx</code> 表示插件的类型，<code>vx</code> 后面的 <code>xxx</code> 表示插件的 ID，我们可以通过 <code>ctr</code> 查看插件列表：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ ctr plugin ls
</span></span><span style="display:flex;"><span>ctr plugin ls
</span></span><span style="display:flex;"><span>TYPE                            ID                       PLATFORMS      STATUS
</span></span><span style="display:flex;"><span>io.containerd.content.v1        content                  -              ok
</span></span><span style="display:flex;"><span>io.containerd.snapshotter.v1    aufs                     linux/amd64    ok
</span></span><span style="display:flex;"><span>io.containerd.snapshotter.v1    btrfs                    linux/amd64    skip
</span></span><span style="display:flex;"><span>io.containerd.snapshotter.v1    devmapper                linux/amd64    error
</span></span><span style="display:flex;"><span>io.containerd.snapshotter.v1    native                   linux/amd64    ok
</span></span><span style="display:flex;"><span>io.containerd.snapshotter.v1    overlayfs                linux/amd64    ok
</span></span><span style="display:flex;"><span>io.containerd.snapshotter.v1    zfs                      linux/amd64    skip
</span></span><span style="display:flex;"><span>io.containerd.metadata.v1       bolt                     -              ok
</span></span><span style="display:flex;"><span>io.containerd.differ.v1         walking                  linux/amd64    ok
</span></span><span style="display:flex;"><span>io.containerd.gc.v1             scheduler                -              ok
</span></span><span style="display:flex;"><span>io.containerd.service.v1        introspection-service    -              ok
</span></span><span style="display:flex;"><span>io.containerd.service.v1        containers-service       -              ok
</span></span><span style="display:flex;"><span>io.containerd.service.v1        content-service          -              ok
</span></span><span style="display:flex;"><span>io.containerd.service.v1        diff-service             -              ok
</span></span><span style="display:flex;"><span>io.containerd.service.v1        images-service           -              ok
</span></span><span style="display:flex;"><span>io.containerd.service.v1        leases-service           -              ok
</span></span><span style="display:flex;"><span>io.containerd.service.v1        namespaces-service       -              ok
</span></span><span style="display:flex;"><span>io.containerd.service.v1        snapshots-service        -              ok
</span></span><span style="display:flex;"><span>io.containerd.runtime.v1        linux                    linux/amd64    ok
</span></span><span style="display:flex;"><span>io.containerd.runtime.v2        task                     linux/amd64    ok
</span></span><span style="display:flex;"><span>io.containerd.monitor.v1        cgroups                  linux/amd64    ok
</span></span><span style="display:flex;"><span>io.containerd.service.v1        tasks-service            -              ok
</span></span><span style="display:flex;"><span>io.containerd.internal.v1       restart                  -              ok
</span></span><span style="display:flex;"><span>io.containerd.grpc.v1           containers               -              ok
</span></span><span style="display:flex;"><span>io.containerd.grpc.v1           content                  -              ok
</span></span><span style="display:flex;"><span>io.containerd.grpc.v1           diff                     -              ok
</span></span><span style="display:flex;"><span>io.containerd.grpc.v1           events                   -              ok
</span></span><span style="display:flex;"><span>io.containerd.grpc.v1           healthcheck              -              ok
</span></span><span style="display:flex;"><span>io.containerd.grpc.v1           images                   -              ok
</span></span><span style="display:flex;"><span>io.containerd.grpc.v1           leases                   -              ok
</span></span><span style="display:flex;"><span>io.containerd.grpc.v1           namespaces               -              ok
</span></span><span style="display:flex;"><span>io.containerd.internal.v1       opt                      -              ok
</span></span><span style="display:flex;"><span>io.containerd.grpc.v1           snapshots                -              ok
</span></span><span style="display:flex;"><span>io.containerd.grpc.v1           tasks                    -              ok
</span></span><span style="display:flex;"><span>io.containerd.grpc.v1           version                  -              ok
</span></span><span style="display:flex;"><span>io.containerd.grpc.v1           cri                      linux/amd64    ok
</span></span></code></pre></div><p>顶级配置块下面的子配置块表示该插件的各种配置，比如 cri 插件下面就分为 containerd、cni 和 registry 的配置，而 containerd 下面又可以配置各种 runtime，还可以配置默认的 runtime。比如现在我们要为镜像配置一个加速器，那么就需要在 cri 配置块下面的 <code>registry</code> 配置块下面进行配置 <code>registry.mirrors</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span>[plugins.<span style="color:#f1fa8c">&#34;io.containerd.grpc.v1.cri&#34;</span>.registry]
</span></span><span style="display:flex;"><span>  [plugins.<span style="color:#f1fa8c">&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.mirrors]
</span></span><span style="display:flex;"><span>    [plugins.<span style="color:#f1fa8c">&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.mirrors.<span style="color:#f1fa8c">&#34;docker.io&#34;</span>]
</span></span><span style="display:flex;"><span>      endpoint = [<span style="color:#f1fa8c">&#34;https://bqr1dr1n.mirror.aliyuncs.com&#34;</span>]
</span></span><span style="display:flex;"><span>    [plugins.<span style="color:#f1fa8c">&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.mirrors.<span style="color:#f1fa8c">&#34;k8s.gcr.io&#34;</span>]
</span></span><span style="display:flex;"><span>      endpoint = [<span style="color:#f1fa8c">&#34;https://registry.aliyuncs.com/k8sxio&#34;</span>]
</span></span></code></pre></div><ul>
<li><code>registry.mirrors.&quot;xxx&quot;</code>: 表示需要配置 mirror 的镜像仓库，例如 <code>registry.mirrors.&quot;docker.io&quot;</code> 表示配置 docker.io 的 mirror。</li>
<li><code>endpoint</code>: 表示提供 mirror 的镜像加速服务，比如我们可以注册一个阿里云的镜像服务来作为 docker.io 的 mirror。</li>
</ul>
<p>另外在默认配置中还有两个关于存储的配置路径：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span>root = <span style="color:#f1fa8c">&#34;/var/lib/containerd&#34;</span>
</span></span><span style="display:flex;"><span>state = <span style="color:#f1fa8c">&#34;/run/containerd&#34;</span>
</span></span></code></pre></div><p>其中 <code>root</code> 是用来保存持久化数据，包括 Snapshots, Content, Metadata 以及各种插件的数据，每一个插件都有自己单独的目录，Containerd 本身不存储任何数据，它的所有功能都来自于已加载的插件。</p>
<!-- raw HTML omitted -->
<p>而另外的 <code>state</code> 是用来保存运行时的临时数据的，包括 sockets、pid、挂载点、运行时状态以及不需要持久化的插件数据。</p>
<h3 id="使用">使用</h3>
<p>我们知道 Docker CLI 工具提供了需要增强用户体验的功能，containerd 同样也提供一个对应的 CLI 工具：<code>ctr</code>，不过 ctr 的功能没有 docker 完善，但是关于镜像和容器的基本功能都是有的。接下来我们就先简单介绍下 <code>ctr</code> 的使用。</p>
<p><strong>帮助</strong></p>
<p>直接输入 <code>ctr</code> 命令即可获得所有相关的操作命令使用方式：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ ctr
</span></span><span style="display:flex;"><span>NAME:
</span></span><span style="display:flex;"><span>   ctr -
</span></span><span style="display:flex;"><span>        __
</span></span><span style="display:flex;"><span>  _____/ /______
</span></span><span style="display:flex;"><span> / ___/ __/ ___/
</span></span><span style="display:flex;"><span>/ /__/ /_/ /
</span></span><span style="display:flex;"><span><span style="color:#f1fa8c">\_</span>__/<span style="color:#f1fa8c">\_</span>_/_/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>containerd CLI
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>USAGE:
</span></span><span style="display:flex;"><span>   ctr <span style="color:#ff79c6">[</span>global options<span style="color:#ff79c6">]</span> <span style="color:#8be9fd;font-style:italic">command</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">command</span> options<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">[</span>arguments...<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERSION:
</span></span><span style="display:flex;"><span>   v1.5.5
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DESCRIPTION:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ctr is an unsupported debug and administrative client <span style="color:#ff79c6">for</span> interacting
</span></span><span style="display:flex;"><span>with the containerd daemon. Because it is unsupported, the commands,
</span></span><span style="display:flex;"><span>options, and operations are not guaranteed to be backward compatible or
</span></span><span style="display:flex;"><span>stable from release to release of the containerd project.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>COMMANDS:
</span></span><span style="display:flex;"><span>   plugins, plugin            provides information about containerd plugins
</span></span><span style="display:flex;"><span>   version                    print the client and server versions
</span></span><span style="display:flex;"><span>   containers, c, container   manage containers
</span></span><span style="display:flex;"><span>   content                    manage content
</span></span><span style="display:flex;"><span>   events, event              display containerd events
</span></span><span style="display:flex;"><span>   images, image, i           manage images
</span></span><span style="display:flex;"><span>   leases                     manage leases
</span></span><span style="display:flex;"><span>   namespaces, namespace, ns  manage namespaces
</span></span><span style="display:flex;"><span>   pprof                      provide golang pprof outputs <span style="color:#ff79c6">for</span> containerd
</span></span><span style="display:flex;"><span>   run                        run a container
</span></span><span style="display:flex;"><span>   snapshots, snapshot        manage snapshots
</span></span><span style="display:flex;"><span>   tasks, t, task             manage tasks
</span></span><span style="display:flex;"><span>   install                    install a new package
</span></span><span style="display:flex;"><span>   oci                        OCI tools
</span></span><span style="display:flex;"><span>   shim                       interact with a shim directly
</span></span><span style="display:flex;"><span>   help, h                    Shows a list of commands or <span style="color:#8be9fd;font-style:italic">help</span> <span style="color:#ff79c6">for</span> one <span style="color:#8be9fd;font-style:italic">command</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>GLOBAL OPTIONS:
</span></span><span style="display:flex;"><span>   --debug                      <span style="color:#8be9fd;font-style:italic">enable</span> debug output in logs
</span></span><span style="display:flex;"><span>   --address value, -a value    address <span style="color:#ff79c6">for</span> containerd&#39;s GRPC server <span style="color:#ff79c6">(</span>default: <span style="color:#f1fa8c">&#34;/run/containerd/containerd.sock&#34;</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">$CONTAINERD_ADDRESS</span><span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>   --timeout value              total timeout <span style="color:#ff79c6">for</span> ctr commands <span style="color:#ff79c6">(</span>default: 0s<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>   --connect-timeout value      timeout <span style="color:#ff79c6">for</span> connecting to containerd <span style="color:#ff79c6">(</span>default: 0s<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>   --namespace value, -n value  namespace to use with commands <span style="color:#ff79c6">(</span>default: <span style="color:#f1fa8c">&#34;default&#34;</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">$CONTAINERD_NAMESPACE</span><span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>   --help, -h                   show <span style="color:#8be9fd;font-style:italic">help</span>
</span></span><span style="display:flex;"><span>   --version, -v                print the version
</span></span></code></pre></div><h4 id="镜像操作">镜像操作</h4>
<p><strong>拉取镜像</strong></p>
<p>拉取镜像可以使用 <code>ctr image pull</code> 来完成，比如拉取 Docker Hub 官方镜像 <code>nginx:alpine</code>，需要注意的是镜像地址需要加上 <code>docker.io</code> Host 地址：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ ctr image pull docker.io/library/nginx:alpine
</span></span><span style="display:flex;"><span>docker.io/library/nginx:alpine:                                                   resolved       |++++++++++++++++++++++++++++++++++++++|
</span></span><span style="display:flex;"><span>index-sha256:bead42240255ae1485653a956ef41c9e458eb077fcb6dc664cbc3aa9701a05ce:    exists         |++++++++++++++++++++++++++++++++++++++|
</span></span><span style="display:flex;"><span>manifest-sha256:ce6ca11a3fa7e0e6b44813901e3289212fc2f327ee8b1366176666e8fb470f24: <span style="color:#ff79c6">done</span>           |++++++++++++++++++++++++++++++++++++++|
</span></span><span style="display:flex;"><span>layer-sha256:9a6ac07b84eb50935293bb185d0a8696d03247f74fd7d43ea6161dc0f293f81f:    <span style="color:#ff79c6">done</span>           |++++++++++++++++++++++++++++++++++++++|
</span></span><span style="display:flex;"><span>layer-sha256:e82f830de071ebcda58148003698f32205b7970b01c58a197ac60d6bb79241b0:    <span style="color:#ff79c6">done</span>           |++++++++++++++++++++++++++++++++++++++|
</span></span><span style="display:flex;"><span>layer-sha256:d7c9fa7589ae28cd3306b204d5dd9a539612593e35df70f7a1d69ff7548e74cf:    <span style="color:#ff79c6">done</span>           |++++++++++++++++++++++++++++++++++++++|
</span></span><span style="display:flex;"><span>layer-sha256:bf2b3ee132db5b4c65432e53aca69da4e609c6cb154e0d0e14b2b02259e9c1e3:    <span style="color:#ff79c6">done</span>           |++++++++++++++++++++++++++++++++++++++|
</span></span><span style="display:flex;"><span>config-sha256:7ce0143dee376bfd2937b499a46fb110bda3c629c195b84b1cf6e19be1a9e23b:   <span style="color:#ff79c6">done</span>           |++++++++++++++++++++++++++++++++++++++|
</span></span><span style="display:flex;"><span>layer-sha256:3c1eaf69ff492177c34bdbf1735b6f2e5400e417f8f11b98b0da878f4ecad5fb:    <span style="color:#ff79c6">done</span>           |++++++++++++++++++++++++++++++++++++++|
</span></span><span style="display:flex;"><span>layer-sha256:29291e31a76a7e560b9b7ad3cada56e8c18d50a96cca8a2573e4f4689d7aca77:    <span style="color:#ff79c6">done</span>           |++++++++++++++++++++++++++++++++++++++|
</span></span><span style="display:flex;"><span>elapsed: 11.9s                                                                    total:  8.7 Mi <span style="color:#ff79c6">(</span>748.1 KiB/s<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>unpacking linux/amd64 sha256:bead42240255ae1485653a956ef41c9e458eb077fcb6dc664cbc3aa9701a05ce...
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">done</span>: 410.86624ms
</span></span></code></pre></div><p>也可以使用 <code>--platform</code> 选项指定对应平台的镜像。当然对应的也有推送镜像的命令 <code>ctr image push</code>，如果是私有镜像则在推送的时候可以通过 <code>--user</code> 来自定义仓库的用户名和密码。</p>
<p><strong>列出本地镜像</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ ctr image ls
</span></span><span style="display:flex;"><span>REF                            TYPE                                                      DIGEST                                                                  SIZE    PLATFORMS                                                                                LABELS
</span></span><span style="display:flex;"><span>docker.io/library/nginx:alpine application/vnd.docker.distribution.manifest.list.v2+json sha256:bead42240255ae1485653a956ef41c9e458eb077fcb6dc664cbc3aa9701a05ce 9.5 MiB linux/386,linux/amd64,linux/arm/v6,linux/arm/v7,linux/arm64/v8,linux/ppc64le,linux/s390x -
</span></span><span style="display:flex;"><span>➜  ~ ctr image ls -q
</span></span><span style="display:flex;"><span>docker.io/library/nginx:alpine
</span></span></code></pre></div><p>使用 <code>-q（--quiet）</code> 选项可以只打印镜像名称。</p>
<p><strong>检测本地镜像</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ ctr image check
</span></span><span style="display:flex;"><span>REF                            TYPE                                                      DIGEST                                                                  STATUS         SIZE            UNPACKED
</span></span><span style="display:flex;"><span>docker.io/library/nginx:alpine application/vnd.docker.distribution.manifest.list.v2+json sha256:bead42240255ae1485653a956ef41c9e458eb077fcb6dc664cbc3aa9701a05ce <span style="color:#8be9fd;font-style:italic">complete</span> <span style="color:#ff79c6">(</span>7/7<span style="color:#ff79c6">)</span> 9.5 MiB/9.5 MiB <span style="color:#8be9fd;font-style:italic">true</span>
</span></span></code></pre></div><p>主要查看其中的 <code>STATUS</code>，<code>complete</code> 表示镜像是完整可用的状态。</p>
<p><strong>重新打标签</strong></p>
<p>同样的我们也可以重新给指定的镜像打一个 Tag：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ ctr image tag docker.io/library/nginx:alpine harbor.k8s.local/course/nginx:alpine
</span></span><span style="display:flex;"><span>harbor.k8s.local/course/nginx:alpine
</span></span><span style="display:flex;"><span>➜  ~ ctr image ls -q
</span></span><span style="display:flex;"><span>docker.io/library/nginx:alpine
</span></span><span style="display:flex;"><span>harbor.k8s.local/course/nginx:alpine
</span></span></code></pre></div><p><strong>删除镜像</strong></p>
<p>不需要使用的镜像也可以使用 <code>ctr image rm</code> 进行删除：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ ctr image rm harbor.k8s.local/course/nginx:alpine
</span></span><span style="display:flex;"><span>harbor.k8s.local/course/nginx:alpine
</span></span><span style="display:flex;"><span>➜  ~ ctr image ls -q
</span></span><span style="display:flex;"><span>docker.io/library/nginx:alpine
</span></span></code></pre></div><p>加上 <code>--sync</code> 选项可以同步删除镜像和所有相关的资源。</p>
<p><strong>将镜像挂载到主机目录</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ ctr image mount docker.io/library/nginx:alpine /mnt
</span></span><span style="display:flex;"><span>sha256:c3554b2d61e3c1cffcaba4b4fa7651c644a3354efaafa2f22cb53542f6c600dc
</span></span><span style="display:flex;"><span>/mnt
</span></span><span style="display:flex;"><span>➜  ~ tree -L <span style="color:#bd93f9">1</span> /mnt
</span></span><span style="display:flex;"><span>/mnt
</span></span><span style="display:flex;"><span>├── bin
</span></span><span style="display:flex;"><span>├── dev
</span></span><span style="display:flex;"><span>├── docker-entrypoint.d
</span></span><span style="display:flex;"><span>├── docker-entrypoint.sh
</span></span><span style="display:flex;"><span>├── etc
</span></span><span style="display:flex;"><span>├── home
</span></span><span style="display:flex;"><span>├── lib
</span></span><span style="display:flex;"><span>├── media
</span></span><span style="display:flex;"><span>├── mnt
</span></span><span style="display:flex;"><span>├── opt
</span></span><span style="display:flex;"><span>├── proc
</span></span><span style="display:flex;"><span>├── root
</span></span><span style="display:flex;"><span>├── run
</span></span><span style="display:flex;"><span>├── sbin
</span></span><span style="display:flex;"><span>├── srv
</span></span><span style="display:flex;"><span>├── sys
</span></span><span style="display:flex;"><span>├── tmp
</span></span><span style="display:flex;"><span>├── usr
</span></span><span style="display:flex;"><span>└── var
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">18</span> directories, <span style="color:#bd93f9">1</span> file
</span></span></code></pre></div><p><strong>将镜像从主机目录上卸载</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ ctr image unmount /mnt
</span></span><span style="display:flex;"><span>/mnt
</span></span></code></pre></div><p><strong>将镜像导出为压缩包</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ ctr image <span style="color:#8be9fd;font-style:italic">export</span> nginx.tar.gz docker.io/library/nginx:alpine
</span></span></code></pre></div><p><strong>从压缩包导入镜像</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ ctr image import nginx.tar.gz
</span></span></code></pre></div><h4 id="容器操作">容器操作</h4>
<p>容器相关操作可以通过 <code>ctr container</code> 获取。</p>
<p><strong>创建容器</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ ctr container create docker.io/library/nginx:alpine nginx
</span></span></code></pre></div><p><strong>列出容器</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ ctr container ls
</span></span><span style="display:flex;"><span>CONTAINER    IMAGE                             RUNTIME
</span></span><span style="display:flex;"><span>nginx        docker.io/library/nginx:alpine    io.containerd.runc.v2
</span></span></code></pre></div><p>同样可以加上 <code>-q</code> 选项精简列表内容：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ ctr container ls -q
</span></span><span style="display:flex;"><span>nginx
</span></span></code></pre></div><p><strong>查看容器详细配置</strong></p>
<p>类似于 <code>docker inspect</code> 功能。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ ctr container info nginx
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;ID&#34;</span>: <span style="color:#f1fa8c">&#34;nginx&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;Labels&#34;</span>: <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;io.containerd.image.config.stop-signal&#34;</span>: <span style="color:#f1fa8c">&#34;SIGQUIT&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;Image&#34;</span>: <span style="color:#f1fa8c">&#34;docker.io/library/nginx:alpine&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;Runtime&#34;</span>: <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;Name&#34;</span>: <span style="color:#f1fa8c">&#34;io.containerd.runc.v2&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;Options&#34;</span>: <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;type_url&#34;</span>: <span style="color:#f1fa8c">&#34;containerd.runc.v1.Options&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;SnapshotKey&#34;</span>: <span style="color:#f1fa8c">&#34;nginx&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;Snapshotter&#34;</span>: <span style="color:#f1fa8c">&#34;overlayfs&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;CreatedAt&#34;</span>: <span style="color:#f1fa8c">&#34;2021-08-12T08:23:13.792871558Z&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;UpdatedAt&#34;</span>: <span style="color:#f1fa8c">&#34;2021-08-12T08:23:13.792871558Z&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;Extensions&#34;</span>: null,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;Spec&#34;</span>: <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>......
</span></span></code></pre></div><p><strong>删除容器</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ ctr container rm nginx
</span></span><span style="display:flex;"><span>➜  ~ ctr container ls
</span></span><span style="display:flex;"><span>CONTAINER    IMAGE    RUNTIME
</span></span></code></pre></div><p>除了使用 <code>rm</code> 子命令之外也可以使用 <code>delete</code> 或者 <code>del</code> 删除容器。</p>
<h4 id="任务">任务</h4>
<p>上面我们通过 <code>container create</code> 命令创建的容器，并没有处于运行状态，只是一个静态的容器。一个 container 对象只是包含了运行一个容器所需的资源及相关配置数据，表示 namespaces、rootfs 和容器的配置都已经初始化成功了，只是用户进程还没有启动。</p>
<p>一个容器真正运行起来是由 Task 任务实现的，Task 可以为容器设置网卡，还可以配置工具来对容器进行监控等。</p>
<p>Task 相关操作可以通过 <code>ctr task</code> 获取，如下我们通过 Task 来启动容器：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ ctr task start -d nginx
</span></span><span style="display:flex;"><span>/docker-entrypoint.sh: /docker-entrypoint.d/ is not empty, will attempt to perform configuration
</span></span><span style="display:flex;"><span>/docker-entrypoint.sh: Looking <span style="color:#ff79c6">for</span> shell scripts in /docker-entrypoint.d/
</span></span></code></pre></div><p>启动容器后可以通过 <code>task ls</code> 查看正在运行的容器：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ ctr task ls
</span></span><span style="display:flex;"><span>TASK     PID     STATUS
</span></span><span style="display:flex;"><span>nginx    <span style="color:#bd93f9">3630</span>    RUNNING
</span></span></code></pre></div><p>同样也可以使用 <code>exec</code> 命令进入容器进行操作：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ ctr task <span style="color:#8be9fd;font-style:italic">exec</span> --exec-id <span style="color:#bd93f9">0</span> -t nginx sh
</span></span><span style="display:flex;"><span>/ <span style="color:#6272a4">#</span>
</span></span></code></pre></div><p>不过这里需要注意必须要指定 <code>--exec-id</code> 参数，这个 id 可以随便写，只要唯一就行。</p>
<p>暂停容器，和 <code>docker pause</code> 类似的功能：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ ctr task pause nginx
</span></span></code></pre></div><p>暂停后容器状态变成了 <code>PAUSED</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ ctr task ls
</span></span><span style="display:flex;"><span>TASK     PID     STATUS
</span></span><span style="display:flex;"><span>nginx    <span style="color:#bd93f9">3630</span>    PAUSED
</span></span></code></pre></div><p>同样也可以使用 <code>resume</code> 命令来恢复容器：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ ctr task resume nginx
</span></span><span style="display:flex;"><span>➜  ~ ctr task ls
</span></span><span style="display:flex;"><span>TASK     PID     STATUS
</span></span><span style="display:flex;"><span>nginx    <span style="color:#bd93f9">3630</span>    RUNNING
</span></span></code></pre></div><p>不过需要注意 ctr 没有 stop 容器的功能，只能暂停或者杀死容器。杀死容器可以使用 <code>task kill</code> 命令:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ ctr task <span style="color:#8be9fd;font-style:italic">kill</span> nginx
</span></span><span style="display:flex;"><span>➜  ~ ctr task ls
</span></span><span style="display:flex;"><span>TASK     PID     STATUS
</span></span><span style="display:flex;"><span>nginx    <span style="color:#bd93f9">3630</span>    STOPPED
</span></span></code></pre></div><p>杀掉容器后可以看到容器的状态变成了 <code>STOPPED</code>。同样也可以通过 <code>task rm</code> 命令删除 Task：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ ctr task rm nginx
</span></span><span style="display:flex;"><span>➜  ~ ctr task ls
</span></span><span style="display:flex;"><span>TASK    PID    STATUS
</span></span></code></pre></div><p>除此之外我们还可以获取容器的 cgroup 相关信息，可以使用 <code>task metrics</code> 命令用来获取容器的内存、CPU 和 PID 的限额与使用量。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#6272a4"># 重新启动容器</span>
</span></span><span style="display:flex;"><span>➜  ~ ctr task metrics nginx
</span></span><span style="display:flex;"><span>ID       TIMESTAMP
</span></span><span style="display:flex;"><span>nginx    2021-08-12 08:50:46.952769941 +0000 UTC
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>METRIC                   VALUE
</span></span><span style="display:flex;"><span>memory.usage_in_bytes    <span style="color:#bd93f9">8855552</span>
</span></span><span style="display:flex;"><span>memory.limit_in_bytes    <span style="color:#bd93f9">9223372036854771712</span>
</span></span><span style="display:flex;"><span>memory.stat.cache        <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>cpuacct.usage            <span style="color:#bd93f9">22467106</span>
</span></span><span style="display:flex;"><span>cpuacct.usage_percpu     <span style="color:#ff79c6">[</span><span style="color:#bd93f9">2962708</span> <span style="color:#bd93f9">860891</span> <span style="color:#bd93f9">1163413</span> <span style="color:#bd93f9">1915748</span> <span style="color:#bd93f9">1058868</span> <span style="color:#bd93f9">2888139</span> <span style="color:#bd93f9">6159277</span> 5458062<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>pids.current             <span style="color:#bd93f9">9</span>
</span></span><span style="display:flex;"><span>pids.limit               <span style="color:#bd93f9">0</span>
</span></span></code></pre></div><p>还可以使用 <code>task ps</code> 命令查看容器中所有进程在宿主机中的 PID：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ ctr task ps nginx
</span></span><span style="display:flex;"><span>PID     INFO
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">3984</span>    -
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">4029</span>    -
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">4030</span>    -
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">4031</span>    -
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">4032</span>    -
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">4033</span>    -
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">4034</span>    -
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">4035</span>    -
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">4036</span>    -
</span></span><span style="display:flex;"><span>➜  ~ ctr task ls
</span></span><span style="display:flex;"><span>TASK     PID     STATUS
</span></span><span style="display:flex;"><span>nginx    <span style="color:#bd93f9">3984</span>    RUNNING
</span></span></code></pre></div><p>其中第一个 PID <code>3984</code> 就是我们容器中的 1 号进程。</p>
<h4 id="命名空间">命名空间</h4>
<p>另外 Containerd 中也支持命名空间的概念，比如查看命名空间：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ ctr ns ls
</span></span><span style="display:flex;"><span>NAME    LABELS
</span></span><span style="display:flex;"><span>default
</span></span></code></pre></div><p>如果不指定，ctr 默认使用的是 <code>default</code> 空间。同样也可以使用 <code>ns create</code> 命令创建一个命名空间：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ ctr ns create <span style="color:#8be9fd;font-style:italic">test</span>
</span></span><span style="display:flex;"><span>➜  ~ ctr ns ls
</span></span><span style="display:flex;"><span>NAME    LABELS
</span></span><span style="display:flex;"><span>default
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">test</span>
</span></span></code></pre></div><p>使用 <code>remove</code> 或者 <code>rm</code> 可以删除 namespace：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ ctr ns rm <span style="color:#8be9fd;font-style:italic">test</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">test</span>
</span></span><span style="display:flex;"><span>➜  ~ ctr ns ls
</span></span><span style="display:flex;"><span>NAME    LABELS
</span></span><span style="display:flex;"><span>default
</span></span></code></pre></div><p>有了命名空间后就可以在操作资源的时候指定 namespace，比如查看 test 命名空间的镜像，可以在操作命令后面加上 <code>-n test</code> 选项：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ ctr -n <span style="color:#8be9fd;font-style:italic">test</span> image ls
</span></span><span style="display:flex;"><span>REF TYPE DIGEST SIZE PLATFORMS LABELS
</span></span></code></pre></div><p>我们知道 Docker 其实也是默认调用的 containerd，事实上 Docker 使用的 containerd 下面的命名空间默认是 <code>moby</code>，而不是 <code>default</code>，所以假如我们有用 docker 启动容器，那么我们也可以通过 <code>ctr -n moby</code> 来定位下面的容器：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ ctr -n moby container ls
</span></span></code></pre></div><p>同样 Kubernetes 下使用的 containerd 默认命名空间是 <code>k8s.io</code>，所以我们可以使用 <code>ctr -n k8s.io</code> 来查看 Kubernetes 下面创建的容器。后续我们再介绍如何将 Kubernetes 集群的容器运行时切换到 <code>containerd</code>。</p>
<!-- raw HTML omitted -->

          <h2>微信公众号</h2>
<p>
  扫描下面的二维码关注我们的微信公众帐号，在微信公众帐号中回复◉加群◉即可加入到我们的
  kubernetes 讨论群里面共同学习。
</p>
<img
  src="https://picdn.youdianzhishi.com/images/qrcode.png"
  alt="wechat-account-qrcode"
/>

  
          
            <div class="entry-shang text-center">
    <p>「真诚赞赏，手留余香」</p>
    <button class="zs show-zs btn btn-bred">赞赏</button>
</div>
<div class="zs-modal-bg"></div>
<div class="zs-modal-box">
    <div class="zs-modal-head">
        <button type="button" class="close">×</button>
        <span class="author"><img src="https://www.qikqiak.com/img/avatar.jpeg"/>阳明</span>
        <p class="tip"><i></i><span>请我喝杯咖啡？</span></p>
    </div>
    <div class="zs-modal-body">
        <div class="zs-modal-btns">
            <button class="btn btn-blink" data-num="2">2元</button>
            <button class="btn btn-blink" data-num="5">5元</button>
            <button class="btn btn-blink" data-num="10">10元</button>
            <button class="btn btn-blink" data-num="50">50元</button>
            <button class="btn btn-blink" data-num="100">100元</button>
            <button class="btn btn-blink" data-num="1">任意金额</button>
        </div>
        <div class="zs-modal-pay">
            <button class="btn btn-bred" id="pay-text">2元</button>
            <p>使用<span id="pay-type">微信</span>扫描二维码完成支付</p>
            <img src="https://www.qikqiak.com/img/wechat-2.png" id="pay-image"/>
        </div>
    </div>
    <div class="zs-modal-footer">
        <span class="zs-wechat"><img src="https://www.qikqiak.com/img/wechat-btn.png"/></span>
    </div>
</div>
          
          
            <div class="social-share" data-initialized="true" style="margin-bottom: 20px;margin-top:20px;">
    <center>
    <a href="#" class="social-share-icon icon-weibo"></a>
    <a href="#" class="social-share-icon icon-wechat"></a>
    <a href="#" class="social-share-icon icon-twitter"></a>
    <a href="#" class="social-share-icon icon-linkedin"></a>
    <a href="#" class="social-share-icon icon-facebook"></a>
    <a href="#" class="social-share-icon icon-qq"></a>
    <a href="#" class="social-share-icon icon-qzone"></a>
    </center>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>

          
        </article>
  
        
          

<h3>相关文章</h3>
<ul style="margin-bottom: 25px;">
    
    <li><a href="https://www.qikqiak.com/post/what-is-oci-runc-containerd-cri-docker/">名称解释OCI、runc、containerd、Docker、CRI、CRI-O</a></li>
    
    <li><a href="https://www.qikqiak.com/post/k8s-10-secruity-context-settings/">你应该了解的10个 Kubernetes 安全上下文设置[译]</a></li>
    
    <li><a href="https://www.qikqiak.com/post/accelerate-ci-cd-pipelines-with-kind/">使用 KinD 加速 CI/CD 流水线</a></li>
    
    <li><a href="https://www.qikqiak.com/post/speed-up-develop-flow-dockerfile-best-practices/">加速开发流程的 Dockerfile 最佳实践</a></li>
    
    <li><a href="https://www.qikqiak.com/post/get-client-realip/">获取客户端访问真实 IP</a></li>
    
    <li><a href="https://www.qikqiak.com/post/capabilities-on-k8s/">在 Kubernetes 中配置 Container Capabilities</a></li>
    
    <li><a href="https://www.qikqiak.com/post/gitlab-install-on-k8s/">在 Kubernetes 上安装 Gitlab</a></li>
    
    <li><a href="https://www.qikqiak.com/post/harbor-quick-install/">在 Kubernetes 在快速安装 Harbor</a></li>
    
    <li><a href="https://www.qikqiak.com/post/harbor-code-analysis/">Harbor 源码浅析</a></li>
    
    <li><a href="https://www.qikqiak.com/post/dockerfile-best-practice/">Dockerfile 最佳实践</a></li>
    
</ul>

        
  
        
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://www.qikqiak.com/post/use-kube-vip-ha-k8s-lb/" data-toggle="tooltip" data-placement="top" title="使用 kube-vip 搭建高可用 Kubernetes 集群">&larr; 前一篇</a>
            </li>
          
          
            <li class="next">
              <a href="https://www.qikqiak.com/post/gitlab-ci-docker-layer-cache-for-k8s-executor/" data-toggle="tooltip" data-placement="top" title="Gitlab CI 在 Kubernetes 中的 Docker 缓存">后一篇 &rarr;</a>
            </li>
          
        </ul>
        

        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        
        <ins class="adsbygoogle"
            style="display:block"
            data-ad-client="ca-pub-5376999672787220"
            data-ad-slot="3700507799"
            data-ad-format="auto"
            data-full-width-responsive="true"></ins>
        <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
  
        
    <div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>
    var gitalk = new Gitalk({
        clientID: 'bdb76dbb2e9d0786e350',
        clientSecret: 'b454b2a08013fd0e32013be7a63fa8fcb262b6c4',
        repo: 'blog',
        owner: 'cnych',
        admin: ['cnych'],
        labels: ['gitment'],
        title: '一文搞懂容器运行时 Containerd',
        createIssueManually: true,
        id: 'containerd-usage',      
        distractionFreeMode: true  
    });
    gitalk.render('gitalk-container');
</script>


        
          

        
  
      </div>
    
    
  </div>
</div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          <img src="https://www.qikqiak.com/img/wechatmp.png" alt="k8s技术圈">
          
              <li>
                <a href="mailto:icnych@gmail.com" title="Email me">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
              <li>
                <a href="https://github.com/cnych" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
              <li>
                <a href="https://weibo.com/cnych" title="微博">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
              <li>
                <a href="https://instagram.com/cnych" title="Instagram">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-instagram fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          
          <li>
            <a href="https://www.qikqiak.com/index.xml" title="RSS">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          

          &nbsp;&bull;&nbsp;
          2023

          
            &nbsp;&bull;&nbsp;
            <a href="https://www.qikqiak.com/">阳明的博客</a>
            &nbsp;&bull;&nbsp;
            <a href="https://www.qikqiak.com/sitemap.xml">网站地图</a>
            &nbsp;&bull;&nbsp;
            <a href="https://www.qikqiak.com/page/archive/">归档</a>
            &nbsp;&bull;&nbsp;
            <a href="https://www.qikqiak.com/page/friend/">友链</a>
            &nbsp;&bull;&nbsp;
            <a href="https://beian.miit.gov.cn/" target="_blank">蜀ICP备11027319号-5</a>
            <a class="h" href="https://www.qikqiak.com/page/kubernetes.io">kubernetes.io</a>
            <a class="h" href="https://www.qikqiak.com/page/kubernetes.org.cn">Kubernetes中文社区</a>
          
        </p>
        <p class="text-center text-muted">
          <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
          <span id="busuanzi_container_site_pv" style="display:none">
            本站总访问量<span id="busuanzi_value_site_pv"></span>次
          </span>
          &nbsp;&bull;&nbsp;
          <span id="busuanzi_container_site_uv" style="display:none">
            访客数<span id="busuanzi_value_site_uv"></span>人次
          </span>
        </p>
        
        <p class="credits theme-by text-muted">
          由 <a href="http://gohugo.io">Hugo v0.115.4</a> 强力驱动 &nbsp;&bull;&nbsp; 主题 <a href="https://github.com/cnych/qikqiak.com">qikqiak-blog</a>
          
        </p>
      </div>
    </div>
  </div>
</footer>


<script src='https://www.qikqiak.com/js/bundle.min.af02a2d23b6651a566f0135a12e65fc2560faa7a969b3d1ad58d0afe0c9164ae.js' integrity='sha256-rwKi0jtmUaVm8BNaEuZfwlYPqnqWmz0a1Y0K/gyRZK4='></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-69668147-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-69668147-3');
</script>
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script >
$(document).ready(function() {
  var int = setInterval(fixCount, 50);  
  
  var initPVCount = 584976;
  var initUVCount = 153191;
  function fixCount() {                   
    if ($("#busuanzi_container_site_pv").css("display") != "none") {
        $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + initPVCount); 
        clearInterval(int); 
    }
    if ($("#busuanzi_container_site_uv").css("display") != "none") {
      $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + initUVCount);
      clearInterval(int); 
    }  
  }           
});
</script>
 <script>(function(w,d, s, id) {if(typeof(w.webpushr)!=='undefined') return;w.webpushr=w.webpushr||function(){(w.webpushr.q=w.webpushr.q||[]).push(arguments)};var js, fjs = d.getElementsByTagName(s)[0];js = d.createElement(s); js.id = id;js.src = "https://cdn.webpushr.com/app.min.js";fjs.parentNode.appendChild(js);}(window,document, 'script', 'webpushr-jssdk'));webpushr('init','BJICPtxnbz-7vq9kEwH5psPCuHe2CvludQug4R2tuJGPF0GQT2hwSWTAhlSt2EFD5InpuQyxCGJdigf6-KbQ53c');</script>
<script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery-migrate@1.2.1/dist/jquery-migrate.min.js"></script>
<script type="text/javascript" src="//cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>
<script type="text/javascript">
$('.carousel').slick({
    dots: true,
    arrows: true,
    autoplay: true,
    autoplaySpeed: 4000,
    infinite: true,
    speed: 500,
    fade: true,
    cssEase: 'linear',
    centerMode: true,
    prevArrow: '<button type="button" class="slick-prev"></button>',
    nextArrow: '<button type="button" class="slick-next"></button>',
});
</script>

  </body>
</html>

