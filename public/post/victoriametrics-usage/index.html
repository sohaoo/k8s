<!DOCTYPE html>
<html lang="zh">
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">


  <title>一文搞懂 VictoriaMetrics 的使用-阳明的博客|Kubernetes|Istio|Prometheus|Python|Golang|云原生</title>
  <meta property="og:title" content="一文搞懂 VictoriaMetrics 的使用" />
  <meta name="twitter:title" content="一文搞懂 VictoriaMetrics 的使用" />

  <meta name="description" content="我们了解了 Prometheus 的使用，了解了基本的 PromQL 语句以及结合 Grafana 来进行监控图表展示，通过 Alertmanager 来进行报警，这些工具结合起来已经可以帮助我们搭建一套比较完整的监控报警系统了，使用 Kube Prometheus 还可以搭建一站式的 Kubernetes 集群监控体系，但是对于生产环境来说则还有许多需要改进的地方。
单台的 Prometheus 存在单点故障的风险，随着监控规模的扩大，Prometheus 产生的数据量也会非常大，性能和存储都会面临问题。毋庸置疑，我们需要一套高可用的高性能的 Prometheus 集群。">
  <meta property="og:description" content="我们了解了 Prometheus 的使用，了解了基本的 PromQL 语句以及结合 Grafana 来进行监控图表展示，通过 Alertmanager 来进行报警，这些工具结合起来已经可以帮助我们搭建一套比较完整的监控报警系统了，使用 Kube Prometheus 还可以搭建一站式的 Kubernetes 集群监控体系，但是对于生产环境来说则还有许多需要改进的地方。
单台的 Prometheus 存在单点故障的风险，随着监控规模的扩大，Prometheus 产生的数据量也会非常大，性能和存储都会面临问题。毋庸置疑，我们需要一套高可用的高性能的 Prometheus 集群。">
  <meta name="twitter:description" content="我们了解了 Prometheus 的使用，了解了基本的 PromQL 语句以及结合 Grafana 来进行监控图表展示，通过 Alertmanager 来进行报警，这些工具结合起来已经可以帮助我们搭建一套比较完整的监控报警系统了，使用 Kube Prometheus 还可以搭建一站式的 Kubernetes 集群监控体系，但是对于生产环境来说则还有许多需要改进的地方。
单台的 Prometheus …">
  <meta name="author" content=""/>
  <link href="https://picdn.youdianzhishi.com/images/blog-favicon.png" rel="icon" type="image/x-icon" />
  <link rel="apple-touch-icon" href="https://picdn.youdianzhishi.com/images/blog-favicon.png"/>
  <meta property="og:image" content="https://picdn.youdianzhishi.com/images/blog-favicon.png" />
  <meta name="twitter:image" content="https://picdn.youdianzhishi.com/images/blog-favicon.png" />
  <meta name="twitter:card" content="summary" />
  <meta property="og:url" content="https://www.qikqiak.com/post/victoriametrics-usage/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="阳明的博客" />

  <link rel="canonical" href="https://www.qikqiak.com/post/victoriametrics-usage/" />
  <link rel="alternate" href="https://www.qikqiak.com/index.xml" type="application/rss+xml" title="阳明的博客">

  
  
  <link href="https://fonts.googleapis.com/css?family=Lora:400,400i,700%7COpen+Sans:400,700" rel="stylesheet">
  

  <link rel="stylesheet" href='https://www.qikqiak.com/css/bundle.min.a6b62363fe57848ad01efa2a5d1bbb1047c2ffb71b53d8aeb42bc5ed5c77ea7c.css' integrity='sha256-prYjY/5XhIrQHvoqXRu7EEfC/7cbU9iutCvF7Vx36nw='>

  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css"/>
  
  
    
    <!--[if lt IE 9]>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js"></script>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <![endif]-->
<meta name="google-site-verification" content="oKxX4fOvB2yYmU02txZFChM93XQbESU4JaG3tNH9Hm8" />
<meta name="baidu-site-verification" content="F5ojAyqaKU" />
<meta name="keywords" content="prometheus, 高可用, kubernetes, VictoriaMetrics, 生产环境">
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d611849735f187dd788dc054908f7d7a";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-69668147-3', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>

  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">切换导航</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://www.qikqiak.com/" title="阳明的博客">
        <img src="https://picdn.youdianzhishi.com/images/blog-logo-new.png" style="margin-top: -5px;height: 32px;" alt="阳明的博客">
      </a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="首页" href="https://www.qikqiak.com/">首页</a>
            </li>
          
        
          
            <li>
              <a title="课程" href="https://youdianzhishi.com/?utm_source=blog&amp;utm_campaign=referral&amp;utm_medium=topmenu">课程</a>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">文章分类</a>
              <div class="navlinks-children">
                
                  <a href="https://www.qikqiak.com/archives">Archive</a>
                
                  <a href="https://www.qikqiak.com/tags">tags</a>
                
                  <a href="https://www.qikqiak.com/tags/kubernetes">kubernetes</a>
                
                  <a href="https://www.qikqiak.com/tags/python">python</a>
                
                  <a href="https://www.qikqiak.com/tags/django">django</a>
                
                  <a href="https://www.qikqiak.com/tags/devops">devops</a>
                
              </div>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">书籍</a>
              <div class="navlinks-children">
                
                  <a href="https://www.qikqiak.com/k8s-book/">k8s进阶手册</a>
                
                  <a href="https://www.qikqiak.com/istio-book/">一起学istio</a>
                
                  <a href="https://www.qikqiak.com/tdd-book/">Python微服务</a>
                
                  <a href="https://md.qikqiak.com/">Markdown微信</a>
                
              </div>
            </li>
          
        
          
            <li>
              <a title="关于" href="https://www.qikqiak.com/page/about/">关于</a>
            </li>
          
        
          
            <li>
              <a title="RSS" href="https://www.qikqiak.com/index.xml">RSS</a>
            </li>
          
        

        

        

        
          <li>
            <a href="#modalSearch" data-toggle="modal" data-target="#modalSearch" style="outline: none;">
              <span id="searchGlyph" class="glyphicon glyphicon-search"></span>
            </a>
          </li>
          

      </ul>
    </div>

  </div>
</nav>


  <div id="modalSearch" class="modal fade" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">搜索</h4>
        </div>
        <div class="modal-body">
            
<div class="aa-input-container" id="aa-input-container">
    <input type="search" id="aa-search-input" class="aa-input-search" placeholder="Search for titles or URIs..." name="search" autocomplete="off" />
    <svg class="aa-input-icon" viewBox="654 -372 1664 1664">
        <path d="M1806,332c0-123.3-43.8-228.8-131.5-316.5C1586.8-72.2,1481.3-116,1358-116s-228.8,43.8-316.5,131.5  C953.8,103.2,910,208.7,910,332s43.8,228.8,131.5,316.5C1129.2,736.2,1234.7,780,1358,780s228.8-43.8,316.5-131.5  C1762.2,560.8,1806,455.3,1806,332z M2318,1164c0,34.7-12.7,64.7-38,90s-55.3,38-90,38c-36,0-66-12.7-90-38l-343-342  c-119.3,82.7-252.3,124-399,124c-95.3,0-186.5-18.5-273.5-55.5s-162-87-225-150s-113-138-150-225S654,427.3,654,332  s18.5-186.5,55.5-273.5s87-162,150-225s138-113,225-150S1262.7-372,1358-372s186.5,18.5,273.5,55.5s162,87,225,150s113,138,150,225  S2062,236.7,2062,332c0,146.7-41.3,279.7-124,399l343,343C2305.7,1098.7,2318,1128.7,2318,1164z" />
    </svg>
</div>
<script src="https://www.qikqiak.com/js/algoliasearch.min.js"></script>
<script src="https://www.qikqiak.com/js/autocomplete.min.js"></script>

<script>
var client = algoliasearch("1JDRAS0AZR", "8804ac109158bb3bb60d74ce98fa332f");
var index = client.initIndex('prod_blog');

autocomplete('#aa-search-input',
{ hint: false}, {
    source: autocomplete.sources.hits(index, {hitsPerPage: 5}),
    
    displayKey: 'name',
    
    templates: {
        
        suggestion: function(suggestion) {
            return '<span>' + '<a href="https://www.qikqiak.com/post/' + suggestion.slug + '">' +
            suggestion._highlightResult.title.value + '</a></span>';
        }
    }
});
</script>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">close</button>
        </div>
      </div>
    </div>
  </div>

    
  
  
  




  
    <div id="header-big-imgs" data-num-img=1 data-img-src-1="https://picdn.youdianzhishi.com/images/1690111931596.jpg" data-img-desc-1="victorialmetrics"></div>
  

  <header class="header-section has-img">
    
      <div class="intro-header big-img">
        
        <div class="container">
          <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
              <div class="post-heading">
                <h1>一文搞懂 VictoriaMetrics 的使用</h1>
                  
                  
                    <span class="post-meta">
  发表于 July 23, 2023  
</span>

                  
              </div>
            </div>
          </div>
        </div>
        <span class="img-desc" style="display: inline;"></span>
      </div>
    
    
    
    <div class="intro-header no-img">
      
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              <h1>一文搞懂 VictoriaMetrics 的使用</h1>
                
                
                  <span class="post-meta">
  发表于 July 23, 2023  
</span>

                
            </div>
          </div>
        </div>
      </div>
    </div>
    
    
  </header>


    



<div class="container" role="main">
  <div class="row">

    
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div>
            
            
            <h5 id="tags" style="margin-top: 30px;">标签:
              
                  <a href="https://www.qikqiak.com/tags/prometheus/">prometheus</a> &nbsp;
              
                  <a href="https://www.qikqiak.com/tags/kubernetes/">kubernetes</a> &nbsp;
              
                  <a href="https://www.qikqiak.com/tags/victoriametrics/">VictoriaMetrics</a> &nbsp;
              
            </h5>
            
        </div>
  
        <article role="main" class="blog-post" itemprop="articleBody" id="content">
          
            
<aside class="toc">
  <nav id="TableOfContents">
  <ul>
    <li><a href="#高可用性">高可用性</a></li>
    <li><a href="#victoriametrics-简介">VictoriaMetrics 简介</a></li>
    <li><a href="#架构">架构</a></li>
    <li><a href="#单节点">单节点</a>
      <ul>
        <li><a href="#远程存储-victoriametrics">远程存储 VictoriaMetrics</a></li>
        <li><a href="#替换-prometheus">替换 Prometheus</a></li>
        <li><a href="#ui-界面">UI 界面</a></li>
      </ul>
    </li>
    <li><a href="#集群版">集群版</a></li>
    <li><a href="#vmagent">vmagent</a></li>
    <li><a href="#vmalert">vmalert</a>
      <ul>
        <li><a href="#特性">特性</a></li>
        <li><a href="#安装">安装</a></li>
      </ul>
    </li>
    <li><a href="#victoriametrics-operator">VictoriaMetrics Operator</a>
      <ul>
        <li><a href="#安装-1">安装</a></li>
        <li><a href="#安装-vm-集群">安装 VM 集群</a></li>
        <li><a href="#验证-vm-集群">验证 VM 集群</a></li>
      </ul>
    </li>
  </ul>
</nav>
</aside>

          
  
          
          
          
  
          
          
          
  
          
          
          

          <p>我们了解了 Prometheus 的使用，了解了基本的 PromQL 语句以及结合 Grafana 来进行监控图表展示，通过 Alertmanager 来进行报警，这些工具结合起来已经可以帮助我们搭建一套比较完整的监控报警系统了，使用 Kube Prometheus 还可以搭建一站式的 Kubernetes 集群监控体系，但是对于生产环境来说则还有许多需要改进的地方。</p>
<p>单台的 Prometheus 存在单点故障的风险，随着监控规模的扩大，Prometheus 产生的数据量也会非常大，性能和存储都会面临问题。毋庸置疑，我们需要一套高可用的高性能的 Prometheus 集群。</p>
<h2 id="高可用性">高可用性</h2>
<p>我们知道 Prometheus 是采用的 Pull 机制获取监控数据，即使使用 <code>Push Gateway</code> 对于 Prometheus 也是 Pull，为了确保 Prometheus 服务的可用性，我们只需要部署多个 Prometheus 实例，然后采集相同的 metrics 数据即可，如下图所示：</p>
<p><img src="https://picdn.youdianzhishi.com/images/prometheus-ha1.png" alt="prometheus ha1"></p>
<p>这个方式来满足服务的可用性应该是平时我们使用得最多的一种方式，当一个实例挂掉后从 LB 里面自动剔除掉，而且还有负载均衡的作用，可以降低一个 Prometheus 的压力，但这种模式缺点也是非常明显的，就是不满足数据一致性以及持久化问题，因为 Prometheus 是 Pull 的方式，即使多个实例抓取的是相同的监控指标，也不能保证抓取过来的值就是一致的，更何况在实际的使用过程中还会遇到一些网络延迟问题，所以会造成数据不一致的问题，不过对于监控报警这个场景来说，一般也不会要求数据强一致性，所以这种方式从业务上来说是可以接受的，因为这种数据不一致性影响基本上没什么影响。这种场景适合监控规模不大，只需要保存短周期监控数据的场景。</p>
<p><strong>数据持久化</strong></p>
<p>使用上面的基本 HA 的模式基本上是可以满足监控这个场景，但是还有一个数据持久化的问题，如果其中一个实例数据丢了就没办法呢恢复回来了，这个时候我们就可以为 Prometheus 添加远程存储来保证数据持久化。</p>
<p><img src="https://picdn.youdianzhishi.com/images/prometheus-ha2.png" alt="prometheus ha2"></p>
<p>在给 Prometheus 配置上远程存储过后，我们就不用担心数据丢失的问题了，即使当一个 Prometheus 实例宕机或者数据丢失过后，也可以通过远程存储的数据进行恢复。</p>
<p><strong>通过锁获取 Leader</strong></p>
<p>其实上面的基本 HA 加上远程存储的方式基本上可以满足 Prometheus 的高可用了，这种方式的多个 Prometheus 实例都会去定时拉取监控指标数据，然后将热数据存储在本地，然后冷数据同步到远程存储中去，对于大型集群来说频繁的去拉取指标数据势必会对网络造成更大的压力。所以我们也通过服务注册的方式来实现 Prometheus 的高可用性，集群启动的时候每个节点都尝试去获取锁，获取成功的节点成为 Leader 执行任务，若主节点宕机，从节点获取锁成为 Leader 并接管服务。</p>
<p><img src="https://picdn.youdianzhishi.com/images/prometheus-ha3.png" alt="prometheus ha3"></p>
<p>不过这种方案需要我们通过去写代码进行改造，如果在 Kubernetes 中我们完全可以使用自带的 Lease 对象来获取分布式锁 🔒，这不是很困难，只是以后要更新版本稍微麻烦点。</p>
<p>上面的几种方案基本上都可以满足基本的 Prometheus 高可用，但是对于大型集群来说，一个 Prometheus 实例的压力始终非常大。</p>
<p><strong>联邦集群</strong></p>
<p>当单个 Prometheus 实例无法处理大量的采集任务时，这个时候我们就可以使用基于 Prometheus 联邦集群的方式来将监控任务划分到不同的 Prometheus 实例中去。</p>
<p><img src="https://picdn.youdianzhishi.com/images/prometheus-ha4.png" alt="prometheus ha4"></p>
<p>我们可以将不同类型的采集任务划分到不同的 Prometheus 实例中去执行，进行功能分片，比如一个 Prometheus 负责采集节点的指标数据，另外一个 Prometheus 负责采集应用业务相关的监控指标数据，最后在上层通过一个 Prometheus 对数据进行汇总。</p>
<p>具体的采集任务如何去进行分区也没有固定的标准，需要结合实际的业务进行考虑，除了上面的方式之外，还有一种情况就是单个的采集数据量就非常非常大，比如我们要采集上万个节点的监控指标数据，这种情况即使我们已经进行了分区，但是对于单个 Prometheus 来说压力也是非常大的，这个时候我们就需要按照任务的不同实例进行划分，我们通过 Prometheus 的 <code>relabel</code> 功能，通过 hash 取模的方式可以确保当前 Prometheus 只采集当前任务的一部分实例的监控指标。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># 省略其他配置......</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">relabel_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff79c6">source_labels</span>: [__address__]
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">modulus</span>: <span style="color:#bd93f9">4</span> <span style="color:#6272a4"># 将节点分片成 4 个组</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">target_label</span>: __tmp_hash
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">action</span>: hashmod
</span></span><span style="display:flex;"><span>  - <span style="color:#ff79c6">source_labels</span>: [__tmp_hash]
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">regex</span>: ^1$ <span style="color:#6272a4"># 只抓第2个组中节点的数据(序号0为第1个组)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">action</span>: keep
</span></span></code></pre></div><p>到这里我们基本上就完成了 Prometheus 高可用的改造。对于小规模集群和大规模集群可以采用不同的方案，但是其中有一个非常重要的部分就是远程存储，我们需要保证数据的持久化就必须使用远程存储。所以下面我们将重点介绍下远程存储的方案，目前比较流行的方案包括 <code>Thanos</code>、<code>VictoriaMetrics</code> 等。</p>
<ul>
<li><a href="https://thanos.io/">Thanos</a>，它完全兼容 Prometheus API，提供统一查询聚合分布式部署 Prometheus 数据的能力，同时也支持数据长期存储到各种对象存储（比如 S3、阿里云 OSS 等）以及降低采样率来加速大时间范围的数据查询。</li>
<li><a href="https://victoriametrics.com/">VictoriaMetrics(VM)</a> 是一个支持高可用、经济高效且可扩展的监控解决方案和时间序列数据库，可用于 Prometheus 监控数据做长期远程存储。</li>
</ul>
<p><code>Thanos</code> 在前面几期我们都讲解过，但是 <code>Thanos</code> 作为一个完整的解决方案，它的架构非常复杂，作为生产环境来说调优极其困难，所以这里我们就不再介绍了，下面我们主要介绍下 <code>VictoriaMetrics</code>。</p>
<h2 id="victoriametrics-简介">VictoriaMetrics 简介</h2>
<p>为什么我们要使用 VictoriaMetrics 呢？相对于 Thanos，VictoriaMetrics 主要是一个可水平扩容的<strong>本地全量持久化存储方案</strong>，VictoriaMetrics 不仅仅是时序数据库，它的优势主要体现在一下几点。</p>
<ul>
<li>
<p>对外支持 Prometheus 相关的 API，可以直接用于 Grafana 作为 Prometheus 数据源使用</p>
</li>
<li>
<p>指标数据摄取和查询具备高性能和良好的可扩展性，性能比 InfluxDB 和 TimescaleDB 高出 20 倍</p>
</li>
<li>
<p>在处理高基数时间序列时，内存方面也做了优化，比 InfluxDB 少 10x 倍，比 Prometheus、Thanos 或 Cortex 少 7 倍</p>
</li>
<li>
<p>高性能的数据压缩方式，与 TimescaleDB 相比，可以将多达 70 倍的数据点存入有限的存储空间，与 Prometheus、Thanos 或 Cortex 相比，所需的存储空间减少 7 倍</p>
</li>
<li>
<p>它针对具有高延迟 IO 和低 IOPS 的存储进行了优化</p>
</li>
<li>
<p>提供全局的查询视图，多个 Prometheus 实例或任何其他数据源可能会将数据摄取到 VictoriaMetrics</p>
</li>
<li>
<p>操作简单</p>
<ul>
<li>VictoriaMetrics 由一个没有外部依赖的小型可执行文件组成</li>
<li>所有的配置都是通过明确的命令行标志和合理的默认值完成的</li>
<li>所有数据都存储在 <code>--storageDataPath</code> 命令行参数指向的目录中</li>
<li>可以使用 <code>vmbackup/vmrestore</code> 工具轻松快速地从实时快照备份到 S3 或 GCS 对象存储中</li>
</ul>
</li>
<li>
<p>支持从第三方时序数据库获取数据源</p>
</li>
<li>
<p>由于存储架构，它可以保护存储在非正常关机（即 OOM、硬件重置或 kill -9）时免受数据损坏</p>
</li>
<li>
<p>同样支持指标的 relabel 操作</p>
</li>
</ul>
<h2 id="架构">架构</h2>
<p>VM 分为单节点和集群两个方案，根据业务需求选择即可。单节点版直接运行一个二进制文件既，官方建议采集数据点(data points)低于 100w/s，推荐 VM 单节点版，简单好维护，但不支持告警。集群版支持数据水平拆分。下图是 <code>VictoriaMetrics</code> 集群版官方的架构图。</p>
<p><img src="https://picdn.youdianzhishi.com/images/1650529246872.jpg" alt="VM官方架构"></p>
<p>主要包含以下几个组件：</p>
<ul>
<li><code>vmstorage</code>：数据存储以及查询结果返回，默认端口为 8482</li>
<li><code>vminsert</code>：数据录入，可实现类似分片、副本功能，默认端口 8480</li>
<li><code>vmselect</code>：数据查询，汇总和数据去重，默认端口 8481</li>
<li><code>vmagent</code>：数据指标抓取，支持多种后端存储，会占用本地磁盘缓存，默认端口 8429</li>
<li><code>vmalert</code>：报警相关组件，不如果不需要告警功能可以不使用该组件，默认端口为 8880</li>
</ul>
<p>集群方案把功能拆分为 <code>vmstorage</code>、<code>vminsert</code>、<code>vmselect</code> 组件，如果要替换 Prometheus，还需要使用 <code>vmagent</code>、<code>vmalert</code>。从上图也可以看出 <code>vminsert</code> 以及 <code>vmselect</code> 都是无状态的，所以扩展很简单，只有 <code>vmstorage</code> 是有状态的。</p>
<p><code>vmagent</code> 的主要目的是用来收集指标数据然后存储到 VM 以及 Prometheus 兼容的存储系统中（支持 remote_write 协议即可）。</p>
<!-- raw HTML omitted -->
<p>下图是 vmagent 的一个简单架构图，可以看出该组件也实现了 metrics 的 push 功能，此外还有很多其他特性：</p>
<ul>
<li>替换 prometheus 的 scraping target</li>
<li>支持基于 prometheus relabeling 的模式添加、移除、修改 labels，可以方便在数据发送到远端存储之前进行数据的过滤</li>
<li>支持多种数据协议，influx line 协议，graphite 文本协议，opentsdb 协议，prometheus remote write 协议，json lines 协议，csv 数据</li>
<li>支持收集数据的同时，并复制到多种远端存储系统</li>
<li>支持不可靠远端存储（通过本地存储 <code>-remoteWrite.tmpDataPath</code> )，同时支持最大磁盘占用</li>
<li>相比 prometheus 使用较少的内存、cpu、磁盘 io 以及网络带宽</li>
</ul>
<p><img src="https://picdn.youdianzhishi.com/images/1650529595671.jpg" alt="vmagent"></p>
<p>接下来我们就分别来介绍了 VM 的单节点和集群两个方案的使用。</p>
<h2 id="单节点">单节点</h2>
<p>这里我们采集 node-exporter 为例进行说明，首先使用 Prometheus 采集数据，然后将 Prometheus 数据远程写入 VM 远程存储，由于 VM 提供了 <code>vmagent</code> 组件，最后我们使用 VM 来完全替换 Prometheus，可以使架构更简单、更低的资源占用。</p>
<p>这里我们将所有资源运行在 <code>kube-vm</code> 命名空间之下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>☸ ➜ kubectl create ns kube-vm
</span></span></code></pre></div><p>首先我们这 <code>kube-vm</code> 命名空间下面使用 DaemonSet 控制器运行 node-exporter，对应的资源清单文件如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vm-node-exporter.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: apps/v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: DaemonSet
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app.kubernetes.io/component</span>: exporter
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app.kubernetes.io/name</span>: node-exporter
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app.kubernetes.io/part-of</span>: kube-vm
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app.kubernetes.io/version</span>: <span style="color:#bd93f9">1.6.0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: node-exporter
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">app.kubernetes.io/component</span>: exporter
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">app.kubernetes.io/name</span>: node-exporter
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">app.kubernetes.io/part-of</span>: kube-vm
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">app.kubernetes.io/component</span>: exporter
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">app.kubernetes.io/name</span>: node-exporter
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">app.kubernetes.io/part-of</span>: kube-vm
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">args</span>:
</span></span><span style="display:flex;"><span>            - --web.listen-address=$(HOSTIP):9100
</span></span><span style="display:flex;"><span>            - --path.sysfs=/host/sys
</span></span><span style="display:flex;"><span>            - --path.rootfs=/host/root
</span></span><span style="display:flex;"><span>            - --path.udev.data=/host/root/run/udev/data
</span></span><span style="display:flex;"><span>            - --<span style="color:#ff79c6">no</span>-collector.wifi
</span></span><span style="display:flex;"><span>            - --<span style="color:#ff79c6">no</span>-collector.hwmon
</span></span><span style="display:flex;"><span>            - --<span style="color:#ff79c6">no</span>-collector.btrfs
</span></span><span style="display:flex;"><span>            - --collector.filesystem.mount-points-exclude=^/(dev|proc|sys|run/k3s/containerd/.+|var/lib/docker/.+|var/lib/kubelet/pods/.+)($|/)
</span></span><span style="display:flex;"><span>            - --collector.netclass.ignored-devices=^(veth.*|[a-f0-9]{15})$
</span></span><span style="display:flex;"><span>            - --collector.netdev.device-exclude=^(veth.*|[a-f0-9]{15})$
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">image</span>: quay.io/prometheus/node-exporter:v1.6.0
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">name</span>: node-exporter
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">env</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">name</span>: HOSTIP
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">valueFrom</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">fieldRef</span>:
</span></span><span style="display:flex;"><span>                  <span style="color:#ff79c6">fieldPath</span>: status.hostIP
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">resources</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">limits</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">cpu</span>: 250m
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">memory</span>: 180Mi
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">requests</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">cpu</span>: 102m
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">memory</span>: 180Mi
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">securityContext</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">allowPrivilegeEscalation</span>: <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">capabilities</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">add</span>:
</span></span><span style="display:flex;"><span>                - SYS_TIME
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">drop</span>:
</span></span><span style="display:flex;"><span>                - ALL
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">readOnlyRootFilesystem</span>: <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">volumeMounts</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">mountPath</span>: /host/sys
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">mountPropagation</span>: HostToContainer
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: sys
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">readOnly</span>: <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">mountPath</span>: /host/root
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">mountPropagation</span>: HostToContainer
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: root
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">readOnly</span>: <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">hostNetwork</span>: <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">hostPID</span>: <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">nodeSelector</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">kubernetes.io/os</span>: linux
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">priorityClassName</span>: system-cluster-critical
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">securityContext</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">runAsNonRoot</span>: <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">runAsUser</span>: <span style="color:#bd93f9">65534</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">tolerations</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">operator</span>: Exists
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">volumes</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">hostPath</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">path</span>: /sys
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">name</span>: sys
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">hostPath</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">path</span>: /
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">name</span>: root
</span></span></code></pre></div><p>直接应用上面的资源清单即可:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>☸ ➜ kubectl apply -f vm-node-exporter.yaml
</span></span><span style="display:flex;"><span>☸ ➜ kubectl get pods -n kube-vm -owide
</span></span><span style="display:flex;"><span>NAME                          READY   STATUS    RESTARTS   AGE     IP             NODE      NOMINATED NODE   READINESS GATES
</span></span><span style="display:flex;"><span>node-exporter-6hch2           1/1     Running   <span style="color:#bd93f9">0</span>          84s     10.206.16.10   node2     &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>node-exporter-d2k6n           1/1     Running   <span style="color:#bd93f9">0</span>          86s     10.206.16.6    master1   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>node-exporter-k2tvj           1/1     Running   <span style="color:#bd93f9">0</span>          82s     10.206.16.5    node1     &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>然后重新部署一套独立的 Prometheus，为了简单我们直接使用 <code>static_configs</code> 静态配置方式来抓取 node-exporter 的指标，配置清单如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vm-prom-config.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: ConfigMap
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: prometheus-config
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">prometheus.yaml</span>: |<span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    global:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      scrape_interval: 15s
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      scrape_timeout: 15s
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    scrape_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    - job_name: &#34;nodes&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      static_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - targets: [&#39;10.206.16.6:9100&#39;, &#39;10.206.16.5:9100&#39;, &#39;10.206.16.10:9100&#39;]
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      relabel_configs: # 通过 relabeling 从 __address__ 中提取 IP 信息，为了后面验证 VM 是否兼容 relabeling
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - source_labels: [__address__]
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        regex: &#34;(.*):(.*)&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        replacement: &#34;${1}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        target_label: &#39;ip&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        action: replace</span>    
</span></span></code></pre></div><p>上面配置中通过 <code>relabel</code> 操作从 <code>__address__</code> 中将 IP 信息提取出来，后面可以用来验证 VM 是否兼容 <code>relabel</code> 操作。</p>
<p>同样要给 Prometheus 数据做持久化，所以也需要创建一个对应的 PVC 资源对象：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vm-prom-pvc.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># apiVersion: storage.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># kind: StorageClass</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># metadata:</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#   name: local-storage</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># provisioner: kubernetes.io/no-provisioner</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># volumeBindingMode: WaitForFirstConsumer</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: PersistentVolume
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: prometheus-data
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">accessModes</span>:
</span></span><span style="display:flex;"><span>    - ReadWriteOnce
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">capacity</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">storage</span>: 20Gi
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">storageClassName</span>: local-storage
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">local</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">path</span>: /data/k8s/prometheus
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">persistentVolumeReclaimPolicy</span>: Retain
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">nodeAffinity</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">required</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">nodeSelectorTerms</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">matchExpressions</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">key</span>: kubernetes.io/hostname
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">operator</span>: In
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">values</span>:
</span></span><span style="display:flex;"><span>                - node2
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: PersistentVolumeClaim
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: prometheus-data
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">accessModes</span>:
</span></span><span style="display:flex;"><span>    - ReadWriteOnce
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">resources</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">requests</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">storage</span>: 20Gi
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">storageClassName</span>: local-storage
</span></span></code></pre></div><p>然后直接创建 Prometheus 即可，将上面的 PVC 和 ConfigMap 挂载到容器中，通过 <code>--config.file</code> 参数指定配置文件文件路径，指定 TSDB 数据路径等，资源清单文件如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vm-prom-deploy.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: apps/v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Deployment
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: prometheus
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">app</span>: prometheus
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">app</span>: prometheus
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">volumes</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: data
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">persistentVolumeClaim</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">claimName</span>: prometheus-data
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: config-volume
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">configMap</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">name</span>: prometheus-config
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">image</span>: prom/prometheus:v2.44.0
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">name</span>: prometheus
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">args</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f1fa8c">&#34;--config.file=/etc/prometheus/prometheus.yaml&#34;</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#f1fa8c">&#34;--storage.tsdb.path=/prometheus&#34;</span> <span style="color:#6272a4"># 指定tsdb数据路径</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#f1fa8c">&#34;--storage.tsdb.retention.time=2d&#34;</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#f1fa8c">&#34;--web.enable-lifecycle&#34;</span> <span style="color:#6272a4"># 支持热更新，直接执行localhost:9090/-/reload立即生效</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">containerPort</span>: <span style="color:#bd93f9">9090</span>
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: http
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">securityContext</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">runAsUser</span>: <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">volumeMounts</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">mountPath</span>: <span style="color:#f1fa8c">&#34;/etc/prometheus&#34;</span>
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: config-volume
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">mountPath</span>: <span style="color:#f1fa8c">&#34;/prometheus&#34;</span>
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: data
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Service
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: prometheus
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: prometheus
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">type</span>: NodePort
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: web
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">9090</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">targetPort</span>: http
</span></span></code></pre></div><p>直接应用上面的资源清单即可。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>☸ ➜ kubectl apply -f vm-prom-config.yaml
</span></span><span style="display:flex;"><span>☸ ➜ kubectl apply -f vm-prom-pvc.yaml
</span></span><span style="display:flex;"><span>☸ ➜ kubectl apply -f vm-prom-deploy.yaml
</span></span><span style="display:flex;"><span>☸ ➜ kubectl get pods -n kube-vm
</span></span><span style="display:flex;"><span>NAME                          READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>node-exporter-6hch2           1/1     Running   <span style="color:#bd93f9">0</span>          101s
</span></span><span style="display:flex;"><span>node-exporter-d2k6n           1/1     Running   <span style="color:#bd93f9">0</span>          103s
</span></span><span style="display:flex;"><span>node-exporter-k2tvj           1/1     Running   <span style="color:#bd93f9">0</span>          99s
</span></span><span style="display:flex;"><span>prometheus-84c5bcd9f9-zmtpf   1/1     Running   <span style="color:#bd93f9">0</span>          3m51s
</span></span><span style="display:flex;"><span>☸ ➜ kubectl get svc -n kube-vm
</span></span><span style="display:flex;"><span>NAME         TYPE       CLUSTER-IP       EXTERNAL-IP   PORT<span style="color:#ff79c6">(</span>S<span style="color:#ff79c6">)</span>          AGE
</span></span><span style="display:flex;"><span>prometheus   NodePort   10.100.210.162   &lt;none&gt;        9090:31233/TCP   28s
</span></span></code></pre></div><p>部署完成后可以通过 <code>http://&lt;node-ip&gt;:31233</code> 访问 Prometheus，正常可以看到采集的 3 个 node 节点的指标任务。</p>
<p><img src="https://picdn.youdianzhishi.com/images/1689665071024.png" alt="nodes targets"></p>
<p>同样的方式重新部署 Grafana，资源清单如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vm-grafana.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: apps/v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Deployment
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: grafana
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">app</span>: grafana
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">app</span>: grafana
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">volumes</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: storage
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">persistentVolumeClaim</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">claimName</span>: grafana-data
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: grafana
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">image</span>: grafana/grafana:10.0.1
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">imagePullPolicy</span>: IfNotPresent
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">containerPort</span>: <span style="color:#bd93f9">3000</span>
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: grafana
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">securityContext</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">runAsUser</span>: <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">env</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">name</span>: GF_SECURITY_ADMIN_USER
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">value</span>: admin
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">name</span>: GF_SECURITY_ADMIN_PASSWORD
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">value</span>: admin321
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">readinessProbe</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">failureThreshold</span>: <span style="color:#bd93f9">10</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">httpGet</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">path</span>: /api/health
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">3000</span>
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">scheme</span>: HTTP
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">periodSeconds</span>: <span style="color:#bd93f9">10</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">successThreshold</span>: <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">timeoutSeconds</span>: <span style="color:#bd93f9">30</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">livenessProbe</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">failureThreshold</span>: <span style="color:#bd93f9">3</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">httpGet</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">path</span>: /api/health
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">3000</span>
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">scheme</span>: HTTP
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">periodSeconds</span>: <span style="color:#bd93f9">10</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">successThreshold</span>: <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">timeoutSeconds</span>: <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">resources</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">limits</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">cpu</span>: 150m
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">memory</span>: 512Mi
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">requests</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">cpu</span>: 150m
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">memory</span>: 512Mi
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">volumeMounts</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">mountPath</span>: /var/lib/grafana
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: storage
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Service
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: grafana
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">type</span>: NodePort
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">3000</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: grafana
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: PersistentVolume
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: grafana-data
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">accessModes</span>:
</span></span><span style="display:flex;"><span>    - ReadWriteOnce
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">capacity</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">storage</span>: 1Gi
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">storageClassName</span>: local-storage
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">local</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">path</span>: /data/k8s/grafana
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">persistentVolumeReclaimPolicy</span>: Retain
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">nodeAffinity</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">required</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">nodeSelectorTerms</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">matchExpressions</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">key</span>: kubernetes.io/hostname
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">operator</span>: In
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">values</span>:
</span></span><span style="display:flex;"><span>                - node2
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: PersistentVolumeClaim
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: grafana-data
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">accessModes</span>:
</span></span><span style="display:flex;"><span>    - ReadWriteOnce
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">resources</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">requests</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">storage</span>: 1Gi
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">storageClassName</span>: local-storage
</span></span></code></pre></div><p>同样直接应用上面的资源清单即可：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>☸ ➜ kubectl apply -f vm-grafana.yaml
</span></span><span style="display:flex;"><span>☸ ➜ kubectl get pods -n kube-vm -l <span style="color:#8be9fd;font-style:italic">app</span><span style="color:#ff79c6">=</span>grafana
</span></span><span style="display:flex;"><span>NAME                       READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>grafana-7f7d7bd89c-ztcqn   1/1     Running   <span style="color:#bd93f9">0</span>          41s
</span></span><span style="display:flex;"><span>☸ ➜ kubectl get svc grafana -n kube-vm
</span></span><span style="display:flex;"><span>NAME      TYPE       CLUSTER-IP       EXTERNAL-IP   PORT<span style="color:#ff79c6">(</span>S<span style="color:#ff79c6">)</span>          AGE
</span></span><span style="display:flex;"><span>grafana   NodePort   10.109.249.118   &lt;none&gt;        3000:32060/TCP   64s
</span></span></code></pre></div><p>同样通过 <code>http://&lt;node-ip&gt;:32060</code> 就可以访问 Grafana 了，进入 Grafana 配置 Prometheus 数据源。</p>
<p><img src="https://picdn.youdianzhishi.com/images/1689665325762.png" alt="Grafana 数据源"></p>
<p>然后导入 <a href="https://grafana.com/grafana/dashboards/16098">16098</a> 这个 Dashboard，导入后效果如下图所示。</p>
<p><img src="https://picdn.youdianzhishi.com/images/1689665438827.jpg" alt="node exporter dashboard"></p>
<p>到这里就完成了使用 Prometheus 收集节点监控指标（和前面学习的知识点没什么区别），接下来我们来使用 VM 来改造现有方案。</p>
<h3 id="远程存储-victoriametrics">远程存储 VictoriaMetrics</h3>
<p>首先需要一个单节点模式的 VictoriaMetrics，运行 VictoriaMetrics 很简单，可以直接下载对应的二进制文件启动，也可以使用 docker 镜像一键启动，我们这里同样部署到 Kubernetes 集群中。资源清单文件如下所示。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vm-single.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: apps/v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Deployment
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: victoria-metrics
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">app</span>: victoria-metrics
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">app</span>: victoria-metrics
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">volumes</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: storage
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">persistentVolumeClaim</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">claimName</span>: victoria-metrics-data
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: vm
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">image</span>: victoriametrics/victoria-metrics:v1.91.3
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">imagePullPolicy</span>: IfNotPresent
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">args</span>:
</span></span><span style="display:flex;"><span>            - -storageDataPath=/var/lib/victoria-metrics-data
</span></span><span style="display:flex;"><span>            - -retentionPeriod=1w
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">containerPort</span>: <span style="color:#bd93f9">8428</span>
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: http
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">volumeMounts</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">mountPath</span>: /var/lib/victoria-metrics-data
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: storage
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Service
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: victoria-metrics
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">type</span>: NodePort
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">8428</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: victoria-metrics
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: PersistentVolume
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: victoria-metrics-data
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">accessModes</span>:
</span></span><span style="display:flex;"><span>    - ReadWriteOnce
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">capacity</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">storage</span>: 20Gi
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">storageClassName</span>: local-storage
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">local</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">path</span>: /data/k8s/vm
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">persistentVolumeReclaimPolicy</span>: Retain
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">nodeAffinity</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">required</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">nodeSelectorTerms</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">matchExpressions</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">key</span>: kubernetes.io/hostname
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">operator</span>: In
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">values</span>:
</span></span><span style="display:flex;"><span>                - node2
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: PersistentVolumeClaim
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: victoria-metrics-data
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">accessModes</span>:
</span></span><span style="display:flex;"><span>    - ReadWriteOnce
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">resources</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">requests</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">storage</span>: 20Gi
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">storageClassName</span>: local-storage
</span></span></code></pre></div><p>这里我们使用 <code>-storageDataPath</code> 参数指定了数据存储目录，然后同样将该目录进行了持久化，<code>-retentionPeriod</code> 参数可以用来配置数据的保存周期。直接应用上面的资源清单即可。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>☸ ➜ kubectl apply -f vm-single.yaml
</span></span><span style="display:flex;"><span>☸ ➜ kubectl get svc victoria-metrics -n kube-vm
</span></span><span style="display:flex;"><span>NAME               TYPE       CLUSTER-IP       EXTERNAL-IP   PORT<span style="color:#ff79c6">(</span>S<span style="color:#ff79c6">)</span>          AGE
</span></span><span style="display:flex;"><span>victoria-metrics   NodePort   10.110.151.187   &lt;none&gt;        8428:30147/TCP   8s
</span></span><span style="display:flex;"><span>☸ ➜ kubectl get pods -n kube-vm -l <span style="color:#8be9fd;font-style:italic">app</span><span style="color:#ff79c6">=</span>victoria-metrics
</span></span><span style="display:flex;"><span>NAME                                READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>victoria-metrics-7c9bcd964c-szq9q   1/1     Running   <span style="color:#bd93f9">0</span>          19s
</span></span><span style="display:flex;"><span>☸ ➜ kubectl logs -f victoria-metrics-7c9bcd964c-szq9q -n kube-vm
</span></span><span style="display:flex;"><span>2023-07-18T07:32:55.697Z        info    VictoriaMetrics/lib/logger/flag.go:12   build version: victoria-metrics-20230630-132641-tags-v1.91.3-0-g7226242070
</span></span><span style="display:flex;"><span>2023-07-18T07:32:55.697Z        info    VictoriaMetrics/lib/logger/flag.go:13   command-line flags
</span></span><span style="display:flex;"><span>2023-07-18T07:32:55.697Z        info    VictoriaMetrics/lib/logger/flag.go:20     -retentionPeriod<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;1w&#34;</span>
</span></span><span style="display:flex;"><span>2023-07-18T07:32:55.697Z        info    VictoriaMetrics/lib/logger/flag.go:20     -storageDataPath<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;/var/lib/victoria-metrics-data&#34;</span>
</span></span><span style="display:flex;"><span>2023-07-18T07:32:55.697Z        info    VictoriaMetrics/app/victoria-metrics/main.go:70 starting VictoriaMetrics at <span style="color:#f1fa8c">&#34;:8428&#34;</span>...
</span></span><span style="display:flex;"><span>2023-07-18T07:32:55.697Z        info    VictoriaMetrics/app/vmstorage/main.go:108       opening storage at <span style="color:#f1fa8c">&#34;/var/lib/victoria-metrics-data&#34;</span> with -retentionPeriod<span style="color:#ff79c6">=</span>1w
</span></span><span style="display:flex;"><span>2023-07-18T07:32:55.699Z        info    VictoriaMetrics/lib/memory/memory.go:42 limiting caches to <span style="color:#bd93f9">4604539699</span> bytes, leaving <span style="color:#bd93f9">3069693133</span> bytes to the OS according to -memory.allowedPercent<span style="color:#ff79c6">=</span><span style="color:#bd93f9">60</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># ......</span>
</span></span><span style="display:flex;"><span>2023-07-18T07:32:55.740Z        info    VictoriaMetrics/lib/httpserver/httpserver.go:96 starting http server at http://127.0.0.1:8428/
</span></span><span style="display:flex;"><span>2023-07-18T07:32:55.740Z        info    VictoriaMetrics/lib/httpserver/httpserver.go:97 pprof handlers are exposed at http://127.0.0.1:8428/debug/pprof/
</span></span></code></pre></div><p>到这里我们单节点的 <code>VictoriaMetrics</code> 就部署成功了。接下来我们只需要在 Prometheus 中配置远程写入我们的 VM 即可，更改 Prometheus 配置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vm-prom-config2.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: ConfigMap
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: prometheus-config
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">prometheus.yaml</span>: |<span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    global:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      scrape_interval: 15s
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      scrape_timeout: 15s
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    remote_write:    # 远程写入到远程 VM 存储
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    - url: http://victoria-metrics:8428/api/v1/write
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    scrape_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    - job_name: &#34;nodes&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      static_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - targets: [&#39;10.206.16.6:9100&#39;, &#39;10.206.16.5:9100&#39;, &#39;10.206.16.10:9100&#39;]
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      relabel_configs: # 通过 relabeling 从 __address__ 中提取 IP 信息，为了后面验证 VM 是否兼容 relabeling
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - source_labels: [__address__]
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        regex: &#34;(.*):(.*)&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        replacement: &#34;${1}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        target_label: &#39;ip&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        action: replace</span>    
</span></span></code></pre></div><p>重新更新 Prometheus 的配置资源对象：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>☸ ➜ kubectl apply -f vm-prom-config2.yaml
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 更新后隔一会儿执行 reload 操作重新加载 prometheus 配置</span>
</span></span><span style="display:flex;"><span>☸ ➜ curl -X POST <span style="color:#f1fa8c">&#34;http://&lt;node ip&gt;:31233/-/reload&#34;</span>
</span></span></code></pre></div><p>配置生效后 Prometheus 就会开始将数据远程写入 VM 中，我们可以查看 VM 的持久化数据目录是否有数据产生来验证：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>☸ ➜ ll /data/k8s/vm/data/
</span></span><span style="display:flex;"><span>total <span style="color:#bd93f9">16</span>
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#bd93f9">4</span> root root <span style="color:#bd93f9">4096</span> Jul <span style="color:#bd93f9">18</span> 15:32 ./
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#bd93f9">7</span> root root <span style="color:#bd93f9">4096</span> Jul <span style="color:#bd93f9">18</span> 15:32 ../
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#bd93f9">4</span> root root <span style="color:#bd93f9">4096</span> Jul <span style="color:#bd93f9">18</span> 15:37 big/
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#bd93f9">1</span> root root    <span style="color:#bd93f9">0</span> Jul <span style="color:#bd93f9">18</span> 15:32 flock.lock
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#bd93f9">4</span> root root <span style="color:#bd93f9">4096</span> Jul <span style="color:#bd93f9">18</span> 15:37 small/
</span></span></code></pre></div><p>现在我们去直接将 Grafana 中的数据源地址修改成 VM 的地址：</p>
<p><img src="https://picdn.youdianzhishi.com/images/1689667605660.png" alt="修改数据源"></p>
<p>修改完成后重新访问 node-exporter 的 dashboard，正常可以显示，证明 VM 是兼容的。</p>
<p><img src="https://picdn.youdianzhishi.com/images/1689667644354.jpg" alt="节点dashboard"></p>
<h3 id="替换-prometheus">替换 Prometheus</h3>
<p>上面我们将 Prometheus 数据远程写入到了 VM，但是 Prometheus 开启 remote write 功能后会增加其本身的资源占用，理论上其实我们也可以完全用 VM 来替换掉 Prometheus，这样就不需要远程写入了，而且本身 VM 就比 Prometheus 占用更少的资源。</p>
<p>现在我们先停掉 Prometheus 的服务：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>☸ ➜ kubectl scale deploy prometheus --replicas<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span> -n kube-vm
</span></span></code></pre></div><p>然后将 Prometheus 的配置文件挂载到 VM 容器中，使用参数 <code>-promscrape.config</code> 来指定 Prometheus 的配置文件路径，如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vm-single2.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: apps/v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Deployment
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: victoria-metrics
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">app</span>: victoria-metrics
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">app</span>: victoria-metrics
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">volumes</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: storage
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">persistentVolumeClaim</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">claimName</span>: victoria-metrics-data
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: prometheus-config
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">configMap</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">name</span>: prometheus-config
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: vm
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">image</span>: victoriametrics/victoria-metrics:v1.91.3
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">imagePullPolicy</span>: IfNotPresent
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">args</span>:
</span></span><span style="display:flex;"><span>            - -storageDataPath=/var/lib/victoria-metrics-data
</span></span><span style="display:flex;"><span>            - -retentionPeriod=1w
</span></span><span style="display:flex;"><span>            - -promscrape.config=/etc/prometheus/prometheus.yaml
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">containerPort</span>: <span style="color:#bd93f9">8428</span>
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: http
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">volumeMounts</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">mountPath</span>: /var/lib/victoria-metrics-data
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: storage
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">mountPath</span>: /etc/prometheus
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: prometheus-config
</span></span></code></pre></div><p>记得先将 Prometheus 配置文件中的 remote_write 模块去掉，然后重新更新 VM 即可：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>☸ ➜ kubectl apply -f vm-prom-config.yaml
</span></span><span style="display:flex;"><span>☸ ➜ kubectl apply -f vm-single2.yaml
</span></span><span style="display:flex;"><span>☸ ➜ kubectl get pods -n kube-vm -l <span style="color:#8be9fd;font-style:italic">app</span><span style="color:#ff79c6">=</span>victoria-metrics
</span></span><span style="display:flex;"><span>NAME                               READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>victoria-metrics-bf45c58cb-k4kdv   1/1     Running   <span style="color:#bd93f9">0</span>          53s
</span></span><span style="display:flex;"><span>☸ ➜ kubectl logs -f victoria-metrics-bf45c58cb-k4kdv -n kube-vm
</span></span><span style="display:flex;"><span>2023-07-18T08:09:52.846Z        info    VictoriaMetrics/lib/logger/flag.go:12   build version: victoria-metrics-20230630-132641-tags-v1.91.3-0-g7226242070
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># ......</span>
</span></span><span style="display:flex;"><span>2023-07-18T08:09:52.928Z        info    VictoriaMetrics/app/victoria-metrics/main.go:80 started VictoriaMetrics in 0.082 seconds
</span></span><span style="display:flex;"><span>2023-07-18T08:09:52.928Z        info    VictoriaMetrics/lib/httpserver/httpserver.go:96 starting http server at http://127.0.0.1:8428/
</span></span><span style="display:flex;"><span>2023-07-18T08:09:52.928Z        info    VictoriaMetrics/lib/httpserver/httpserver.go:97 pprof handlers are exposed at http://127.0.0.1:8428/debug/pprof/
</span></span><span style="display:flex;"><span>2023-07-18T08:09:52.929Z        info    VictoriaMetrics/lib/promscrape/scraper.go:114   reading Prometheus configs from <span style="color:#f1fa8c">&#34;/etc/prometheus/prometheus.yaml&#34;</span>
</span></span><span style="display:flex;"><span>2023-07-18T08:09:52.930Z        info    VictoriaMetrics/lib/promscrape/config.go:122    starting service discovery routines...
</span></span><span style="display:flex;"><span>2023-07-18T08:09:52.930Z        info    VictoriaMetrics/lib/promscrape/config.go:128    started service discovery routines in 0.000 seconds
</span></span><span style="display:flex;"><span>2023-07-18T08:09:52.930Z        info    VictoriaMetrics/lib/promscrape/scraper.go:431   static_configs: added targets: 3, removed targets: 0; total targets: <span style="color:#bd93f9">3</span>
</span></span></code></pre></div><p>从 VM 日志中可以看出成功读取了 Prometheus 的配置，并抓取了 3 个指标（node-exporter）。
现在我们再去 Grafana 查看 node-exporter 的 Dashboard 是否可以正常显示。先保证数据源是 VM 的地址。</p>
<p><img src="https://picdn.youdianzhishi.com/images/1689667950120.png" alt="vm数据源"></p>
<p>这样我们就使用 VM 替换掉了 Prometheus，我们也可以这 Grafana 的 Explore 页面去探索采集到的指标。</p>
<p><img src="https://picdn.youdianzhishi.com/images/1689667976130.jpg" alt="node dashboard"></p>
<h3 id="ui-界面">UI 界面</h3>
<p>VM 单节点版本本身自带了一个 Web UI 界面 - <a href="https://github.com/VictoriaMetrics/VictoriaMetrics/tree/master/app/vmui">vmui</a>，不过目前功能比较简单，可以直接通过 VM 的 NodePort 端口进行访问。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>☸ ➜ kubectl get svc victoria-metrics -n kube-vm
</span></span><span style="display:flex;"><span>NAME               TYPE       CLUSTER-IP       EXTERNAL-IP   PORT<span style="color:#ff79c6">(</span>S<span style="color:#ff79c6">)</span>          AGE
</span></span><span style="display:flex;"><span>victoria-metrics   NodePort   10.110.151.187   &lt;none&gt;        8428:30147/TCP   40m
</span></span></code></pre></div><p>我们这里可以通过 <code>http://&lt;node-ip&gt;:30147</code> 访问到 vmui：</p>
<p><img src="https://picdn.youdianzhishi.com/images/1689668032720.png" alt="vmui"></p>
<p>可以通过 <code>/vmui</code> 这个 endpoint 访问 UI 界面：</p>
<p><img src="https://picdn.youdianzhishi.com/images/1689668109076.jpg" alt="vmui web ui"></p>
<p>如果你想查看采集到的指标 targets，那么可以通过 <code>/targets</code> 这个 endpoint 来获取：</p>
<p><img src="https://picdn.youdianzhishi.com/images/1689668181142.png" alt="targets"></p>
<p>这些功能基本上可以满足我们的一些需求，但是还是太过简单，如果你习惯了 Prometheus 的 UI 界面，那么我们可以使用 <code>promxy</code> 来代替 <code>vmui</code>，而且 <code>promxy</code> 还可以进行多个 VM 单节点的数据聚合，以及 targets 查看等，对应的资源清单文件如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vm-promxy.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: ConfigMap
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: promxy-config
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">config.yaml</span>: |<span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    promxy:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      server_groups:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - static_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - targets: [victoria-metrics:8428]  # 指定vm地址，有多个则往后追加即可
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        path_prefix: /prometheus  # 配置前缀</span>    
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: apps/v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Deployment
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: promxy
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">app</span>: promxy
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">app</span>: promxy
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">args</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f1fa8c">&#34;--config=/etc/promxy/config.yaml&#34;</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#f1fa8c">&#34;--web.enable-lifecycle&#34;</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#f1fa8c">&#34;--log-level=trace&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">env</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">name</span>: ROLE
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">value</span>: <span style="color:#f1fa8c">&#34;1&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">command</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f1fa8c">&#34;/bin/promxy&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">image</span>: quay.io/jacksontj/promxy
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">imagePullPolicy</span>: Always
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">name</span>: promxy
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">containerPort</span>: <span style="color:#bd93f9">8082</span>
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: web
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">volumeMounts</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">mountPath</span>: <span style="color:#f1fa8c">&#34;/etc/promxy/&#34;</span>
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: promxy-config
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">readOnly</span>: <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">args</span>: <span style="color:#6272a4"># container to reload configs on configmap change</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#f1fa8c">&#34;--volume-dir=/etc/promxy&#34;</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#f1fa8c">&#34;--webhook-url=http://localhost:8082/-/reload&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">image</span>: jimmidyson/configmap-reload:v0.1
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">name</span>: promxy-server-configmap-reload
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">volumeMounts</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">mountPath</span>: <span style="color:#f1fa8c">&#34;/etc/promxy/&#34;</span>
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: promxy-config
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">readOnly</span>: <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">volumes</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">configMap</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">name</span>: promxy-config
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">name</span>: promxy-config
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Service
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: promxy
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">type</span>: NodePort
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">8082</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: promxy
</span></span></code></pre></div><p>直接应用上面的资源对象即可：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>☸ ➜ kubectl apply -f vm-promxy.yaml
</span></span><span style="display:flex;"><span>☸ ➜ kubectl get pods -n kube-vm -l <span style="color:#8be9fd;font-style:italic">app</span><span style="color:#ff79c6">=</span>promxy
</span></span><span style="display:flex;"><span>NAME                      READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>promxy-5db957c48c-7tcjr   2/2     Running   <span style="color:#bd93f9">0</span>          110s
</span></span><span style="display:flex;"><span>☸ ➜ kubectl get svc promxy -n kube-vm
</span></span><span style="display:flex;"><span>NAME     TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span style="color:#ff79c6">(</span>S<span style="color:#ff79c6">)</span>          AGE
</span></span><span style="display:flex;"><span>promxy   NodePort   10.106.11.170   &lt;none&gt;        8082:31060/TCP   2m1s
</span></span></code></pre></div><p>访问 Promxy 的页面效果和 Prometheus 自带的 Web UI 基本一致的。</p>
<p><img src="https://picdn.youdianzhishi.com/images/1689668402982.jpg" alt="promxy"></p>
<h2 id="集群版">集群版</h2>
<p>对于低于每秒一百万个数据点的摄取率，建议使用单节点版本而不是集群版本。单节点版本可根据 CPU、内存和可用存储空间的数量进行扩展。单节点版本比集群版本更容易配置和操作，所以在使用集群版本之前要三思而后行。上面我们介绍了 VM 的单节点版本的基本使用，接下来我们来介绍下如何使用集群版。</p>
<p><img src="https://picdn.youdianzhishi.com/images/1689859339713.jpg" alt="VM Cluster"></p>
<p>集群版主要特点：</p>
<ul>
<li>支持单节点版本的所有功能。</li>
<li>性能和容量水平扩展。</li>
<li>支持时间序列数据的多个独立命名空间（多租户）。</li>
<li>支持多副本。</li>
</ul>
<p><strong>组件服务</strong></p>
<p>前面我们了解了 VM 的基本架构，对于集群模式下主要包含以下几个服务：</p>
<ul>
<li><code>vmstorage</code>：存储原始数据并返回指定标签过滤器在给定时间范围内的查询数据，当 <code>-storageDataPath</code> 指向的目录包含的可用空间少于 <code>-storage.minFreeDiskSpaceBytes</code> 时，<code>vmstorage</code> 节点会自动切换到<strong>只读模式</strong>，<code>vminsert</code> 节点也会停止向此类节点发送数据并开始将数据重新路由到剩余的 <code>vmstorage</code> 节点。</li>
<li><code>vminsert</code>：接受摄取的数据并根据指标名称及其所有标签的一致性哈希将其分散存储到 <code>vmstorage</code> 节点。</li>
<li><code>vmselect</code>：通过从所有配置的 <code>vmstorage</code> 节点获取所需数据来执行查询。</li>
</ul>
<p>每个服务都可以进行独立扩展，<code>vmstorage</code> 节点之间互不了解、互不通信，并且不共享任何数据。这样可以增加集群的可用性，并且简化了集群的维护和扩展。</p>
<p>最小集群必须包含以下节点：</p>
<ul>
<li>带有 <code>-retentionPeriod</code> 和 <code>-storageDataPath</code> 参数的单 <code>vmstorage</code> 节点</li>
<li>带有 <code>-storageNode=&lt;vmstorage_host&gt;</code> 的单 <code>vminsert</code> 节点</li>
<li>带有 <code>-storageNode=&lt;vmstorage_host&gt;</code> 的单 <code>vmselect</code> 节点</li>
</ul>
<p>但是我们建议为每个服务组件运行至少两个节点以实现高可用性，这样当单个节点暂时不可用时，集群会继续工作，而且其余节点还可以处理增加的工作负载。如果你的集群规模较大，那么可以运行多个 <code>vmstorage</code> 节点，因为这样可以在某些 <code>vmstorage</code> 节点暂时不可用时减少剩余 <code>vmstorage</code> 节点上的工作负载增加。</p>
<p>各个服务除了可以通过参数标志进行配置之外，也可以通过环境变量的方式进行配置：</p>
<ul>
<li><code>-envflag.enable</code> 标志必须设置</li>
<li>每个标志中的 <code>.</code> 必须替换为 <code>_</code>，例如 <code>-insert.maxQueueDuration &lt;duration&gt;</code> 可以转换为 <code>insert_maxQueueDuration=&lt;duration&gt;</code></li>
<li>对于重复的标志，可以使用另一种语法，通过使用 <code>,</code> 作为分隔符将不同的值连接成一个，例如 <code>-storageNode &lt;nodeA&gt; -storageNode &lt;nodeB&gt;</code> 将转换为 <code>-storageNode=&lt;nodeA&gt;,&lt;nodeB&gt;</code></li>
<li>可以使用 <code>-envflag.prefix</code> 为环境变量设置前缀，例如设置了 <code>-envflag.prefix=VM*</code>，则环境变量参数必须以 <code>VM*</code> 开头</li>
</ul>
<p><strong>多租户</strong></p>
<p>此外 VM 集群也支持多个独立的租户（也叫命名空间），租户由 <code>accountID</code> 或 <code>accountID:projectID</code> 来标识，它们被放在请求的 urls 中。</p>
<ul>
<li>每个 <code>accountID</code> 和 <code>projectID</code> 都由一个 <code>[0 .. 2^32]</code> 范围内的任意 32 位整数标识，如果缺少 <code>projectID</code>，则自动将其分配为 0。有关租户的其他信息，例如身份验证令牌、租户名称、限额、计费等，将存储在一个单独的关系型数据库中。此数据库必须由位于 VictoriaMetrics 集群前面的单独服务管理，例如 <code>vmauth</code> 或 <code>vmgateway</code>。</li>
<li>当第一个数据点写入指定租户时，租户被自动创建。</li>
<li>所有租户的数据均匀分布在可用的 <code>vmstorage</code> 节点中，当不同租户有不同的数据量和不同的查询负载时，这保证了 <code>vmstorage</code> 节点之间的均匀负载。</li>
<li>数据库性能和资源使用不依赖于租户的数量，它主要取决于所有租户中活跃时间序列的总数。如果一个时间序列在过去一小时内至少收到一个样本，或者在过去一小时内被查询，则认为时间序列是活跃的。</li>
<li>VictoriaMetrics 不支持在单个请求中查询多个租户。</li>
</ul>
<p><strong>集群大小调整和可扩展性</strong></p>
<p>VM 集群的性能和容量可以通过两种方式进行扩展：</p>
<ul>
<li>通过向集群中的现有节点添加更多资源（CPU、内存、磁盘 IO、磁盘空间、网络带宽），也叫垂直可扩展性。</li>
<li>通过向集群添加更多节点，又叫水平扩展性。</li>
</ul>
<p>对于集群扩展有一些通用的建议：</p>
<ul>
<li>向现有 <code>vmselect</code> 节点添加更多 CPU 和内存，可以提高复杂查询的性能，这些查询可以处理大量的时间序列和大量的原始样本。</li>
<li>添加更多 <code>vmstorage</code> 节点可以增加集群可以处理的活跃时间序列的数量，这也提高了对高流失率(<code>churn rate</code>)的时间序列的查询性能。集群稳定性也会随着 <code>vmstorage</code> 节点数量的增加而提高，当一些 <code>vmstorage</code> 节点不可用时，存活的 <code>vmstorage</code> 节点需要处理较低的额外工作负载。</li>
<li>向现有 <code>vmstorage</code> 节点添加更多 CPU 和内存，可以增加集群可以处理的活跃时间序列的数量。与向现有 <code>vmstorage</code> 节点添加更多 CPU 和内存相比，最好添加更多 <code>vmstorage</code> 节点，因为更多的 <code>vmstorage</code> 节点可以提高集群稳定性，并提高对高流失率的时间序列的查询性能。</li>
<li>添加更多的 <code>vminsert</code> 节点会提高数据摄取的最大速度，因为摄取的数据可以在更多的 <code>vminsert</code> 节点之间进行拆分。</li>
<li>添加更多的 <code>vmselect</code> 节点可以提高查询的最大速度，因为传入的并发请求可能会在更多的 <code>vmselect</code> 节点之间进行拆分。</li>
</ul>
<p><strong>集群可用性</strong></p>
<ul>
<li>HTTP 负载均衡器需要停止将请求路由到不可用的 <code>vminsert</code> 和 <code>vmselect</code> 节点。</li>
<li>如果至少存在一个 <code>vmstorage</code> 节点，则集群仍然可用：
<ul>
<li><code>vminsert</code> 将传入数据从不可用的 <code>vmstorage</code> 节点重新路由到健康的 <code>vmstorage</code> 节点</li>
<li>如果至少有一个 <code>vmstorage</code> 节点可用，则 <code>vmselect</code> 会继续提供部分响应。如果优先考虑可用性的一致性，则将 <code>-search.denyPartialResponse</code> 标志传递给 <code>vmselect</code> 或将请求中的 <code>deny_partial_response=1</code> 查询参数传递给 <code>vmselect</code>。</li>
</ul>
</li>
</ul>
<p><strong>重复数据删除</strong></p>
<p>如果 <code>-dedup.minScrapeInterval</code> 命令行标志设置为大于 0 的时间，VictoriaMetrics 会去除重复数据点。例如，<code>-dedup.minScrapeInterval=60s</code> 将对同一时间序列上的数据点进行重复数据删除，如果它们位于同一离散的 60 秒存储桶内，最早的数据点将被保留。在时间戳相等的情况下，将保留任意数据点。</p>
<p><code>-dedup.minScrapeInterval</code> 的推荐值是等于 Prometheus 配置中的 <code>scrape_interval</code> 的值，建议在所有抓取目标中使用一个 <code>scrape_interval</code> 配置。</p>
<!-- raw HTML omitted -->
<p>如果 HA 中多个相同配置的 <code>vmagent</code> 或 Prometheus 实例将数据写入同一个 VictoriaMetrics 实例，则重复数据删除会减少磁盘空间使用。这些 <code>vmagent</code> 或 Prometheus 实例在其配置中必须具有相同的 <code>external_labels</code> 部分，因此它们将数据写入相同的时间序列。</p>
<p><strong>容量规划</strong></p>
<p>根据我们的案例研究，与竞争解决方案（Prometheus、Thanos、Cortex、TimescaleDB、InfluxDB、QuestDB、M3DB）相比，VictoriaMetrics 在生产工作负载上使用的 CPU、内存和存储空间更少。</p>
<p>每种节点类型 - <code>vminsert</code>、<code>vmselect</code> 和 <code>vmstorage</code> 都可以在最合适的硬件上运行。集群容量随着可用资源的增加而线性扩展。每个节点类型所需的 CPU 和内存数量很大程度上取决于工作负载 - 活跃时间序列的数量、序列流失率、查询类型、查询 qps 等。建议为你的生产工作负载部署一个测试的 VictoriaMetrics 集群，并反复调整每个节点的资源和每个节点类型的节点数量，直到集群变得稳定。同样也建议为集群设置监控，有助于确定集群设置中的瓶颈问题。</p>
<p>指定保留所需的存储空间（可以通过 <code>vmstorage</code> 中的 <code>-retentionPeriod</code> 命令行标志设置）可以从测试运行中的磁盘空间使用情况推断出来。例如，如果在生产工作负载上运行一天后的存储空间使用量为 10GB，那么对于 <code>-retentionPeriod=100d</code>（100 天保留期）来说，它至少需要 <code>10GB*100=1TB</code> 的磁盘空间。可以使用 VictoriaMetrics 集群的<a href="https://grafana.com/grafana/dashboards/11176">官方 Grafana 仪表板</a>监控存储空间使用情况。</p>
<p>建议留出以下数量的备用资源。</p>
<ul>
<li>所有节点类型中 50% 的空闲内存，以减少工作负载临时激增时因为 OOM 崩溃的可能性。</li>
<li>所有节点类型中 50% 的空闲 CPU，以减少工作负载临时高峰期间的慢速概率。</li>
<li><code>vmstorage</code> 节点上 <code>-storageDataPath</code> 命令行标志指向的目录中至少有 <strong>30%</strong> 的可用存储空间。</li>
</ul>
<p>VictoriaMetrics 集群的一些容量规划技巧：</p>
<ul>
<li>副本集将集群所需的资源量最多增加 N 倍，其中 N 是复制因子。</li>
<li>可以通过添加更多 <code>vmstorage</code> 节点和/或通过增加每个 <code>vmstorage</code> 节点的内存和 CPU 资源来增加活跃时间序列的集群容量。</li>
<li>可以通过增加 <code>vmstorage</code> 节点的数量和/或通过增加每个 <code>vmselect</code> 节点的内存和 CPU 资源来减少查询延迟。</li>
<li>所有 <code>vminsert</code> 节点所需的 CPU 内核总数可以通过摄取率计算：<code>CPUs = ingestion_rate / 100K</code>。</li>
<li><code>vminsert</code> 节点上的 <code>-rpc.disableCompression</code> 命令行标志可以增加摄取容量，但代价是 <code>vminsert</code> 和 <code>vmstorage</code> 之间的网络带宽使用率会更高。</li>
</ul>
<p><strong>复制和数据安全</strong></p>
<p>默认情况下，VictoriaMetrics 的数据复制依赖 <code>-storageDataPath</code> 指向的底层存储来完成。</p>
<p>但是我们也可以手动通过将 <code>-replicationFactor=N</code> 命令参数传递给 <code>vminsert</code> 来启用复制，这保证了如果多达 <code>N-1</code> 个 <code>vmstorage</code> 节点不可用，所有数据仍可用于查询。集群必须至少包含 <code>2*N-1</code> 个 <code>vmstorage</code> 节点，其中 <code>N</code> 是复制因子，以便在 <code>N-1</code> 个存储节点丢失时为新摄取的数据维持指定的复制因子。</p>
<p>例如，当 <code>-replicationFactor=3</code> 传递给 <code>vminsert</code> 时，它将所有摄取的数据复制到 3 个不同的 <code>vmstorage</code> 节点，因此最多可以丢失 2 个 <code>vmstorage</code> 节点而不会丢失数据。<code>vmstorage</code> 节点的最小数量应该等于 <code>2*3-1 = 5</code>，因此当 2 个 <code>vmstorage</code> 节点丢失时，剩余的 3 个 <code>vmstorage</code> 节点可以为新摄取的数据提供服务。</p>
<p>启用复制后，必须将 <code>-dedup.minScrapeInterval=1ms</code> 命令行标志传递给 <code>vmselect</code> 节点，当多达 <code>N-1</code> 个 <code>vmstorage</code> 节点响应缓慢和/或暂时不可用时，可以将可选的 <code>-replicationFactor=N</code> 参数传递给 <code>vmselect</code> 以提高查询性能，因为 <code>vmselect</code> 不等待来自多达 <code>N-1</code> 个 <code>vmstorage</code> 节点的响应。有时，<code>vmselect</code> 节点上的 <code>-replicationFactor</code> 可能会导致部分响应。<code>-dedup.minScrapeInterval=1ms</code> 在查询期间对复制的数据进行重复数据删除，如果重复数据从配置相同的 <code>vmagent</code> 实例或 Prometheus 实例推送到 VictoriaMetrics，则必须根据重复数据删除文档将 <code>-dedup.minScrapeInterval</code> 设置为更大的值。</p>
<p>请注意，复制不会从灾难中保存，因此建议执行定期备份。另外复制会增加资源使用率 - CPU、内存、磁盘空间、网络带宽这些最多 <code>-replicationFactor</code> 倍。所以可以将复制转移 <code>-storageDataPath</code> 指向的底层存储来做保证，例如 Google Compute Engine 永久磁盘，该磁盘可以防止数据丢失和数据损坏，它还提供始终如一的高性能，并且可以在不停机的情况下调整大小。对于大多数用例来说，基于 HDD 的永久性磁盘应该足够了。</p>
<p><strong>备份</strong></p>
<p>建议从即时快照执行定期备份，以防止意外数据删除等错误。必须为每个 <code>vmstorage</code> 节点执行以下步骤来创建备份：</p>
<p>通过导航到/snapshot/create HTTP handler 来创建一个即时快照。它将创建快照并返回其名称。</p>
<ul>
<li>可以通过访问 <code>/snapshot/create</code> 这个 HTTP handler 来创建即时快照，它将创建快照并返回其名称。</li>
<li>使用 <code>vmbackup</code> 组件从 <code>&lt;storageDataPath&gt;/snapshots/&lt;snapshot_name&gt;</code> 文件夹归档创建的快照。归档过程不会干扰 <code>vmstorage</code> 工作，因此可以在任何合适的时间执行。</li>
<li>通过 <code>/snapshot/delete?snapshot=&lt;snapshot_name&gt;</code> 或 <code>/snapshot/delete_all</code> 删除未使用的快照，以释放占用的存储空间。</li>
<li>无需在所有 <code>vmstorage</code> 节点之间同步备份。</li>
</ul>
<p>从备份恢复：</p>
<ul>
<li>使用 <code>kill -INT</code> 停止 <code>vmstorage</code> 节点。</li>
<li>使用 <code>vmrestore</code> 组件将备份中的数据还原到 <code>-storageDataPath</code> 目录。</li>
<li>启动 <code>vmstorage</code> 节点。</li>
</ul>
<p>在了解了 VM 集群的一些配置细节后，接下来我们就来开始部署 VM 集群。</p>
<p><strong>Helm</strong></p>
<p>如果你已经对 VM 组件非常了解了，那么推荐使用 Helm Chart 的方式进行一键安装。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>☸ ➜ helm repo add vm https://victoriametrics.github.io/helm-charts/
</span></span><span style="display:flex;"><span>☸ ➜ helm repo update
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 导出默认的 values 值到 vm-cluster-values.yaml 文件中</span>
</span></span><span style="display:flex;"><span>☸ ➜ helm show values vm/victoria-metrics-cluster &gt; vm-cluster-values.yaml
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 根据自己的需求修改 values.yaml 文件配置</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 执行下面的命令进行一键安装</span>
</span></span><span style="display:flex;"><span>☸ ➜ helm upgrade --install victoria-metrics vm/victoria-metrics-cluster -f vm-cluster-values.yaml -n &lt;namespace&gt;
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 获取 vm 运行的 pods 列表</span>
</span></span><span style="display:flex;"><span>☸ ➜ kubectl get pods -A | grep <span style="color:#f1fa8c">&#39;victoria-metrics&#39;</span>
</span></span></code></pre></div><p>我们这里选择手动方式进行部署，之所以选择手动部署的方式是为了能够了解各个组件的更多细节。</p>
<p><strong>手动安装</strong></p>
<p>由于 vmstorage 组件是有状态的，这里我们先使用 StatefulSet 进行部署，由于该组件也是可以进行扩展的，这里我们首先部署两个副本，对应的资源清单如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># cluster/vmstorage.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Service
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: cluster-vmstorage
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: vmstorage
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">clusterIP</span>: None
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">8482</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">targetPort</span>: http
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">name</span>: http
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">8401</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">targetPort</span>: vmselect
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">name</span>: vmselect
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">8400</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">targetPort</span>: vminsert
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">name</span>: vminsert
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: vmstorage
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: apps/v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: StatefulSet
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vmstorage
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: vmstorage
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">serviceName</span>: cluster-vmstorage
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">app</span>: vmstorage
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">replicas</span>: <span style="color:#bd93f9">2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">podManagementPolicy</span>: OrderedReady
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">app</span>: vmstorage
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: vmstorage
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">image</span>: <span style="color:#f1fa8c">&#34;victoriametrics/vmstorage:v1.91.3-cluster&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">imagePullPolicy</span>: <span style="color:#f1fa8c">&#34;IfNotPresent&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">args</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f1fa8c">&#34;--retentionPeriod=1&#34;</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#f1fa8c">&#34;--storageDataPath=/storage&#34;</span>
</span></span><span style="display:flex;"><span>            - --envflag.enable=true
</span></span><span style="display:flex;"><span>            - --envflag.prefix=VM_
</span></span><span style="display:flex;"><span>            - --loggerFormat=json
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">name</span>: http
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">containerPort</span>: <span style="color:#bd93f9">8482</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">name</span>: vminsert
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">containerPort</span>: <span style="color:#bd93f9">8400</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">name</span>: vmselect
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">containerPort</span>: <span style="color:#bd93f9">8401</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">livenessProbe</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">failureThreshold</span>: <span style="color:#bd93f9">10</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">initialDelaySeconds</span>: <span style="color:#bd93f9">30</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">periodSeconds</span>: <span style="color:#bd93f9">30</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">tcpSocket</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">port</span>: http
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">timeoutSeconds</span>: <span style="color:#bd93f9">5</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">readinessProbe</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">failureThreshold</span>: <span style="color:#bd93f9">3</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">initialDelaySeconds</span>: <span style="color:#bd93f9">5</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">periodSeconds</span>: <span style="color:#bd93f9">15</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">timeoutSeconds</span>: <span style="color:#bd93f9">5</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">httpGet</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">path</span>: /health
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">port</span>: http
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">volumeMounts</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">name</span>: storage
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">mountPath</span>: /storage
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">volumeClaimTemplates</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">name</span>: storage
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">storageClassName</span>: cfsauto <span style="color:#6272a4"># 指定一个可用的存储类（建议用Local PV）</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">accessModes</span>:
</span></span><span style="display:flex;"><span>          - ReadWriteOnce
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">resources</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">requests</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">storage</span>: <span style="color:#f1fa8c">&#34;2Gi&#34;</span>
</span></span></code></pre></div><p>首先需要创建一个 Headless 的 Service，因为后面的组件需要访问到每一个具体的 Pod，在 vmstorage 启动参数中通过 <code>--retentionPeriod</code> 参数指定指标数据保留时长，1 表示一个月，这也是默认的时长，然后通过 <code>--storageDataPath</code> 参数指定了数据存储路径，记得要将该目录进行持久化。</p>
<p>同样直接应用该资源即可：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>☸ ➜ kubectl apply -f vmstorage.yaml
</span></span><span style="display:flex;"><span>☸ ➜ kubectl get pods -n kube-vm -l <span style="color:#8be9fd;font-style:italic">app</span><span style="color:#ff79c6">=</span>vmstorage
</span></span><span style="display:flex;"><span>NAME          READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>vmstorage-0   1/1     Running   <span style="color:#bd93f9">0</span>          5m40s
</span></span><span style="display:flex;"><span>vmstorage-1   1/1     Running   <span style="color:#bd93f9">0</span>          3m31s
</span></span><span style="display:flex;"><span>☸ ➜ kubectl get svc -n kube-vm -l <span style="color:#8be9fd;font-style:italic">app</span><span style="color:#ff79c6">=</span>vmstorage
</span></span><span style="display:flex;"><span>NAME                TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span style="color:#ff79c6">(</span>S<span style="color:#ff79c6">)</span>                      AGE
</span></span><span style="display:flex;"><span>cluster-vmstorage   ClusterIP   None         &lt;none&gt;        8482/TCP,8401/TCP,8400/TCP   12s
</span></span></code></pre></div><p>接着可以部署 vmselect 组件，由于该组件是无状态（如果你要保存 cache 数据则需要看成是有状态应用了）的，我们可以直接使用 Deployment 来进行管理，对应的资源清单文件如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># cluster/vmselect.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Service
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vmselect
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: vmselect
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: http
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">8481</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">targetPort</span>: http
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: vmselect
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: apps/v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Deployment
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vmselect
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: vmselect
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">replicas</span>: <span style="color:#bd93f9">2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">app</span>: vmselect
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">app</span>: vmselect
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: vmselect
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">image</span>: <span style="color:#f1fa8c">&#34;victoriametrics/vmselect:v1.91.3-cluster&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">imagePullPolicy</span>: <span style="color:#f1fa8c">&#34;IfNotPresent&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">args</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f1fa8c">&#34;--cacheDataPath=/cache&#34;</span>
</span></span><span style="display:flex;"><span>            - --storageNode=vmstorage-0.cluster-vmstorage.kube-vm.svc.cluster.local:8401
</span></span><span style="display:flex;"><span>            - --storageNode=vmstorage-1.cluster-vmstorage.kube-vm.svc.cluster.local:8401
</span></span><span style="display:flex;"><span>            - --envflag.enable=true
</span></span><span style="display:flex;"><span>            - --envflag.prefix=VM_
</span></span><span style="display:flex;"><span>            - --loggerFormat=json
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">name</span>: http
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">containerPort</span>: <span style="color:#bd93f9">8481</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">readinessProbe</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">httpGet</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">path</span>: /health
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">port</span>: http
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">initialDelaySeconds</span>: <span style="color:#bd93f9">5</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">periodSeconds</span>: <span style="color:#bd93f9">15</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">timeoutSeconds</span>: <span style="color:#bd93f9">5</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">failureThreshold</span>: <span style="color:#bd93f9">3</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">livenessProbe</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">tcpSocket</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">port</span>: http
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">initialDelaySeconds</span>: <span style="color:#bd93f9">5</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">periodSeconds</span>: <span style="color:#bd93f9">15</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">timeoutSeconds</span>: <span style="color:#bd93f9">5</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">failureThreshold</span>: <span style="color:#bd93f9">3</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">volumeMounts</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">mountPath</span>: /cache
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: cache-volume
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">volumes</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: cache-volume
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">emptyDir</span>: {}
</span></span></code></pre></div><p>其中最重要的部分是通过 <code>--storageNode</code> 参数指定所有的 vmstorage 节点地址，上面我们使用的 StatefulSet 部署的，所以可以直接使用 FQDN 的形式进行访问。直接应用上面的对象：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>☸ ➜ kubectl apply -f vmselect.yaml
</span></span><span style="display:flex;"><span>☸ ➜ kubectl get pods -n kube-vm -l <span style="color:#8be9fd;font-style:italic">app</span><span style="color:#ff79c6">=</span>vmselect
</span></span><span style="display:flex;"><span>NAME                        READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>vmselect-75d59b468c-4c7rp   1/1     Running   <span style="color:#bd93f9">0</span>          25s
</span></span><span style="display:flex;"><span>vmselect-75d59b468c-8g8tj   1/1     Running   <span style="color:#bd93f9">0</span>          42s
</span></span><span style="display:flex;"><span>☸ ➜ kubectl get svc -n kube-vm -l <span style="color:#8be9fd;font-style:italic">app</span><span style="color:#ff79c6">=</span>vmselect
</span></span><span style="display:flex;"><span>NAME       TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span style="color:#ff79c6">(</span>S<span style="color:#ff79c6">)</span>    AGE
</span></span><span style="display:flex;"><span>vmselect   ClusterIP   10.100.207.33   &lt;none&gt;        8481/TCP   <span style="color:#bd93f9">7</span>
</span></span></code></pre></div><p>如果要进行查询，那么我们可以直接对外暴露 vmselect 这个 Service 服务即可，修改 Grafana 数据源地址为 <code>http://&lt;select-service&gt;/select/0/prometheus/</code>。</p>
<p><img src="https://picdn.youdianzhishi.com/images/1689835776972.png" alt="vmselect数据源"></p>
<p>接着就需要部署用来接收指标数据插入的 vminsert 组件，同样该组件是无状态的，其中最重要的也是需要通过 <code>--storageNode</code> 参数指定所有的 vmstorage 节点：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># cluster/vminsert.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Service
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vminsert
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: vminsert
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: http
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">8480</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">targetPort</span>: http
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: vminsert
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: apps/v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Deployment
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vminsert
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: vminsert
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">replicas</span>: <span style="color:#bd93f9">2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">app</span>: vminsert
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">app</span>: vminsert
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: vminsert
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">image</span>: <span style="color:#f1fa8c">&#34;victoriametrics/vminsert:v1.91.3-cluster&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">imagePullPolicy</span>: <span style="color:#f1fa8c">&#34;IfNotPresent&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">args</span>:
</span></span><span style="display:flex;"><span>            - --storageNode=vmstorage-0.cluster-vmstorage.kube-vm.svc.cluster.local:8400
</span></span><span style="display:flex;"><span>            - --storageNode=vmstorage-1.cluster-vmstorage.kube-vm.svc.cluster.local:8400
</span></span><span style="display:flex;"><span>            - --envflag.enable=true
</span></span><span style="display:flex;"><span>            - --envflag.prefix=VM_
</span></span><span style="display:flex;"><span>            - --loggerFormat=json
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">name</span>: http
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">containerPort</span>: <span style="color:#bd93f9">8480</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">readinessProbe</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">httpGet</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">path</span>: /health
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">port</span>: http
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">initialDelaySeconds</span>: <span style="color:#bd93f9">5</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">periodSeconds</span>: <span style="color:#bd93f9">15</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">timeoutSeconds</span>: <span style="color:#bd93f9">5</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">failureThreshold</span>: <span style="color:#bd93f9">3</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">livenessProbe</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">tcpSocket</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">port</span>: http
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">initialDelaySeconds</span>: <span style="color:#bd93f9">5</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">periodSeconds</span>: <span style="color:#bd93f9">15</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">timeoutSeconds</span>: <span style="color:#bd93f9">5</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">failureThreshold</span>: <span style="color:#bd93f9">3</span>
</span></span></code></pre></div><p>由于本身是无状态的，所以可以根据需要增加副本数量，也可以配置 HPA 进行自动扩缩容。直接应用上面的资源清单：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>☸ ➜ kubectl apply -f vminsert.yaml
</span></span><span style="display:flex;"><span>☸ ➜ kubectl get pods -n kube-vm -l <span style="color:#8be9fd;font-style:italic">app</span><span style="color:#ff79c6">=</span>vminsert
</span></span><span style="display:flex;"><span>NAME                       READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>vminsert-b7fd8cfd5-kscc2   1/1     Running   <span style="color:#bd93f9">0</span>          59s
</span></span><span style="display:flex;"><span>vminsert-b7fd8cfd5-zxp49   1/1     Running   <span style="color:#bd93f9">0</span>          59s
</span></span><span style="display:flex;"><span>☸ ➜ kubectl get svc -n kube-vm -l <span style="color:#8be9fd;font-style:italic">app</span><span style="color:#ff79c6">=</span>vminsert
</span></span><span style="display:flex;"><span>NAME       TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span style="color:#ff79c6">(</span>S<span style="color:#ff79c6">)</span>    AGE
</span></span><span style="display:flex;"><span>vminsert   ClusterIP   10.108.71.120   &lt;none&gt;        8480/TCP   71s
</span></span></code></pre></div><p>集群模式的相关组件部署完成后，同样我们可以先去配置前面的 Prometheus，将其数据远程写入到 VM 中来，修改 <code>remote_write</code> 的地址为 <code>http://vminsert:8480/insert/0/prometheus/</code>，注意和单节点模式的 API 路径不一样，如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vm-prom-config3.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: ConfigMap
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: prometheus-config
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">prometheus.yaml</span>: |<span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    global:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      scrape_interval: 15s
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      scrape_timeout: 15s
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    remote_write:    # 写入到远程 VM 存储，url 是远程写入接口地址
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    - url: http://vminsert:8480/insert/0/prometheus/
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      # queue_config:    # 如果 Prometheus 抓取指标很大，可以加调整 queue，但是会提高内存占用
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      #   max_samples_per_send: 10000  # 每次发送的最大样本数
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      #   capacity: 20000
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      #   max_shards: 30   # 最大分片数，即并发量。
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    scrape_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    - job_name: &#34;nodes&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      static_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - targets: [&#39;10.206.16.6:9100&#39;, &#39;10.206.16.5:9100&#39;, &#39;10.206.16.10:9100&#39;]
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      relabel_configs: # 通过 relabeling 从 __address__ 中提取 IP 信息，为了后面验证 VM 是否兼容 relabeling
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - source_labels: [__address__]
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        regex: &#34;(.*):(.*)&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        replacement: &#34;${1}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        target_label: &#39;ip&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        action: replace</span>    
</span></span></code></pre></div><p>更新 Prometheus 配置，然后启动 Prometheus，前面的单机模式的 VM 可以先停掉：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>☸ ➜ kubectl apply -f vm-prom-config3.yaml
</span></span><span style="display:flex;"><span>☸ ➜ kubectl scale deploy victoria-metrics --replicas<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span> -n kube-vm
</span></span><span style="display:flex;"><span>☸ ➜ kubectl scale deploy prometheus --replicas<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span> -n kube-vm
</span></span></code></pre></div><p>配置成功后正常数据就可以开始写入到 vmstorage 了，查看 vmstorage 日志可以看到成功创建了 partition，证明现在已经在开始接收数据了：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>☸ ➜ kubectl logs -f vmstorage-0 -n kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T06:43:48.082Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/lib/logger/flag.go:12&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;build version: vmstorage-20230630-163052-tags-v1.91.3-cluster-0-g12f262c331&#34;</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># ......</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T06:43:48.082Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/app/vmstorage/main.go:100&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;opening storage at \&#34;/storage\&#34; with -retentionPeriod=1&#34;</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T06:43:48.087Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/lib/memory/memory.go:42&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;limiting caches to 4604539699 bytes, leaving 3069693133 bytes to the OS according to -memory.allowedPercent=60&#34;</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T06:43:48.091Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/lib/storage/storage.go:873&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;nothing to load from \&#34;/storage/cache/curr_hour_metric_ids\&#34;&#34;</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T06:43:48.091Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/lib/storage/storage.go:873&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;nothing to load from \&#34;/storage/cache/prev_hour_metric_ids\&#34;&#34;</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T06:43:48.091Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/lib/storage/storage.go:833&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;nothing to load from \&#34;/storage/cache/next_day_metric_ids\&#34;&#34;</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T06:43:48.136Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/app/vmstorage/main.go:112&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;successfully opened storage \&#34;/storage\&#34; in 0.054 seconds; partsCount: 0; blocksCount: 0; rowsCount: 0; sizeBytes: 0&#34;</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T06:43:48.138Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/app/vmstorage/servers/vminsert.go:65&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;accepting vminsert conns at 0.0.0.0:8400&#34;</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T06:43:48.138Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/lib/httpserver/httpserver.go:96&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;starting http server at http://127.0.0.1:8482/&#34;</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T06:43:48.138Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/lib/httpserver/httpserver.go:97&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;pprof handlers are exposed at http://127.0.0.1:8482/debug/pprof/&#34;</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T06:43:48.138Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/lib/vmselectapi/server.go:157&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;accepting vmselect conns at 0.0.0.0:8401&#34;</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T06:56:25.825Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/app/vmstorage/servers/vminsert.go:114&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;processing vminsert conn from 10.244.3.127:47976&#34;</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T06:56:27.613Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/app/vmstorage/servers/vminsert.go:114&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;processing vminsert conn from 10.244.2.249:54484&#34;</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T06:59:32.813Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/lib/storage/partition.go:221&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;creating a partition \&#34;2023_07\&#34; with smallPartsPath=\&#34;/storage/data/small/2023_07\&#34;, bigPartsPath=\&#34;/storage/data/big/2023_07\&#34;&#34;</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T06:59:32.821Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/lib/storage/partition.go:230&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;partition \&#34;2023_07\&#34; has been created&#34;</span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>然后可以去 Grafana 重新查看 Dashboard 是否正常：</p>
<p><img src="https://picdn.youdianzhishi.com/images/1689836577195.jpg" alt="node exporter"></p>
<p>如果现在需要新增 <code>vmstorage</code> 节点，那么需要按照下面的步骤进行操作：</p>
<ul>
<li>使用与集群中现有节点相同的 <code>-retentionPeriod</code> 配置启动新的 <code>vmstorage</code> 节点。</li>
<li>逐步重新启动所有的 <code>vmselect</code> 节点，添加新的 <code>-storageNode</code> 参数包含 <code>&lt;new_vmstorage_host&gt;</code>。</li>
<li>逐步重新启动所有的 <code>vminsert</code> 节点，添加新的 <code>-storageNode</code> 参数包含 <code>&lt;new_vmstorage_host&gt;</code>。</li>
</ul>
<h2 id="vmagent">vmagent</h2>
<p>vmagent 可以帮助我们从各种来源收集指标并将它们存储这 VM 或者任何其他支持 remote write 协议的 Prometheus 兼容的存储系统中。vmagent 相比于 Prometheus 抓取指标来说具有更多的灵活性，比如除了拉取（pull）指标还可以推送（push）指标，此外还有很多其他特性：</p>
<ul>
<li>可以替换 prometheus 的 scraping target</li>
<li>支持从 Kafka 读写数据</li>
<li>支持基于 prometheus relabeling 的模式添加、移除、修改 labels，可以在数据发送到远端存储之前进行数据的过滤</li>
<li>支持多种数据协议，influx line 协议，graphite 文本协议，opentsdb 协议，prometheus remote write 协议，json lines 协议，csv 数据等</li>
<li>支持收集数据的同时，并复制到多种远端存储系统</li>
<li>支持不可靠远端存储，如果远程存储不可用，收集的指标会在 <code>-remoteWrite.tmpDataPath</code> 缓冲，一旦与远程存储的连接被修复，缓冲的指标就会被发送到远程存储，缓冲区的最大磁盘用量可以用 <code>-remoteWrite.maxDiskUsagePerURL</code> 来限制。</li>
<li>相比 prometheus 使用更少的内存、cpu、磁盘 io 以及网络带宽</li>
<li>当需要抓取大量目标时，抓取目标可以分散到多个 vmagent 实例中</li>
<li>可以通过在抓取时间和将其发送到远程存储系统之前限制唯一时间序列的数量来处理高基数和高流失率问题</li>
<li>可以从多个文件中加载 scrape 配置</li>
</ul>
<p><img src="https://picdn.youdianzhishi.com/images/1650529595671.jpg" alt="vmagent"></p>
<p>接下来我们以抓取 Kubernetes 集群指标为例说明如何使用 vmagent，我们这里使用自动发现的方式来进行配置。vmagent 是兼容 prometheus 中的 <code>kubernetes_sd_configs</code> 配置的，所以我们同样可以使用。</p>
<p>要让 vmagent 自动发现监控的资源对象，需要访问 APIServer 获取资源对象，所以首先需要配置 rbac 权限，创建如下所示的资源清单。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vmagent-rbac.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: ServiceAccount
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vmagent
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: rbac.authorization.k8s.io/v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: ClusterRole
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vmagent
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff79c6">apiGroups</span>: [<span style="color:#f1fa8c">&#34;&#34;</span>, <span style="color:#f1fa8c">&#34;networking.k8s.io&#34;</span>, <span style="color:#f1fa8c">&#34;extensions&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">resources</span>:
</span></span><span style="display:flex;"><span>      - nodes
</span></span><span style="display:flex;"><span>      - nodes/metrics
</span></span><span style="display:flex;"><span>      - services
</span></span><span style="display:flex;"><span>      - endpoints
</span></span><span style="display:flex;"><span>      - endpointslices
</span></span><span style="display:flex;"><span>      - pods
</span></span><span style="display:flex;"><span>      - app
</span></span><span style="display:flex;"><span>      - ingresses
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">verbs</span>: [<span style="color:#f1fa8c">&#34;get&#34;</span>, <span style="color:#f1fa8c">&#34;list&#34;</span>, <span style="color:#f1fa8c">&#34;watch&#34;</span>]
</span></span><span style="display:flex;"><span>  - <span style="color:#ff79c6">apiGroups</span>: [<span style="color:#f1fa8c">&#34;&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">resources</span>:
</span></span><span style="display:flex;"><span>      - namespaces
</span></span><span style="display:flex;"><span>      - configmaps
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">verbs</span>: [<span style="color:#f1fa8c">&#34;get&#34;</span>]
</span></span><span style="display:flex;"><span>  - <span style="color:#ff79c6">nonResourceURLs</span>: [<span style="color:#f1fa8c">&#34;/metrics&#34;</span>, <span style="color:#f1fa8c">&#34;/metrics/resources&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">verbs</span>: [<span style="color:#f1fa8c">&#34;get&#34;</span>]
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: rbac.authorization.k8s.io/v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: ClusterRoleBinding
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vmagent
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">roleRef</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">apiGroup</span>: rbac.authorization.k8s.io
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">kind</span>: ClusterRole
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vmagent
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">subjects</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff79c6">kind</span>: ServiceAccount
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">name</span>: vmagent
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span></code></pre></div><p>然后添加 vmagent 配置，我们先只配置自动发现 Kubernetes 节点的任务，创建如下所示的 ConfigMap 对象：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vmagent-config.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: ConfigMap
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vmagent-config
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">scrape.yml</span>: |<span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    global:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      scrape_interval: 15s
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      scrape_timeout: 15s
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    scrape_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    - job_name: nodes
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      kubernetes_sd_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - role: node
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      relabel_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - source_labels: [__address__]
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        regex: &#34;(.*):10250&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        replacement: &#34;${1}:9100&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        target_label: __address__
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        action: replace
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - action: labelmap
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        regex: __meta_kubernetes_node_label_(.+)</span>    
</span></span></code></pre></div><p>这里我们通过自动发现 Kubernetes 节点获取节点监控指标，需要注意 <code>node</code> 这种 role 的自动发现默认获取的是节点的 <code>10250</code> 端口，这里我们需要通过 <code>relabel</code> 将其 <code>replace</code> 为 <code>9100</code>。</p>
<p>然后添加 vmagent 部署资源清单，如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vmagent-deploy.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: PersistentVolumeClaim
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vmagent-pvc
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">accessModes</span>:
</span></span><span style="display:flex;"><span>    - ReadWriteOnce
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">resources</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">requests</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">storage</span>: 1Gi
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">storageClassName</span>: cfsauto
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: apps/v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Deployment
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vmagent
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: vmagent
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">app</span>: vmagent
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">app</span>: vmagent
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">serviceAccountName</span>: vmagent
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: agent
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">image</span>: <span style="color:#f1fa8c">&#34;victoriametrics/vmagent:v1.91.3&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">imagePullPolicy</span>: IfNotPresent
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">args</span>:
</span></span><span style="display:flex;"><span>            - -promscrape.config=/config/scrape.yml
</span></span><span style="display:flex;"><span>            - -remoteWrite.tmpDataPath=/tmpData
</span></span><span style="display:flex;"><span>            - -remoteWrite.url=http://vminsert:8480/insert/0/prometheus
</span></span><span style="display:flex;"><span>            - -envflag.enable=true
</span></span><span style="display:flex;"><span>            - -envflag.prefix=VM_
</span></span><span style="display:flex;"><span>            - -loggerFormat=json
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">name</span>: http
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">containerPort</span>: <span style="color:#bd93f9">8429</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">volumeMounts</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">name</span>: tmpdata
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">mountPath</span>: /tmpData
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">name</span>: config
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">mountPath</span>: /config
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">volumes</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: tmpdata
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">persistentVolumeClaim</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">claimName</span>: vmagent-pvc
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: config
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">configMap</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">name</span>: vmagent-config
</span></span></code></pre></div><p>我们将 vmagent 配置通过 ConfigMap 挂载到容器 <code>/config/scrape.yml</code>，另外通过 <code>-remoteWrite.url=http://vminsert:8480/insert/0/prometheus</code> 指定远程写入的地址，这里我们写入前面的 vminsert 服务，另外有一个参数 <code>-remoteWrite.tmpDataPath</code>，该路径会在远程存储不可用的时候用来缓存收集的指标，当远程存储修复后，缓存的指标就会被正常发送到远程写入，所以最好持久化该目录。</p>
<p>单个 vmagent 实例可以抓取数万个抓取目标，但是有时由于 CPU、网络、内存等方面的限制，这还不够。在这种情况下，抓取目标可以在多个 vmagent 实例之间进行拆分。集群中的每个 vmagent 实例必须使用具有不同 <code>-promscrape.cluster.memberNum</code> 值的相同 <code>-promscrape.config</code> 配置文件，该参数值必须在 <code>0 ... N-1</code> 范围内，其中 <code>N</code> 是集群中 vmagent 实例的数量。集群中 vmagent 实例的数量必须传递给 <code>-promscrape.cluster.membersCount</code> 命令行标志。例如，以下命令可以在两个 vmagent 实例的集群中传播抓取目标：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>vmagent -promscrape.cluster.membersCount<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2</span> -promscrape.cluster.memberNum<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span> -promscrape.config<span style="color:#ff79c6">=</span>/path/config.yml ...
</span></span><span style="display:flex;"><span>vmagent -promscrape.cluster.membersCount<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2</span> -promscrape.cluster.memberNum<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span> -promscrape.config<span style="color:#ff79c6">=</span>/path/config.yml ...
</span></span></code></pre></div><p>当 vmagent 在 Kubernetes 中运行时，可以将 <code>-promscrape.cluster.memberNum</code> 设置为 StatefulSet pod 名称，pod 名称必须以 <code>0 ... promscrape.cluster.memberNum-1</code> 范围内的数字结尾，例如，<code>-promscrape.cluster.memberNum=vmagent-0</code>。</p>
<p>默认情况下，每个抓取目标仅由集群中的单个 vmagent 实例抓取。如果需要在多个 vmagent 实例之间复制抓取目标，则可以通过 <code>-promscrape.cluster.replicationFactor</code> 参数设置为所需的副本数。例如，以下命令启动一个包含三个 vmagent 实例的集群，其中每个目标由两个 vmagent 实例抓取：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>vmagent -promscrape.cluster.membersCount<span style="color:#ff79c6">=</span><span style="color:#bd93f9">3</span> -promscrape.cluster.replicationFactor<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2</span> -promscrape.cluster.memberNum<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span> -promscrape.config<span style="color:#ff79c6">=</span>/path/to/config.yml ...
</span></span><span style="display:flex;"><span>vmagent -promscrape.cluster.membersCount<span style="color:#ff79c6">=</span><span style="color:#bd93f9">3</span> -promscrape.cluster.replicationFactor<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2</span> -promscrape.cluster.memberNum<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span> -promscrape.config<span style="color:#ff79c6">=</span>/path/to/config.yml ...
</span></span><span style="display:flex;"><span>vmagent -promscrape.cluster.membersCount<span style="color:#ff79c6">=</span><span style="color:#bd93f9">3</span> -promscrape.cluster.replicationFactor<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2</span> -promscrape.cluster.memberNum<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2</span> -promscrape.config<span style="color:#ff79c6">=</span>/path/to/config.yml ...
</span></span></code></pre></div><p>需要注意的是如果每个目标被多个 vmagent 实例抓取，则必须在 <code>-remoteWrite.url</code> 指向的远程存储上启用重复数据删除。</p>
<p>所以如果你抓取的监控目标非常大，那么我们建议使用 vmagent 集群模式，那么可以使用 StatefulSet 方式进行部署</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vmagent-sts.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Service
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vmagent
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">annotations</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">prometheus.io/scrape</span>: <span style="color:#f1fa8c">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">prometheus.io/port</span>: <span style="color:#f1fa8c">&#34;8429&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: vmagent
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">clusterIP</span>: None
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: http
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">8429</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">targetPort</span>: http
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: apps/v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: StatefulSet
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vmagent
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: vmagent
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">replicas</span>: <span style="color:#bd93f9">2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">serviceName</span>: vmagent
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">app</span>: vmagent
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">app</span>: vmagent
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">serviceAccountName</span>: vmagent
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: agent
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">image</span>: victoriametrics/vmagent:v1.91.3
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">imagePullPolicy</span>: IfNotPresent
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">args</span>:
</span></span><span style="display:flex;"><span>            - -promscrape.config=/config/scrape.yml
</span></span><span style="display:flex;"><span>            - -remoteWrite.tmpDataPath=/tmpData
</span></span><span style="display:flex;"><span>            - -promscrape.cluster.membersCount=2
</span></span><span style="display:flex;"><span>            <span style="color:#6272a4"># - -promscrape.cluster.replicationFactor=2 # 可以配置副本数</span>
</span></span><span style="display:flex;"><span>            - -promscrape.cluster.memberNum=$(POD_NAME)
</span></span><span style="display:flex;"><span>            - -remoteWrite.url=http://vminsert:8480/insert/0/prometheus
</span></span><span style="display:flex;"><span>            - -envflag.enable=true
</span></span><span style="display:flex;"><span>            - -envflag.prefix=VM_
</span></span><span style="display:flex;"><span>            - -loggerFormat=json
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">name</span>: http
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">containerPort</span>: <span style="color:#bd93f9">8429</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">env</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">name</span>: POD_NAME
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">valueFrom</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">fieldRef</span>:
</span></span><span style="display:flex;"><span>                  <span style="color:#ff79c6">fieldPath</span>: metadata.name
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">volumeMounts</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">name</span>: tmpdata
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">mountPath</span>: /tmpData
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">name</span>: config
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">mountPath</span>: /config
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">volumes</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: config
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">configMap</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">name</span>: vmagent-config
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">volumeClaimTemplates</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">name</span>: tmpdata
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">accessModes</span>:
</span></span><span style="display:flex;"><span>          - ReadWriteOnce
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">storageClassName</span>: cfsauto
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">resources</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">requests</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">storage</span>: 1Gi
</span></span></code></pre></div><p>我们这里就使用 StatefulSet 的形式来管理 vmagent，直接应用上面的资源即可：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#6272a4"># 先将前面示例中的 prometheus 停掉</span>
</span></span><span style="display:flex;"><span>☸ ➜ kubectl scale deploy prometheus --replicas<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span> -n kube-vm
</span></span><span style="display:flex;"><span>☸ ➜ kubectl apply -f vmagent-rbac.yaml
</span></span><span style="display:flex;"><span>☸ ➜ kubectl apply -f vmagent-config.yaml
</span></span><span style="display:flex;"><span>☸ ➜ kubectl apply -f vmagent-sts.yaml
</span></span><span style="display:flex;"><span>☸ ➜ kubectl get pods -n kube-vm -l <span style="color:#8be9fd;font-style:italic">app</span><span style="color:#ff79c6">=</span>vmagent
</span></span><span style="display:flex;"><span>NAME        READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>vmagent-0   1/1     Running   <span style="color:#bd93f9">0</span>          3m43s
</span></span><span style="display:flex;"><span>vmagent-1   1/1     Running   <span style="color:#bd93f9">0</span>          2m9s
</span></span></code></pre></div><p>这里我们部署了两个 vmagent 实例来抓取监控指标，我们这里一共 3 个节点。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>☸ ➜ kubectl get nodes
</span></span><span style="display:flex;"><span>NAME      STATUS   ROLES           AGE    VERSION
</span></span><span style="display:flex;"><span>master1   Ready    control-plane   132d   v1.26.2
</span></span><span style="display:flex;"><span>node1     Ready    &lt;none&gt;          113d   v1.26.3
</span></span><span style="display:flex;"><span>node2     Ready    &lt;none&gt;          132d   v1.26.2
</span></span></code></pre></div><p>所以两个 vmagent 实例会分别采集部分指标，我们可以通过查看日志来进行验证：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>☸ ➜ kubectl logs -f vmagent-0 -n kube-vm
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># ......</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T07:16:49.992Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/lib/promscrape/discovery/kubernetes/api_watcher.go:641&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;reloaded 3 objects from \&#34;https://10.96.0.1:443/api/v1/nodes\&#34; in 0.007s; updated=0, removed=0, added=3, resourceVersion=\&#34;31199642\&#34;&#34;</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T07:16:49.992Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/lib/promscrape/config.go:128&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;started service discovery routines in 0.007 seconds&#34;</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T07:16:49.993Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/lib/promscrape/scraper.go:431&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;kubernetes_sd_configs: added targets: 1, removed targets: 0; total targets: 1&#34;</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>☸ ➜ kubectl logs -f vmagent-1 -n kube-vm
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># ......</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T07:17:51.516Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/lib/promscrape/config.go:128&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;started service discovery routines in 0.007 seconds&#34;</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T07:17:51.517Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/lib/promscrape/scraper.go:431&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;kubernetes_sd_configs: added targets: 2, removed targets: 0; total targets: 2&#34;</span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>从日志可以看出 <code>vmagent-0</code> 实例发现了 1 个 targets，<code>vmagent-1</code> 实例发现了 2 个 targets，这也符合我们预期的。</p>
<p>接下来我们再新增其他内容的监控，比如 APIServer、容器等等，配置如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vmagent-config2.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: ConfigMap
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vmagent-config
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">scrape.yml</span>: |<span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    global:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      scrape_interval: 15s
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      scrape_timeout: 15s
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    scrape_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    - job_name: nodes
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      kubernetes_sd_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - role: node
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      relabel_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - source_labels: [__address__]
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        regex: &#34;(.*):10250&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        replacement: &#34;${1}:9100&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        target_label: __address__
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        action: replace
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - action: labelmap
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        regex: __meta_kubernetes_node_label_(.+)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    - job_name: apiserver
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      scheme: https
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      tls_config:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        insecure_skip_verify: true
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      kubernetes_sd_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - role: endpoints
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      relabel_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - action: keep
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        regex: default;kubernetes;https
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        source_labels:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - __meta_kubernetes_namespace
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - __meta_kubernetes_service_name
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - __meta_kubernetes_endpoint_port_name
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    - job_name: cadvisor
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      scheme: https
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      tls_config:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        insecure_skip_verify: true
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      kubernetes_sd_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - role: node
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      relabel_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - action: labelmap
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        regex: __meta_kubernetes_node_label_(.+)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - replacement: /metrics/cadvisor
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        target_label: __metrics_path__
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    - job_name: endpoints
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      kubernetes_sd_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - role: endpoints
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      relabel_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - action: drop
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        regex: true
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        source_labels:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - __meta_kubernetes_pod_container_init
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - action: keep_if_equal
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        source_labels:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - __meta_kubernetes_service_annotation_prometheus_io_port
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - __meta_kubernetes_pod_container_port_number
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - action: keep
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        regex: true
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        source_labels:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - __meta_kubernetes_service_annotation_prometheus_io_scrape
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - action: replace
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        regex: (https?)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        source_labels:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - __meta_kubernetes_service_annotation_prometheus_io_scheme
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        target_label: __scheme__
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - action: replace
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        regex: (.+)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        source_labels:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - __meta_kubernetes_service_annotation_prometheus_io_path
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        target_label: __metrics_path__
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - action: replace
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        regex: ([^:]+)(?::\d+)?;(\d+)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        replacement: $1:$2
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        source_labels:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - __address__
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - __meta_kubernetes_service_annotation_prometheus_io_port
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        target_label: __address__
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - action: labelmap
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        regex: __meta_kubernetes_service_label_(.+)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - source_labels:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - __meta_kubernetes_pod_name
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        target_label: pod
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - source_labels:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - __meta_kubernetes_namespace
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        target_label: namespace
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - source_labels:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - __meta_kubernetes_service_name
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        target_label: service
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - replacement: ${1}
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        source_labels:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - __meta_kubernetes_service_name
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        target_label: job
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - action: replace
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        source_labels:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - __meta_kubernetes_pod_node_name
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        target_label: node</span>    
</span></span></code></pre></div><p>大部分的配置在前面 Prometheus 章节都介绍过了，核心就是通过 <code>relabel_configs</code> 来控制抓取的任务，vmagent 是兼容传统的 prometheus 重新标记规则的，但也有一些独特的 action，比如上面配置中我们使用了一个 <code>keep_if_equal</code> 的操作，该操作的意思是<strong>如果指定的标签值相等则将该条数据保留下来</strong>。</p>
<p>有时，如果某个指标包含两个具有相同值的标签，则需要删除它。这可以通过 vmagent 支持的 <code>drop_if_equal</code> 操作来完成。例如，如果以下 relabel 规则包含 <code>real_port</code> 和 <code>required_port</code> 的相同标签值，则它会删除指标：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#ff79c6">action</span>: drop_if_equal
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">source_labels</span>: [real_port, needed_port]
</span></span></code></pre></div><p>该规则将删除以下指标：<code>foo{real_port=&quot;123&quot;,needed_port=&quot;123&quot;}</code>，但会保留以下指标：<code>foo{real_port=&quot;123&quot;,needed_port=&quot;456&quot;}</code>。</p>
<p>有时可能需要只对指标子集应用 relabel，在这种情况下，可以将 <code>if</code> 选项添加到 <code>relabel_configs</code> 规则中，例如以下规则仅将 <code>{foo=&quot;bar&quot;}</code> 标签添加到与 <code>metric{label=~&quot;x|y&quot;}</code> 序列选择器匹配的指标：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#ff79c6">if</span>: <span style="color:#f1fa8c">&#39;metric{label=~&#34;x|y&#34;}&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">target_label</span>: <span style="color:#f1fa8c">&#34;foo&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">replacement</span>: <span style="color:#f1fa8c">&#34;bar&#34;</span>
</span></span></code></pre></div><p><code>if</code> 选项可以简化传统的 <code>relabel_configs</code> 规则，例如，以下规则可以删除与 <code>foo{bar=&quot;baz&quot;}</code> 序列选择器匹配的指标：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#ff79c6">if</span>: <span style="color:#f1fa8c">&#39;foo{bar=&#34;baz&#34;}&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">action</span>: drop
</span></span></code></pre></div><p>这相当于以下传统的规则：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#ff79c6">action</span>: drop
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">source_labels</span>: [__name__, bar]
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">regex</span>: <span style="color:#f1fa8c">&#34;foo;baz&#34;</span>
</span></span></code></pre></div><p>不过需要注意的是 Prometheus 还不支持 <code>if</code> 选项，现在只支持 VictoriaMetrics。</p>
<p>现在更新 vmagent 的配置。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>☸ ➜ kubectl apply -f vmagent-config2.yaml
</span></span></code></pre></div><p>配置刷新有两种方式：</p>
<ul>
<li>发送 SUGHUP 信号给 vmagent 进程</li>
<li>向 <code>http://vmagent:8429/-/reload</code> 发送一个 http 请求</li>
</ul>
<p>刷新后就可以开始采集上面的指标了，同样我们也可以通过 <code>http://vmselect/select/0/vmui/</code> 来访问 vmui，比如现在我们来查询 pod 的内存使用率，可以使用如下的查询语句：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-promql" data-lang="promql"><span style="display:flex;"><span><span style="color:#ff79c6">sum</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">container_memory_working_set_bytes</span>{<span style="color:#8be9fd;font-style:italic">image</span><span style="color:#ff79c6">!=</span>&#34;&#34;}<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">by</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">namespace</span>, <span style="color:#8be9fd;font-style:italic">pod</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">/</span> <span style="color:#ff79c6">sum</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">container_spec_memory_limit_bytes</span>{<span style="color:#8be9fd;font-style:italic">image</span><span style="color:#ff79c6">!=</span>&#34;&#34;}<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">by</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">namespace</span>, <span style="color:#8be9fd;font-style:italic">pod</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">100</span> <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">+</span><span style="color:#8be9fd;font-style:italic">inf</span>
</span></span></code></pre></div><p><img src="https://picdn.youdianzhishi.com/images/1689837957284.jpg" alt="vmui"></p>
<p>vmagent 作为采集指标重要的一环，当然对它的监控也不可少。vmagent 通过 <code>http://vmagent:8429/metrics</code> 暴露了很多指标，如 <code>vmagent_remotewrite_conns</code> 远程存储连接，<code>vm_allowed_memory_bytes</code> 可使用的内存大小，我们把一些重要的指标收集起来，通过 Grafana 进行展示，能够更好的帮助我们分析 vmagent 的状态。</p>
<p>我们可以使用 <a href="https://grafana.com/grafana/dashboards/12683">https://grafana.com/grafana/dashboards/12683</a> 来展示 vmagent 的状态。</p>
<p><img src="https://picdn.youdianzhishi.com/images/1689838110423.jpg" alt="vmagent grafana"></p>
<p>此外如果想要查看 vmagent 的抓取的 targets，也通过通过 vmagent 提供的简单页面查看，不过只能查看到指定 vmagent 的，不能直接查看所有的 targets，比如我们想查看 vmagent-1 这个实例的数据，可以单独为该实例创建一个 Service：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Service
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vmagent-1
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: vmagent
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">statefulset.kubernetes.io/pod-name</span>: vmagent-1
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">type</span>: NodePort
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: http
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">8429</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">targetPort</span>: http
</span></span></code></pre></div><p>然后通过 NodePort 就可以访问该实例的数据了：</p>
<p><img src="https://picdn.youdianzhishi.com/images/1689838355437.jpg" alt="vmagent targets"></p>
<h2 id="vmalert">vmalert</h2>
<p>前面我们已经介绍了可以使用 vmagent 代替 prometheus 抓取监控指标数据，要想完全替换 prometheus 还有一个非常重要的部分就是报警模块，之前我们都是在 prometheus 中定义报警规则评估后发送给 alertmanager 的，同样对应到 vm 中也有一个专门来处理报警的模块：<code>vmalert</code>。</p>
<p>vmalert 会针对 <code>-datasource.url</code> 地址执行配置的报警或记录规则，然后可以将报警发送给 <code>-notifier.url</code> 配置的 Alertmanager，记录规则结果会通过远程写入的协议进行保存，所以需要配置 <code>-remoteWrite.url</code>。</p>
<h3 id="特性">特性</h3>
<ul>
<li>与 VictoriaMetrics TSDB 集成</li>
<li>VictoriaMetrics MetricsQL 支持和表达式验证</li>
<li>Prometheus 告警规则定义格式支持</li>
<li>与 Alertmanager 集成</li>
<li>在重启时可以保持报警状态</li>
<li>Graphite 数据源可用于警报和记录规则</li>
<li>支持记录和报警规则重放</li>
<li>非常轻量级，没有额外的依赖</li>
</ul>
<p>要开始使用 vmalert，需要满足以下条件：</p>
<ul>
<li>报警规则列表：要执行的 PromQL/MetricsQL 表达式</li>
<li>数据源地址：可访问的 VictoriaMetrics 实例，用于规则执行</li>
<li>通知程序地址：可访问的 Alertmanager 实例，用于处理，汇总警报和发送通知</li>
</ul>
<h3 id="安装">安装</h3>
<p>首先需要安装一个 Alertmanager 用来接收报警信息，前面章节中我们已经详细讲解过了，这里不再赘述了，对应的资源清单如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># alertmanager.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: ConfigMap
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: alert-config
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">config.yml</span>: |-<span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    global:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      resolve_timeout: 5m
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      smtp_smarthost: &#39;smtp.qq.com:465&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      smtp_from: &#39;xxx@qq.com&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      smtp_auth_username: &#39;xxx@qq.com&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      smtp_auth_password: &#39;&lt;auth code&gt;&#39;  # 使用QQ邮箱的授权码
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      smtp_hello: &#39;qq.com&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      smtp_require_tls: false
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    route:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      group_by: [&#39;severity&#39;, &#39;source&#39;]
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      group_wait: 30s
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      group_interval: 5m
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      repeat_interval: 24h
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      receiver: email
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    receivers:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    - name: &#39;email&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      email_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - to: &#39;ych_1024@163.com&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        send_resolved: true</span>    
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Service
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: alertmanager
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: alertmanager
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: alertmanager
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">type</span>: NodePort
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: web
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">9093</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">targetPort</span>: http
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: apps/v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Deployment
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: alertmanager
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: alertmanager
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">app</span>: alertmanager
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">app</span>: alertmanager
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">volumes</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: alertcfg
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">configMap</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">name</span>: alert-config
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: alertmanager
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">image</span>: prom/alertmanager:v0.25.0
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">imagePullPolicy</span>: IfNotPresent
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">args</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f1fa8c">&#34;--config.file=/etc/alertmanager/config.yml&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">containerPort</span>: <span style="color:#bd93f9">9093</span>
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: http
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">volumeMounts</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">mountPath</span>: <span style="color:#f1fa8c">&#34;/etc/alertmanager&#34;</span>
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: alertcfg
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">resources</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">requests</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">cpu</span>: 100m
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">memory</span>: 256Mi
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">limits</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">cpu</span>: 100m
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">memory</span>: 256Mi
</span></span></code></pre></div><p>Alertmanager 这里我们只配置了一个默认的路由规则，根据 <code>severity</code>、<code>source</code> 两个标签进行分组，然后将触发的报警发送到 email 接收器中去。</p>
<p>接下来需要添加用于报警的规则配置，配置方式和 Prometheus 一样的：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vmalert-config.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: ConfigMap
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vmalert-config
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">record.yaml</span>: |<span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    groups:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    - name: record
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      rules:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - record: job:node_memory_MemFree_bytes:percent  # 记录规则名称
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        expr: 100 - (100 * node_memory_MemFree_bytes / node_memory_MemTotal_bytes)</span>    
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">pod.yaml</span>: |<span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    groups:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    - name: pod
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      rules:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - alert: PodMemoryUsage
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        expr: sum(container_memory_working_set_bytes{pod!=&#34;&#34;}) BY (instance, pod)  / sum(container_spec_memory_limit_bytes{pod!=&#34;&#34;} &gt; 0) BY (instance, pod) * 100 &gt; 60
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        for: 1m
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        labels:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">          severity: warning
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">          source: pod
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        annotations:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">          summary: &#34;Pod {{ $labels.pod }} High Memory usage detected&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">          description: &#34;{{$labels.instance}}: Pod {{ $labels.pod }} Memory usage is above 60% (current value is: {{ $value }})&#34;</span>    
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">node.yaml</span>: |<span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    groups:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    - name: node
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      rules:  # 具体的报警规则
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - alert: NodeMemoryUsage  # 报警规则的名称
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        expr: (node_memory_MemTotal_bytes - (node_memory_MemFree_bytes + node_memory_Buffers_bytes + node_memory_Cached_bytes)) / node_memory_MemTotal_bytes * 100 &gt; 30
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        for: 1m
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        labels:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">          source: node
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">          severity: critical
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        annotations:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">          summary: &#34;Node {{$labels.instance}} High Memory usage detected&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">          description: &#34;{{$labels.instance}}: Memory usage is above 30% (current value is: {{ $value }})&#34;</span>    
</span></span></code></pre></div><p>这里我们添加了一条记录规则，两条报警规则，更多报警规则配置可参考 <a href="https://awesome-prometheus-alerts.grep.to/">https://awesome-prometheus-alerts.grep.to/</a>。</p>
<p>然后就可以部署 vmalert 组件服务了：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vmalert.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Service
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vmalert
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: vmalert
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: vmalert
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">8080</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">targetPort</span>: <span style="color:#bd93f9">8080</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">type</span>: NodePort
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: vmalert
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: apps/v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Deployment
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vmalert
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: vmalert
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">app</span>: vmalert
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">app</span>: vmalert
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: vmalert
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">image</span>: victoriametrics/vmalert:v1.91.3
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">imagePullPolicy</span>: IfNotPresent
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">args</span>:
</span></span><span style="display:flex;"><span>            - -rule=/etc/ruler/*.yaml
</span></span><span style="display:flex;"><span>            - -datasource.url=http://vmselect.kube-vm.svc.cluster.local:8481/select/0/prometheus
</span></span><span style="display:flex;"><span>            - -notifier.url=http://alertmanager.kube-vm.svc.cluster.local:9093
</span></span><span style="display:flex;"><span>            - -remoteWrite.url=http://vminsert.kube-vm.svc.cluster.local:8480/insert/0/prometheus
</span></span><span style="display:flex;"><span>            - -evaluationInterval=15s
</span></span><span style="display:flex;"><span>            - -httpListenAddr=0.0.0.0:8080
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">containerPort</span>: <span style="color:#bd93f9">8080</span>
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: http
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">volumeMounts</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">mountPath</span>: /etc/ruler/
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: ruler
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">readOnly</span>: <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">volumes</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">configMap</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">name</span>: vmalert-config
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">name</span>: ruler
</span></span></code></pre></div><p>上面的资源清单中将报警规则以 volumes 的形式挂载到了容器中，通过 <code>-rule</code> 指定了规则文件路径，<code>-datasource.url</code> 指定了 vmselect 的路径，<code>-notifier.url</code> 指定了 Alertmanager 的地址，其中 <code>-evaluationInterval</code> 参数用来指定评估的频率的，由于我们这里添加了记录规则，所以还需要通过 <code>-remoteWrite.url</code> 指定一个远程写入的地址。</p>
<p>直接创建上面的资源清单即可完成部署。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>☸ ➜ kubectl apply -f alertmanager.yaml
</span></span><span style="display:flex;"><span>☸ ➜ kubectl apply -f vmalert-config.yaml
</span></span><span style="display:flex;"><span>☸ ➜ kubectl apply -f vmalert.yaml
</span></span><span style="display:flex;"><span>☸ ➜ kubectl get pods -n kube-vm -l <span style="color:#8be9fd;font-style:italic">app</span><span style="color:#ff79c6">=</span>alertmanager
</span></span><span style="display:flex;"><span>NAME                           READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>alertmanager-d88d95b4f-z2j8g   1/1     Running   <span style="color:#bd93f9">0</span>          30m
</span></span><span style="display:flex;"><span>☸ ➜ kubectl get svc -n kube-vm -l <span style="color:#8be9fd;font-style:italic">app</span><span style="color:#ff79c6">=</span>alertmanager
</span></span><span style="display:flex;"><span>NAME           TYPE       CLUSTER-IP       EXTERNAL-IP   PORT<span style="color:#ff79c6">(</span>S<span style="color:#ff79c6">)</span>          AGE
</span></span><span style="display:flex;"><span>alertmanager   NodePort   10.102.116.226   &lt;none&gt;        9093:32363/TCP   2m19s
</span></span><span style="display:flex;"><span>☸ ➜ kubectl get pods -n kube-vm -l <span style="color:#8be9fd;font-style:italic">app</span><span style="color:#ff79c6">=</span>vmalert
</span></span><span style="display:flex;"><span>NAME                       READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>vmalert-5dd4864b95-r6dwx   1/1     Running   <span style="color:#bd93f9">0</span>          46s
</span></span><span style="display:flex;"><span>☸ ➜ kubectl get svc -n kube-vm -l <span style="color:#8be9fd;font-style:italic">app</span><span style="color:#ff79c6">=</span>vmalert
</span></span><span style="display:flex;"><span>NAME      TYPE       CLUSTER-IP       EXTERNAL-IP   PORT<span style="color:#ff79c6">(</span>S<span style="color:#ff79c6">)</span>          AGE
</span></span><span style="display:flex;"><span>vmalert   NodePort   10.104.105.125   &lt;none&gt;        8080:31928/TCP   57s
</span></span></code></pre></div><p>部署成功后，如果有报警规则达到了阈值就会触发报警，我们可以通过 Alertmanager 页面查看触发的报警规则：</p>
<p><img src="https://picdn.youdianzhishi.com/images/1690011456503.png" alt="alertmanager"></p>
<p>同样 vmalert 也提供了一个简单的页面，可以查看所有的 Groups：</p>
<p><img src="https://picdn.youdianzhishi.com/images/1690011571591.jpg" alt="groups"></p>
<p>也可以查看到报警规则列表的状态：</p>
<p><img src="https://picdn.youdianzhishi.com/images/1690011657551.jpg" alt="alerts"></p>
<p>还可以查看到具体的一条报警规则的详细信息，如下所示：</p>
<p><img src="https://picdn.youdianzhishi.com/images/1690011724527.jpg" alt="alert detail"></p>
<p>报警规则触发后怎么发送，发送到哪个接收器就是 Alertmanager 决定的了。</p>
<p>同样的上面我们添加的记录规则会通过 remote write 传递给 vminsert 保留下来，所以我们也可以通过 vmselect 查询到。</p>
<p><img src="https://picdn.youdianzhishi.com/images/1690011834717.jpg" alt="记录规则"></p>
<p>到这里基本上我们就完成了使用 vm 代替 prometheus 来进行监控报警了，vmagent 采集监控指标，vmalert 用于报警监控，vmstorage 存储指标数据，vminsert 接收指标数据，vmselect 查询指标数据，已经完全可以不使用 prometheus 了，而且性能非常高，所需资源也比 prometheus 低很多。</p>
<h2 id="victoriametrics-operator">VictoriaMetrics Operator</h2>
<p>Operator 我们知道是 Kubernetes 的一大杀器，可以大大简化应用的安装、配置和管理，同样对于 VictoriaMetrics 官方也开发了一个对应的 Operator 来进行管理 - <code>VictoriaMetrics Operator</code>，它的设计和实现灵感来自 Prometheus Operator，它是管理应用程序监控配置的绝佳工具。</p>
<p>VictoriaMetrics Operator 定义了如下一些 CRD：</p>
<ul>
<li><code>VMServiceScrape</code>：定义从 Service 支持的 Pod 中抓取指标配置</li>
<li><code>VMPodScrape</code>：定义从 Pod 中抓取指标配置</li>
<li><code>VMRule</code>：定义报警和记录规则</li>
<li><code>VMProbe</code>：使用 blackbox exporter 为目标定义探测配置</li>
</ul>
<p>此外该 Operator 默认还可以识别 Prometheus Operator 中的 <code>ServiceMonitor</code>、<code>PodMonitor</code>、<code>PrometheusRule</code> 和 <code>Probe</code> 对象，还允许你使用 CRD 对象来管理 Kubernetes 集群内的 VM 应用。</p>
<h3 id="安装-1">安装</h3>
<p>VictoriaMetrics Operator 提供了 Helm Charts 包，所以可以使用 Helm 来进行一键安装：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>☸ ➜ helm repo add vm https://victoriametrics.github.io/helm-charts/
</span></span><span style="display:flex;"><span>☸ ➜ helm repo update
</span></span></code></pre></div><p>根据自己的需要定制 values 值，默认的 <code>values.yaml</code> 可以通过下面的命令获得：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>☸ ➜ helm show values vm/victoria-metrics-operator &gt; values.yaml
</span></span></code></pre></div><p>我们这里只对下面的内容做了修改：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># values.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">operator</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># -- 默认情况下，vm operator会转换prometheus operator对象</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">disable_prometheus_converter</span>: <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># -- 默认情况下，vm operator会为它的对象创建psp</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">psp_auto_creation_enabled</span>: <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># -- 启用转换后的 prometheus-operator 对象的所有权引用，如果删除 prometheus 对象，它将删除相应的 victoria-metrics 对象。</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">enable_converter_ownership</span>: <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># -- 启用自定义配置 reloader，与 operator 捆绑在一起</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">useCustomConfigReloader</span>: <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># -- 是否开启资源校验的准入控制器(生产环境建议开启)</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">admissionWebhooks</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">enabled</span>: <span style="color:#ff79c6">false</span>
</span></span></code></pre></div><p>然后使用下面的命令即可一键安装 vm-operator：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>☸ ➜ helm upgrade --install victoria-metrics-operator vm/victoria-metrics-operator -f values.yaml -n vmoperator --create-namespace
</span></span><span style="display:flex;"><span>Release <span style="color:#f1fa8c">&#34;victoria-metrics-operator&#34;</span> does not exist. Installing it now.
</span></span><span style="display:flex;"><span>NAME: victoria-metrics-operator
</span></span><span style="display:flex;"><span>LAST DEPLOYED: Sat Jul <span style="color:#bd93f9">22</span> 15:51:39 <span style="color:#bd93f9">2023</span>
</span></span><span style="display:flex;"><span>NAMESPACE: vmoperator
</span></span><span style="display:flex;"><span>STATUS: deployed
</span></span><span style="display:flex;"><span>REVISION: <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>TEST SUITE: None
</span></span><span style="display:flex;"><span>NOTES:
</span></span><span style="display:flex;"><span>victoria-metrics-operator has been installed. Check its status by running:
</span></span><span style="display:flex;"><span>  kubectl --namespace vmoperator get pods -l <span style="color:#f1fa8c">&#34;app.kubernetes.io/instance=victoria-metrics-operator&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Get more information on https://github.com/VictoriaMetrics/helm-charts/tree/master/charts/victoria-metrics-operator.
</span></span><span style="display:flex;"><span>See <span style="color:#f1fa8c">&#34;Getting started guide for VM Operator&#34;</span> on https://docs.victoriametrics.com/guides/getting-started-with-vm-operator.html .
</span></span></code></pre></div><p>安装完成后可以查看 vmoperator 的状态来验证是否安装成功：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>☸ ➜ helm ls -n vmoperator
</span></span><span style="display:flex;"><span>WARNING: Kubernetes configuration file is group-readable. This is insecure. Location: /Users/cnych/.kube/config
</span></span><span style="display:flex;"><span>WARNING: Kubernetes configuration file is world-readable. This is insecure. Location: /Users/cnych/.kube/config
</span></span><span style="display:flex;"><span>NAME                            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                                APP VERSION
</span></span><span style="display:flex;"><span>victoria-metrics-operator       vmoperator      <span style="color:#bd93f9">1</span>               2023-07-22 15:53:45.998328 +0800 CST    deployed        victoria-metrics-operator-0.24.1     0.35.
</span></span><span style="display:flex;"><span>☸ ➜ kubectl -n vmoperator get pods -l <span style="color:#f1fa8c">&#34;app.kubernetes.io/instance=victoria-metrics-operator&#34;</span>
</span></span><span style="display:flex;"><span>NAME                                         READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>victoria-metrics-operator-77f66c87c5-pbf9w   1/1     Running   <span style="color:#bd93f9">0</span>          12m
</span></span></code></pre></div><h3 id="安装-vm-集群">安装 VM 集群</h3>
<p>Operator 安装完成后会包含如下所示的一些 CRD：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>☸ ➜ kubectl get crd |grep victoriametrics
</span></span><span style="display:flex;"><span>vmagents.operator.victoriametrics.com                2023-07-22T07:53:49Z
</span></span><span style="display:flex;"><span>vmalertmanagerconfigs.operator.victoriametrics.com   2023-07-22T07:53:49Z
</span></span><span style="display:flex;"><span>vmalertmanagers.operator.victoriametrics.com         2023-07-22T07:53:49Z
</span></span><span style="display:flex;"><span>vmalerts.operator.victoriametrics.com                2023-07-22T07:53:49Z
</span></span><span style="display:flex;"><span>vmauths.operator.victoriametrics.com                 2023-07-22T07:53:49Z
</span></span><span style="display:flex;"><span>vmclusters.operator.victoriametrics.com              2023-07-22T07:53:49Z
</span></span><span style="display:flex;"><span>vmnodescrapes.operator.victoriametrics.com           2023-07-22T07:53:49Z
</span></span><span style="display:flex;"><span>vmpodscrapes.operator.victoriametrics.com            2023-07-22T07:53:49Z
</span></span><span style="display:flex;"><span>vmprobes.operator.victoriametrics.com                2023-07-22T07:53:49Z
</span></span><span style="display:flex;"><span>vmrules.operator.victoriametrics.com                 2023-07-22T07:53:49Z
</span></span><span style="display:flex;"><span>vmservicescrapes.operator.victoriametrics.com        2023-07-22T07:53:49Z
</span></span><span style="display:flex;"><span>vmsingles.operator.victoriametrics.com               2023-07-22T07:53:49Z
</span></span><span style="display:flex;"><span>vmstaticscrapes.operator.victoriametrics.com         2023-07-22T07:53:49Z
</span></span><span style="display:flex;"><span>vmusers.operator.victoriametrics.com                 2023-07-22T07:53:49Z
</span></span></code></pre></div><p>比如现在我们要来部署 VM，如果只是想要单节点模式则可以直接使用 <code>VMSingle</code> 对象，如果要部署一套 VM 的集群则可以直接使用 <code>VMCluster</code> 来定义一个对象即可，完全不需要我们去手动创建各个组件，Operator 会根据我们的定义去帮我们拉起一套集群起来。</p>
<p>比如这里我们定义一个如下所示的 <code>VMCluster</code> 对象：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vmcluster-demo.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: operator.victoriametrics.com/v1beta1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: VMCluster
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vmcluster-demo
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">replicationFactor</span>: <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">retentionPeriod</span>: <span style="color:#f1fa8c">&#34;1w&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">vmstorage</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">replicaCount</span>: <span style="color:#bd93f9">2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">storage</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">volumeClaimTemplate</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">accessModes</span>:
</span></span><span style="display:flex;"><span>            - ReadWriteOnce
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">resources</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">requests</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">storage</span>: 10G
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">storageClassName</span>: cfsauto
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">storageDataPath</span>: /vm-data
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">vmselect</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">replicaCount</span>: <span style="color:#bd93f9">2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">cacheMountPath</span>: /cache
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">vminsert</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">replicaCount</span>: <span style="color:#bd93f9">2</span>
</span></span></code></pre></div><p>这里我们通过 <code>spec.retentionPeriod</code> 指定了数据保留的时长为 1 周，<code>replicaCount</code> 用来指定各个组件的副本数为 2，通过 <code>storage.volumeClaimTemplate</code> 指定了数据持久化的 PVC 模板，整个对象可配置的属性我们可以通过 <code>kubectl explain</code> 来获取：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>☸ ➜ kubectl explain VMCluster.spec
</span></span><span style="display:flex;"><span>KIND:     VMCluster
</span></span><span style="display:flex;"><span>VERSION:  operator.victoriametrics.com/v1beta1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>RESOURCE: spec &lt;Object&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DESCRIPTION:
</span></span><span style="display:flex;"><span>     VMClusterSpec defines the desired state of VMCluster
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>FIELDS:
</span></span><span style="display:flex;"><span>   clusterVersion       &lt;string&gt;
</span></span><span style="display:flex;"><span>     ClusterVersion defines default images tag <span style="color:#ff79c6">for</span> all components. it can be
</span></span><span style="display:flex;"><span>     overwritten with component specific image.tag value.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   imagePullSecrets     &lt;<span style="color:#ff79c6">[]</span>Object&gt;
</span></span><span style="display:flex;"><span>     ImagePullSecrets An optional list of references to secrets in the same
</span></span><span style="display:flex;"><span>     namespace to use <span style="color:#ff79c6">for</span> pulling images from registries see
</span></span><span style="display:flex;"><span>     http://kubernetes.io/docs/user-guide/images#specifying-imagepullsecrets-on-a-pod
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   podSecurityPolicyName        &lt;string&gt;
</span></span><span style="display:flex;"><span>     PodSecurityPolicyName - defines name <span style="color:#ff79c6">for</span> podSecurityPolicy in <span style="color:#ff79c6">case</span> of empty
</span></span><span style="display:flex;"><span>     value, prefixedName will be used.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   replicationFactor    &lt;integer&gt;
</span></span><span style="display:flex;"><span>     ReplicationFactor defines how many copies of data make among distinct
</span></span><span style="display:flex;"><span>     storage nodes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   retentionPeriod      &lt;string&gt; -required-
</span></span><span style="display:flex;"><span>     RetentionPeriod <span style="color:#ff79c6">for</span> the stored metrics Note VictoriaMetrics has data/ and
</span></span><span style="display:flex;"><span>     indexdb/ folders metrics from data/ removed eventually as soon as partition
</span></span><span style="display:flex;"><span>     leaves retention period reverse index data at indexdb rotates once at the
</span></span><span style="display:flex;"><span>     half of configured retention period
</span></span><span style="display:flex;"><span>     https://docs.victoriametrics.com/Single-server-VictoriaMetrics.html#retention
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   serviceAccountName   &lt;string&gt;
</span></span><span style="display:flex;"><span>     ServiceAccountName is the name of the ServiceAccount to use to run the
</span></span><span style="display:flex;"><span>     VMSelect Pods.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   vminsert     &lt;Object&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   vmselect     &lt;Object&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   vmstorage    &lt;Object&gt;
</span></span></code></pre></div><p>同样要想获取组件可以定义的属性也可以通过该方式来获取，比如查看 <code>vmstorage</code> 对象可以配置的属性：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>☸ ➜ kubectl explain VMCluster.spec.vmstorage
</span></span><span style="display:flex;"><span>KIND:     VMCluster
</span></span><span style="display:flex;"><span>VERSION:  operator.victoriametrics.com/v1beta1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>RESOURCE: vmstorage &lt;Object&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DESCRIPTION:
</span></span><span style="display:flex;"><span>     &lt;empty&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>FIELDS:
</span></span><span style="display:flex;"><span>   affinity     &lt;&gt;
</span></span><span style="display:flex;"><span>     Affinity If specified, the pod<span style="color:#f1fa8c">&#39;s scheduling constraints.
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   configMaps   &lt;[]string&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     ConfigMaps is a list of ConfigMaps in the same namespace as the VMSelect
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     object, which shall be mounted into the VMSelect Pods. The ConfigMaps are
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     mounted into /etc/vm/configs/&lt;configmap-name&gt;.
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   containers   &lt;[]&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     Containers property allows to inject additions sidecars or to patch
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     existing containers. It can be useful for proxies, backup, etc.
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   dnsConfig    &lt;Object&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     Specifies the DNS parameters of a pod. Parameters specified here will be
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     merged to the generated DNS configuration based on DNSPolicy.
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   dnsPolicy    &lt;string&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     DNSPolicy sets DNS policy for the pod
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   extraArgs    &lt;map[string]string&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   extraEnvs    &lt;[]&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     ExtraEnvs that will be added to VMSelect pod
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   hostNetwork  &lt;boolean&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     HostNetwork controls whether the pod may use the node network namespace
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   image        &lt;Object&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     Image - docker image settings for VMStorage
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   initContainers       &lt;[]&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     InitContainers allows adding initContainers to the pod definition. Those
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     can be used to e.g. fetch secrets for injection into the VMSelect
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     configuration from external sources. Any errors during the execution of an
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     initContainer will lead to a restart of the Pod. More info:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     https://kubernetes.io/docs/concepts/workloads/pods/init-containers/ Using
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     initContainers for any use case other then secret fetching is entirely
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     outside the scope of what the maintainers will support and by doing so, you
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     accept that this behaviour may break at any time without notice.
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   livenessProbe        &lt;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     LivenessProbe that will be added CRD pod
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   logFormat    &lt;string&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     LogFormat for VMSelect to be configured with. default or json
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   logLevel     &lt;string&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     LogLevel for VMSelect to be configured with.
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   maintenanceInsertNodeIDs     &lt;[]integer&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     MaintenanceInsertNodeIDs - excludes given node ids from insert requests
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     routing, must contain pod suffixes - for pod-0, id will be 0 and etc. lets
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     say, you have pod-0, pod-1, pod-2, pod-3. to exclude pod-0 and pod-3 from
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     insert routing, define nodeIDs: [0,3]. Useful at storage expanding, when
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     you want to rebalance some data at cluster.
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   maintenanceSelectNodeIDs     &lt;[]integer&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     MaintenanceInsertNodeIDs - excludes given node ids from select requests
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     routing, must contain pod suffixes - for pod-0, id will be 0 and etc.
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   name &lt;string&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     Name is deprecated and will be removed at 0.22.0 release
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   nodeSelector &lt;map[string]string&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     NodeSelector Define which Nodes the Pods are scheduled on.
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   podDisruptionBudget  &lt;Object&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     PodDisruptionBudget created by operator
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   podMetadata  &lt;Object&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     PodMetadata configures Labels and Annotations which are propagated to the
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     VMSelect pods.
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   port &lt;string&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     Port for health check connetions
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   priorityClassName    &lt;string&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     Priority class assigned to the Pods
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   readinessProbe       &lt;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     ReadinessProbe that will be added CRD pod
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   replicaCount &lt;integer&gt; -required-
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     ReplicaCount is the expected size of the VMStorage cluster. The controller
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     will eventually make the size of the running cluster equal to the expected
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     size.
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   resources    &lt;Object&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     Resources container resource request and limits,
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   rollingUpdateStrategy        &lt;string&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     RollingUpdateStrategy defines strategy for application updates Default is
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     OnDelete, in this case operator handles update process Can be changed for
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     RollingUpdate
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   runtimeClassName     &lt;string&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     RuntimeClassName - defines runtime class for kubernetes pod.
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     https://kubernetes.io/docs/concepts/containers/runtime-class/
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   schedulerName        &lt;string&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     SchedulerName - defines kubernetes scheduler name
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   secrets      &lt;[]string&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     Secrets is a list of Secrets in the same namespace as the VMSelect object,
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     which shall be mounted into the VMSelect Pods. The Secrets are mounted into
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     /etc/vm/secrets/&lt;secret-name&gt;.
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   securityContext      &lt;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     SecurityContext holds pod-level security attributes and common container
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     settings. This defaults to the default PodSecurityContext.
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   serviceScrapeSpec    &lt;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     ServiceScrapeSpec that will be added to vmselect VMServiceScrape spec
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   serviceSpec  &lt;Object&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     ServiceSpec that will be create additional service for vmstorage
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   startupProbe &lt;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     StartupProbe that will be added to CRD pod
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   storage      &lt;Object&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     Storage - add persistent volume for StorageDataPath its useful for
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     persistent cache
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   storageDataPath      &lt;string&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     StorageDataPath - path to storage data
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   terminationGracePeriodSeconds        &lt;integer&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     TerminationGracePeriodSeconds period for container graceful termination
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   tolerations  &lt;[]Object&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     Tolerations If specified, the pod&#39;</span>s tolerations.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   topologySpreadConstraints    &lt;<span style="color:#ff79c6">[]</span>&gt;
</span></span><span style="display:flex;"><span>     TopologySpreadConstraints embedded kubernetes pod configuration option,
</span></span><span style="display:flex;"><span>     controls how pods are spread across your cluster among failure-domains such
</span></span><span style="display:flex;"><span>     as regions, zones, nodes, and other user-defined topology domains
</span></span><span style="display:flex;"><span>     https://kubernetes.io/docs/concepts/workloads/pods/pod-topology-spread-constraints/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   vmBackup     &lt;Object&gt;
</span></span><span style="display:flex;"><span>     VMBackup configuration <span style="color:#ff79c6">for</span> backup
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   vmInsertPort &lt;string&gt;
</span></span><span style="display:flex;"><span>     VMInsertPort <span style="color:#ff79c6">for</span> VMInsert connections
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   vmSelectPort &lt;string&gt;
</span></span><span style="display:flex;"><span>     VMSelectPort <span style="color:#ff79c6">for</span> VMSelect connections
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   volumeMounts &lt;<span style="color:#ff79c6">[]</span>Object&gt;
</span></span><span style="display:flex;"><span>     VolumeMounts allows configuration of additional VolumeMounts on the output
</span></span><span style="display:flex;"><span>     Deployment definition. VolumeMounts specified will be appended to other
</span></span><span style="display:flex;"><span>     VolumeMounts in the VMSelect container, that are generated as a result of
</span></span><span style="display:flex;"><span>     StorageSpec objects.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   volumes      &lt;<span style="color:#ff79c6">[]</span>&gt;
</span></span><span style="display:flex;"><span>     Volumes allows configuration of additional volumes on the output Deployment
</span></span><span style="display:flex;"><span>     definition. Volumes specified will be appended to other volumes that are
</span></span><span style="display:flex;"><span>     generated as a result of StorageSpec objects.
</span></span></code></pre></div><p>直接应用上面定义的对象：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>☸ ➜ kubectl apply -f vmcluster-demo.yaml
</span></span><span style="display:flex;"><span>☸ ➜ kubectl get vmcluster
</span></span><span style="display:flex;"><span>NAME             INSERT COUNT   STORAGE COUNT   SELECT COUNT   AGE   STATUS
</span></span><span style="display:flex;"><span>vmcluster-demo   <span style="color:#bd93f9">2</span>              <span style="color:#bd93f9">2</span>               <span style="color:#bd93f9">2</span>              39s   operational
</span></span></code></pre></div><p>应用后 vm operator 会 watch 到我们创建了该 CRD 对象，然后会根据我们的定义去自动创建对应的 VM 集群，也就是前面提到的几个组件服务：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>☸ ➜ kubectl get pods
</span></span><span style="display:flex;"><span>NAME                                      READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>vminsert-vmcluster-demo-5cf8d8b88-bzrzr   1/1     Running   <span style="color:#bd93f9">0</span>          64s
</span></span><span style="display:flex;"><span>vminsert-vmcluster-demo-5cf8d8b88-kh66n   1/1     Running   <span style="color:#bd93f9">0</span>          64s
</span></span><span style="display:flex;"><span>vmselect-vmcluster-demo-0                 1/1     Running   <span style="color:#bd93f9">0</span>          64s
</span></span><span style="display:flex;"><span>vmselect-vmcluster-demo-1                 1/1     Running   <span style="color:#bd93f9">0</span>          64s
</span></span><span style="display:flex;"><span>vmstorage-vmcluster-demo-0                1/1     Running   <span style="color:#bd93f9">0</span>          64s
</span></span><span style="display:flex;"><span>vmstorage-vmcluster-demo-1                1/1     Running   <span style="color:#bd93f9">0</span>          64s
</span></span><span style="display:flex;"><span>☸ ➜ kubectl get svc
</span></span><span style="display:flex;"><span>NAME                       TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span style="color:#ff79c6">(</span>S<span style="color:#ff79c6">)</span>                      AGE
</span></span><span style="display:flex;"><span>vminsert-vmcluster-demo    ClusterIP   10.97.113.135   &lt;none&gt;        8480/TCP                     81s
</span></span><span style="display:flex;"><span>vmselect-vmcluster-demo    ClusterIP   None            &lt;none&gt;        8481/TCP                     81s
</span></span><span style="display:flex;"><span>vmstorage-vmcluster-demo   ClusterIP   None            &lt;none&gt;        8482/TCP,8400/TCP,8401/TCP   <span style="color:#bd93f9">81</span>
</span></span></code></pre></div><p>我们只通过定义简单的 <code>VMCluster</code> 对象就可以来管理 VM 集群了，是不是非常方便，特别是当你组件副本数量非常多的时候不需要我们去手动配置 <code>-storageNode</code> 参数了。</p>
<p>现在 VM 集群安装成功了，但是现在还没有任何数据，所以还需要去配置监控指标的抓取，这里我们可以直接去创建一个 <code>VMAgent</code> 对象即可，创建一个如下所示的对象：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vmagent-demo.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: operator.victoriametrics.com/v1beta1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: VMAgent
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vmagent-demo
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">serviceScrapeNamespaceSelector</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">podScrapeNamespaceSelector</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">podScrapeSelector</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">serviceScrapeSelector</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">nodeScrapeSelector</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">nodeScrapeNamespaceSelector</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">staticScrapeSelector</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">staticScrapeNamespaceSelector</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">replicaCount</span>: <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">remoteWrite</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">url</span>: <span style="color:#f1fa8c">&#34;http://vminsert-vmcluster-demo.default.svc.cluster.local:8480/insert/0/prometheus/api/v1/write&#34;</span>
</span></span></code></pre></div><p>同样要获取 <code>VMAgent</code> 的所以可配置的属性可以通过 <code>kubectl explain VMAgent.spec</code> 来获取，这里最主要的配置就是通过 <code>remoteWrite.url</code> 来指定远程写入的 URL 地址，也就是 <code>vminsert</code> 组件的服务地址，其他几个属性可以用来对要抓取的指标进行过滤。</p>
<p>直接应用上面的 <code>VMAgent</code> 对象即可开始抓取监控数据：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>☸ ➜ kubectl apply -f vmagent-demo.yaml
</span></span><span style="display:flex;"><span>☸ ➜ kubectl get vmagent
</span></span><span style="display:flex;"><span>NAME           SHARDS COUNT   REPLICA COUNT
</span></span><span style="display:flex;"><span>vmagent-demo   <span style="color:#bd93f9">0</span>              <span style="color:#bd93f9">1</span>
</span></span></code></pre></div><p>创建后 vm-operator 会根据对应的描述创建一个对应的 <code>vmagent</code> 实例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>☸ ➜ kubectl get pods -l app.kubernetes.io/name<span style="color:#ff79c6">=</span>vmagent
</span></span><span style="display:flex;"><span>NAME                                   READY   STATUS    RESTARTS     AGE
</span></span><span style="display:flex;"><span>vmagent-vmagent-demo-7d97cc94b-t8b9t   2/2     Running   <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">(</span>3s ago<span style="color:#ff79c6">)</span>   17s
</span></span></code></pre></div><p>可以看到 <code>vmagent</code> 有两个容器，一个是 <code>vmagent</code> 应用容器，另外一个是用于挂载 Secret 对象的 <code>config-reloader</code> 容器，它会 watch 配置的变化，并发送信号为 <code>vmagent</code> 重新加载配置，该 Secret 对象中就是定义的 <code>vmagent</code> 抓取指标的配置内容。</p>
<p>我们可以运行以下命令使 <code>vmagent</code> 的端口可以从本地机器上访问。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>☸ ➜ kubectl port-forward svc/vmagent-vmagent-demo 8429:8429
</span></span><span style="display:flex;"><span>Forwarding from 127.0.0.1:8429 -&gt; <span style="color:#bd93f9">8429</span>
</span></span><span style="display:flex;"><span>Forwarding from <span style="color:#ff79c6">[</span>::1<span style="color:#ff79c6">]</span>:8429 -&gt; <span style="color:#bd93f9">8429</span>
</span></span></code></pre></div><p>我们可以在浏览器中访问 <code>http://127.0.0.1:8429/targets</code> 来检查 <code>vmagent</code> 采集的集群指标：</p>
<p><img src="https://picdn.youdianzhishi.com/images/1690013883755.png" alt="vmagent metrics"></p>
<p><code>vmagent</code> 会通过 Kubernetes 服务发现去获取需要抓取的目标，此服务发现由 vm operator 控制。</p>
<h3 id="验证-vm-集群">验证 VM 集群</h3>
<p>接下来我们使用前面安装的 Grafana 来验证这里的 VM 集群。</p>
<p>首先我们添加一个新的数据源，指定 URL 为 <code>http://vmselect-vmcluster-demo.default.svc.cluster.local:8481/select/0/prometheus/</code>。</p>
<p><img src="https://picdn.youdianzhishi.com/images/1690014716988.png" alt="添加新的数据源"></p>
<p>然后添加几个新的 dashboard，导入 ID 分别为 <code>11176</code>、<code>12683</code>、<code>14205</code>，第一个是 VM 集群的 dashboard，第二个是 vmagent 的，第三个是 K8s 集群的 dashboard。</p>
<p>正常就可以看到如下所示的 dashboard：</p>
<p><img src="https://picdn.youdianzhishi.com/images/1690015075795.jpg" alt="vmcluster dashboard"></p>
<p>这是因为默认情况下 <code>VMAgent</code> 会采集 VM 集群相关组件的指标，包括 <code>vmagent</code> 本身的，所以我们可以正常看到 VM 集群的 Dashboard，但是缺没有采集其他的指标，比如 node-exporter，我们可以在 Grafana 中导入 <code>16098</code> 这个 dashboard：</p>
<p><img src="https://picdn.youdianzhishi.com/images/1690015232194.jpg" alt="node-exporter"></p>
<p>这个时候我们可以通过 <code>VMNodeScrape</code> 这个 CRD 对象来进行定义，<code>VMNodeScrape</code> 对象可以用来自动发现 Kubernetes 节点，创建如下所示的资源对象来采集 node-exporter 指标：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vmnode.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: operator.victoriametrics.com/v1beta1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: VMNodeScrape
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: node-exporter
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">path</span>: /metrics
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">port</span>: <span style="color:#f1fa8c">&#34;9100&#34;</span> <span style="color:#6272a4"># 指定 node-exporter 的端口</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">scrape_interval</span>: 15s
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#   relabelConfigs：  # relabel配置</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#   selector:  # 过滤节点</span>
</span></span></code></pre></div><p>直接应用上面的对象即可：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>☸ ➜ kubectl apply -f vmnode.yaml
</span></span><span style="display:flex;"><span>☸ ➜ kubectl get vmnodescrape
</span></span><span style="display:flex;"><span>NAME            AGE
</span></span><span style="display:flex;"><span>node-exporter   19s
</span></span></code></pre></div><p>创建后 vmagent 就会自动去识别该对象去对 node-exporter 进行抓取了：</p>
<p><img src="https://picdn.youdianzhishi.com/images/1690015495522.png" alt="node-exporter targets"></p>
<p>这个时候再去查看 node-exporter 的 dashboard 就正常了：</p>
<p><img src="https://picdn.youdianzhishi.com/images/1690015769439.jpg" alt="node-exorter dashboard"></p>
<p>此外还可以通过 <code>VMServiceScrape</code> 去定义要抓取的 Service 服务（Endpoints），它基于选择器为 <code>vmagent</code> 生成抓取配置，如果想要抓取没有定义 Service 的 Pod 的指标，则可以通过 <code>VMPodScrape</code> 来进行定义，同样还有报警相关的也都有相应的 CRD 来进行管理。vm operator 大大降低了我们对 VM 集群的管理，非常推荐使用。</p>
<!-- raw HTML omitted -->

          <h2>微信公众号</h2>
<p>
  扫描下面的二维码关注我们的微信公众帐号，在微信公众帐号中回复◉加群◉即可加入到我们的
  kubernetes 讨论群里面共同学习。
</p>
<img
  src="https://picdn.youdianzhishi.com/images/qrcode.png"
  alt="wechat-account-qrcode"
/>

  
          
            <div class="entry-shang text-center">
    <p>「真诚赞赏，手留余香」</p>
    <button class="zs show-zs btn btn-bred">赞赏</button>
</div>
<div class="zs-modal-bg"></div>
<div class="zs-modal-box">
    <div class="zs-modal-head">
        <button type="button" class="close">×</button>
        <span class="author"><img src="https://www.qikqiak.com/img/avatar.jpeg"/>阳明</span>
        <p class="tip"><i></i><span>请我喝杯咖啡？</span></p>
    </div>
    <div class="zs-modal-body">
        <div class="zs-modal-btns">
            <button class="btn btn-blink" data-num="2">2元</button>
            <button class="btn btn-blink" data-num="5">5元</button>
            <button class="btn btn-blink" data-num="10">10元</button>
            <button class="btn btn-blink" data-num="50">50元</button>
            <button class="btn btn-blink" data-num="100">100元</button>
            <button class="btn btn-blink" data-num="1">任意金额</button>
        </div>
        <div class="zs-modal-pay">
            <button class="btn btn-bred" id="pay-text">2元</button>
            <p>使用<span id="pay-type">微信</span>扫描二维码完成支付</p>
            <img src="https://www.qikqiak.com/img/wechat-2.png" id="pay-image"/>
        </div>
    </div>
    <div class="zs-modal-footer">
        <span class="zs-wechat"><img src="https://www.qikqiak.com/img/wechat-btn.png"/></span>
    </div>
</div>
          
          
            <div class="social-share" data-initialized="true" style="margin-bottom: 20px;margin-top:20px;">
    <center>
    <a href="#" class="social-share-icon icon-weibo"></a>
    <a href="#" class="social-share-icon icon-wechat"></a>
    <a href="#" class="social-share-icon icon-twitter"></a>
    <a href="#" class="social-share-icon icon-linkedin"></a>
    <a href="#" class="social-share-icon icon-facebook"></a>
    <a href="#" class="social-share-icon icon-qq"></a>
    <a href="#" class="social-share-icon icon-qzone"></a>
    </center>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>

          
        </article>
  
        
          

<h3>相关文章</h3>
<ul style="margin-bottom: 25px;">
    
    <li><a href="https://www.qikqiak.com/post/prometheus-monitor-k8s-job-trap/">Prometheus 监控 Kubernetes Job 资源误报的坑</a></li>
    
    <li><a href="https://www.qikqiak.com/post/monitor-external-k8s-on-prometheus/">Prometheus 监控外部 Kubernetes 集群</a></li>
    
    <li><a href="https://www.qikqiak.com/post/use-loki-monitor-alert/">使用 Loki 进行日志监控和报警</a></li>
    
    <li><a href="https://www.qikqiak.com/post/k8s-hpa-usage/">Kubernetes HPA 使用详解</a></li>
    
    <li><a href="https://www.qikqiak.com/post/use-crd-create-grafana-dashboard/">用 Kubernetes 资源对象创建 Grafana Dashboard</a></li>
    
    <li><a href="https://www.qikqiak.com/post/alertmanager-when-alert/">AlertManager 何时报警</a></li>
    
    <li><a href="https://www.qikqiak.com/post/recording-rules-on-prometheus/">Prometheus 记录规则的使用</a></li>
    
    <li><a href="https://www.qikqiak.com/post/blackbox-exporter-on-prometheus/">Prometheus 黑盒监控</a></li>
    
    <li><a href="https://www.qikqiak.com/post/build-k8s-app-with-custom-metrics/">对 Kubernetes 应用进行自定义指标扩缩容</a></li>
    
    <li><a href="https://www.qikqiak.com/post/prometheus-book/">《深入浅出Prometheus》</a></li>
    
</ul>

        
  
        
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://www.qikqiak.com/post/how-to-subscribe-chatgpt-plus-try-gpt-4/" data-toggle="tooltip" data-placement="top" title="保姆级教程 | 手把手叫你如何开通 ChatGPT Plus 试用 GPT-4">&larr; 前一篇</a>
            </li>
          
          
        </ul>
        

        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        
        <ins class="adsbygoogle"
            style="display:block"
            data-ad-client="ca-pub-5376999672787220"
            data-ad-slot="3700507799"
            data-ad-format="auto"
            data-full-width-responsive="true"></ins>
        <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
  
        
    <div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>
    var gitalk = new Gitalk({
        clientID: 'bdb76dbb2e9d0786e350',
        clientSecret: 'b454b2a08013fd0e32013be7a63fa8fcb262b6c4',
        repo: 'blog',
        owner: 'cnych',
        admin: ['cnych'],
        labels: ['gitment'],
        title: '一文搞懂 VictoriaMetrics 的使用',
        createIssueManually: true,
        id: 'victoriametrics-usage',      
        distractionFreeMode: true  
    });
    gitalk.render('gitalk-container');
</script>


        
          

        
  
      </div>
    
    
  </div>
</div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          <img src="https://www.qikqiak.com/img/wechatmp.png" alt="k8s技术圈">
          
              <li>
                <a href="mailto:icnych@gmail.com" title="Email me">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
              <li>
                <a href="https://github.com/cnych" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
              <li>
                <a href="https://weibo.com/cnych" title="微博">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
              <li>
                <a href="https://instagram.com/cnych" title="Instagram">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-instagram fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          
          <li>
            <a href="https://www.qikqiak.com/index.xml" title="RSS">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          

          &nbsp;&bull;&nbsp;
          2023

          
            &nbsp;&bull;&nbsp;
            <a href="https://www.qikqiak.com/">阳明的博客</a>
            &nbsp;&bull;&nbsp;
            <a href="https://www.qikqiak.com/sitemap.xml">网站地图</a>
            &nbsp;&bull;&nbsp;
            <a href="https://www.qikqiak.com/page/archive/">归档</a>
            &nbsp;&bull;&nbsp;
            <a href="https://www.qikqiak.com/page/friend/">友链</a>
            &nbsp;&bull;&nbsp;
            <a href="https://beian.miit.gov.cn/" target="_blank">蜀ICP备11027319号-5</a>
            <a class="h" href="https://www.qikqiak.com/page/kubernetes.io">kubernetes.io</a>
            <a class="h" href="https://www.qikqiak.com/page/kubernetes.org.cn">Kubernetes中文社区</a>
          
        </p>
        <p class="text-center text-muted">
          <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
          <span id="busuanzi_container_site_pv" style="display:none">
            本站总访问量<span id="busuanzi_value_site_pv"></span>次
          </span>
          &nbsp;&bull;&nbsp;
          <span id="busuanzi_container_site_uv" style="display:none">
            访客数<span id="busuanzi_value_site_uv"></span>人次
          </span>
        </p>
        
        <p class="credits theme-by text-muted">
          由 <a href="http://gohugo.io">Hugo v0.115.4</a> 强力驱动 &nbsp;&bull;&nbsp; 主题 <a href="https://github.com/cnych/qikqiak.com">qikqiak-blog</a>
          
        </p>
      </div>
    </div>
  </div>
</footer>


<script src='https://www.qikqiak.com/js/bundle.min.af02a2d23b6651a566f0135a12e65fc2560faa7a969b3d1ad58d0afe0c9164ae.js' integrity='sha256-rwKi0jtmUaVm8BNaEuZfwlYPqnqWmz0a1Y0K/gyRZK4='></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-69668147-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-69668147-3');
</script>
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script >
$(document).ready(function() {
  var int = setInterval(fixCount, 50);  
  
  var initPVCount = 584976;
  var initUVCount = 153191;
  function fixCount() {                   
    if ($("#busuanzi_container_site_pv").css("display") != "none") {
        $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + initPVCount); 
        clearInterval(int); 
    }
    if ($("#busuanzi_container_site_uv").css("display") != "none") {
      $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + initUVCount);
      clearInterval(int); 
    }  
  }           
});
</script>
 <script>(function(w,d, s, id) {if(typeof(w.webpushr)!=='undefined') return;w.webpushr=w.webpushr||function(){(w.webpushr.q=w.webpushr.q||[]).push(arguments)};var js, fjs = d.getElementsByTagName(s)[0];js = d.createElement(s); js.id = id;js.src = "https://cdn.webpushr.com/app.min.js";fjs.parentNode.appendChild(js);}(window,document, 'script', 'webpushr-jssdk'));webpushr('init','BJICPtxnbz-7vq9kEwH5psPCuHe2CvludQug4R2tuJGPF0GQT2hwSWTAhlSt2EFD5InpuQyxCGJdigf6-KbQ53c');</script>
<script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery-migrate@1.2.1/dist/jquery-migrate.min.js"></script>
<script type="text/javascript" src="//cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>
<script type="text/javascript">
$('.carousel').slick({
    dots: true,
    arrows: true,
    autoplay: true,
    autoplaySpeed: 4000,
    infinite: true,
    speed: 500,
    fade: true,
    cssEase: 'linear',
    centerMode: true,
    prevArrow: '<button type="button" class="slick-prev"></button>',
    nextArrow: '<button type="button" class="slick-next"></button>',
});
</script>

  </body>
</html>

